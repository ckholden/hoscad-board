<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HOSCAD — INCIDENT QUEUE</title>
<link rel="icon" href="../download.png" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#07090d;--panel:#0b1018;--line:#1a2233;--text:#c8d6e8;--muted:#4a5a6e;
  --green:#4dff91;--yellow:#ffd66b;--red:#ff5555;--blue:#4fa3e0;
  --hi:#ffffff;--ok:#52c41a;--warn:#fa8c16;--danger:#ff4d4f;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Courier New',monospace;font-size:12px;overflow:hidden;}
body{display:flex;flex-direction:column;}
.topbar{display:flex;align-items:center;gap:12px;padding:5px 12px;background:var(--panel);border-bottom:1px solid var(--line);flex-shrink:0;}
.brand{font-size:13px;font-weight:900;color:var(--hi);letter-spacing:.08em;}
.live-pill{font-size:10px;font-weight:700;padding:2px 7px;border-radius:2px;background:rgba(77,255,145,.12);border:1px solid rgba(77,255,145,.3);color:var(--green);}
.live-pill.stale{background:rgba(255,77,77,.12);border-color:rgba(255,77,77,.3);color:var(--red);}
.clock{font-size:11px;color:var(--muted);font-weight:700;margin-left:auto;}
#ppBadge{font-size:10px;font-weight:700;color:var(--blue);opacity:.6;}
#summaryStrip{display:flex;gap:16px;padding:4px 12px;background:rgba(0,0,0,.3);border-bottom:1px solid var(--line);flex-shrink:0;font-size:11px;font-weight:700;letter-spacing:.04em;}
.ss-item{color:var(--muted);}
.ss-item strong{color:var(--hi);margin-left:3px;}
.ss-item.s-q strong{color:var(--yellow);}
.ss-item.s-a strong{color:var(--green);}
#countdownBar{height:2px;background:var(--line);flex-shrink:0;}
#countdownFill{height:100%;background:var(--blue);transition:width .5s linear;}
#queueWrap{flex:1;overflow-y:auto;padding:0;}
.section-hdr{font-size:10px;font-weight:900;letter-spacing:.08em;padding:5px 10px;
  background:rgba(255,255,255,.03);border-bottom:1px solid var(--line);color:var(--muted);}
.section-hdr.queued{color:var(--yellow);}
.section-hdr.active{color:var(--green);}

/* ── Table layout (wide / horizontal) ───────────── */
table.inc-tbl{width:100%;border-collapse:collapse;}
table.inc-tbl th{background:rgba(255,255,255,.04);color:var(--muted);font-size:10px;font-weight:700;letter-spacing:.06em;padding:4px 8px;text-align:left;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:1;}
table.inc-tbl td{padding:5px 8px;border-bottom:1px solid rgba(26,34,51,.6);vertical-align:middle;}
table.inc-tbl tr{cursor:pointer;transition:background .12s;}
table.inc-tbl tr:hover td{background:rgba(91,163,230,.07);}
table.inc-tbl tr.inc-urgent td{border-left:3px solid var(--red);}
table.inc-tbl tr.inc-mutual-aid td{background:rgba(255,160,0,.05);}
.inc-id-cell{font-weight:900;font-size:12px;color:var(--hi);white-space:nowrap;}
.inc-id-cell .pri-badge{font-size:9px;padding:1px 4px;border-radius:2px;margin-left:3px;font-weight:900;}
.priority-PRI-1{background:rgba(255,77,77,.18);color:#ff8f8f;border:1px solid rgba(255,77,77,.3);}
.priority-PRI-2{background:rgba(255,160,0,.18);color:#ffa940;border:1px solid rgba(255,160,0,.3);}
.priority-PRI-3{background:rgba(91,163,230,.18);color:#69c0ff;border:1px solid rgba(91,163,230,.3);}
.priority-PRI-4{background:rgba(100,110,120,.12);color:#8fa1b8;border:1px solid rgba(100,110,120,.3);}
.ma-badge{font-size:9px;padding:1px 4px;background:rgba(255,160,0,.15);border:1px solid rgba(255,160,0,.4);color:#ffa940;border-radius:2px;margin-left:2px;}
.cb-badge{font-size:9px;padding:1px 4px;background:rgba(77,255,145,.1);border:1px solid rgba(77,255,145,.3);color:#73d13d;border-radius:2px;margin-left:2px;}
.pp-rel-badge{display:inline-block;font-size:9px;font-weight:900;padding:0 3px;border:1px solid rgba(64,144,216,.45);border-radius:2px;margin-left:2px;letter-spacing:.04em;vertical-align:middle;line-height:1.4;color:#4090c8;background:rgba(64,144,216,.07);}
.rel-badge{display:inline-block;font-size:9px;font-weight:900;padding:0 3px;border:1px solid rgba(80,190,140,.45);border-radius:2px;margin-left:2px;letter-spacing:.04em;vertical-align:middle;line-height:1.4;color:#50be8c;background:rgba(80,190,140,.07);}
.wait-cell{font-weight:700;font-size:11px;}
.wait-ok{color:var(--muted);}
.wait-warn{color:var(--yellow);}
.wait-over{color:var(--red);animation:blink 1s step-end infinite;}
@keyframes blink{50%{opacity:.3;}}
.note-cell{color:var(--text);font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dest-cell{color:var(--green);font-weight:700;font-size:11px;}
.scene-cell{color:var(--text);font-size:10px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.units-cell{color:var(--blue);font-size:10px;font-weight:700;}
.inc-type-badge{font-size:9px;padding:1px 5px;border-radius:2px;font-weight:900;letter-spacing:.04em;background:rgba(255,255,255,.06);color:var(--muted);}
.act-btn{font-family:'Courier New',monospace;font-size:10px;font-weight:900;padding:3px 8px;cursor:pointer;border-radius:2px;letter-spacing:.04em;transition:background .12s;}
.btn-assign{background:rgba(77,255,145,.12);border:1px solid rgba(77,255,145,.35);color:#73d13d;}
.btn-assign:hover{background:rgba(77,255,145,.22);}
.btn-review{background:rgba(91,163,230,.1);border:1px solid rgba(91,163,230,.3);color:var(--blue);}
.btn-review:hover{background:rgba(91,163,230,.2);}
.btn-close{background:rgba(255,77,77,.1);border:1px solid rgba(255,77,77,.3);color:#ff7875;}
.btn-close:hover{background:rgba(255,77,77,.2);}
.no-inc{padding:30px;text-align:center;color:var(--muted);font-size:12px;}

/* ── Card layout (narrow / vertical < 600px) ───── */
@media (max-width: 600px) {
  table.inc-tbl thead{display:none;}
  table.inc-tbl, table.inc-tbl tbody, table.inc-tbl tr, table.inc-tbl td{display:block;width:100%;}
  table.inc-tbl tr{padding:8px 10px;border-bottom:1px solid var(--line);position:relative;}
  table.inc-tbl td{padding:2px 0;border:none;}
  table.inc-tbl td:before{content:attr(data-label);font-size:9px;color:var(--muted);font-weight:700;letter-spacing:.06em;margin-right:6px;}
  table.inc-tbl td.td-actions{display:flex;gap:4px;padding-top:6px;}
  .note-cell{max-width:none;white-space:normal;}
  .scene-cell{max-width:none;white-space:normal;}
}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;}
.modal-box{background:#0d1420;border:1px solid var(--line);padding:20px;min-width:280px;max-width:380px;}
.modal-title{font-size:13px;font-weight:900;color:var(--hi);margin-bottom:12px;letter-spacing:.06em;}
.modal-body{font-size:11px;color:var(--text);margin-bottom:14px;line-height:1.6;}
.modal-row{margin-bottom:10px;}
.modal-label{font-size:10px;color:var(--muted);margin-bottom:4px;font-weight:700;}
select.modal-select{width:100%;background:#0b1018;border:1px solid var(--line);color:var(--text);font-family:'Courier New',monospace;font-size:11px;padding:5px 8px;font-weight:700;}
.modal-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;}
.btn-ok{background:rgba(77,255,145,.12);border:1px solid rgba(77,255,145,.35);color:#73d13d;font-family:'Courier New',monospace;font-size:11px;font-weight:900;padding:5px 14px;cursor:pointer;letter-spacing:.04em;}
.btn-ok:hover{background:rgba(77,255,145,.22);}
.btn-cancel{background:transparent;border:1px solid var(--line);color:var(--muted);font-family:'Courier New',monospace;font-size:11px;font-weight:900;padding:5px 14px;cursor:pointer;letter-spacing:.04em;}
.btn-cancel:hover{color:var(--text);}
#relayScreen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:200;}
#relayScreen .relay-msg{font-size:13px;color:var(--muted);letter-spacing:.06em;}
#relayScreen .relay-brand{font-size:16px;font-weight:900;color:var(--hi);letter-spacing:.1em;}
</style>
</head>
<body>

<!-- Relay wait -->
<div id="relayScreen">
  <div class="relay-brand">HOSCAD</div>
  <div class="relay-msg">INCIDENT QUEUE</div>
  <div class="relay-msg" id="relayMsg" style="font-size:11px;">CONNECTING TO BOARD...</div>
</div>

<!-- Main content (hidden until token received) -->
<div id="mainWrap" style="display:none;height:100%;flex-direction:column;">
  <div class="topbar">
    <span class="brand">INCIDENT QUEUE</span>
    <span id="livePill" class="live-pill">CONNECTING...</span>
    <span class="clock" id="clockEl">--:--:--</span>
  </div>
  <div id="summaryStrip">
    <span class="ss-item s-q">QUEUED: <strong id="ssQueued">-</strong></span>
    <span class="ss-item s-a">ACTIVE: <strong id="ssActive">-</strong></span>
    <span class="ss-item">AV UNITS: <strong id="ssAv">-</strong></span>
  </div>
  <div id="countdownBar"><div id="countdownFill" style="width:100%;"></div></div>
  <div id="queueWrap">
    <div class="no-inc">LOADING...</div>
  </div>
</div>

<!-- Assign modal -->
<div id="assignModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <div class="modal-title">ASSIGN UNIT TO INCIDENT</div>
    <div id="assignIncLabel" class="modal-body"></div>
    <div class="modal-row">
      <div class="modal-label">SELECT UNIT</div>
      <select id="assignUnitSel" class="modal-select"><option value="">— AVAILABLE UNITS —</option></select>
    </div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeAssign()">CANCEL</button>
      <button class="btn-ok" onclick="doAssign()">ASSIGN</button>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <div class="modal-title" id="confirmTitle">CONFIRM</div>
    <div class="modal-body" id="confirmBody"></div>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeConfirm(false)">CANCEL</button>
      <button class="btn-ok" onclick="closeConfirm(true)">CONFIRM</button>
    </div>
  </div>
</div>

<script src="../api.js"></script>
<script>
'use strict';

// ── Constants ──────────────────────────────────────────────────────────
const POLL_INTERVAL = 10;   // seconds
const RELAY_WAIT    = 2000; // ms to wait for token relay
const STALE_THRESH  = 45;   // seconds before "stale" warning

// ── State ──────────────────────────────────────────────────────────────
let _token    = sessionStorage.getItem('hoscad_inc_token') || localStorage.getItem('ems_token') || '';
let _state    = null;
let _polling  = false;
let _expired  = false;
let _countdown = POLL_INTERVAL;
let _lastOk   = null;
let _clockTimer  = null;
let _pollTimer   = null;
let _assignIncId = null;
let _confirmCb   = null;

// ── Utility ────────────────────────────────────────────────────────────
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function minutesSince(ts) {
  if (!ts) return null;
  const d = new Date(ts);
  if (isNaN(d)) return null;
  return (Date.now() - d.getTime()) / 60000;
}
function normTs(ts) {
  if (!ts) return ts;
  return String(ts).replace(' ', 'T').replace(/([+-]\d{2})(\d{2})$/, '$1:$2');
}

// ── Token relay ────────────────────────────────────────────────────────
function setupRelay() {
  if (_token) { init(); return; }

  function handler(e) {
    if (e.origin !== window.location.origin) return;
    if (e.data && e.data.type === 'HOSCAD_RELAY_TOKEN' && e.data.token) {
      window.removeEventListener('message', handler);
      _token = e.data.token;
      sessionStorage.setItem('hoscad_inc_token', _token);
      init();
    }
  }
  window.addEventListener('message', handler);

  // Request token from opener
  if (window.opener) {
    window.opener.postMessage({ type: 'HOSCAD_REQUEST_RELAY_TOKEN' }, window.location.origin);
  }

  // Timeout fallback
  setTimeout(function() {
    if (!_token) {
      document.getElementById('relayMsg').textContent = 'NO TOKEN — OPEN FROM MAIN BOARD';
    }
  }, RELAY_WAIT);
}

// ── Initialization ─────────────────────────────────────────────────────────
function init() {
  document.getElementById('relayScreen').style.display = 'none';
  const mw = document.getElementById('mainWrap');
  mw.style.display = 'flex';
  mw.style.flexDirection = 'column';
  mw.style.height = '100%';

  _clockTimer = setInterval(onTick, 1000);
  doPoll();
}

// ── Polling ──────────────────────────────────────────────────────────────
async function doPoll() {
  if (_polling || _expired || !_token) return;
  _polling = true;
  try {
    const res = await API.getState(_token);
    if (!res || !res.ok) {
      if (res && /NOT AUTH|TOKEN EXP|SESSION EXP|PLEASE LOG/i.test(res.error || '')) {
        _expired = true;
        document.getElementById('livePill').textContent = 'SESSION EXPIRED';
        document.getElementById('livePill').classList.add('stale');
      }
    } else {
      _state = res;
      _lastOk = Date.now();
      _countdown = POLL_INTERVAL;
      document.getElementById('countdownFill').style.width = '100%';
      setLive(true);
      renderQueue();
      renderSummary();
    }
  } catch(e) {
    setLive(false);
  } finally {
    _polling = false;
  }
}

function onTick() {
  // Clock
  const now = new Date();
  const cl = document.getElementById('clockEl');
  if (cl) cl.textContent = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});

  if (_expired) return;

  _countdown = Math.max(0, _countdown - 1);
  const fill = document.getElementById('countdownFill');
  if (fill) fill.style.width = ((_countdown / POLL_INTERVAL) * 100) + '%';
  if (_countdown <= 0 && !_polling) { _countdown = POLL_INTERVAL; doPoll(); }

  if (_lastOk && (Date.now() - _lastOk) / 1000 > STALE_THRESH) setLive(false);
}

function setLive(ok) {
  const el = document.getElementById('livePill');
  if (!el) return;
  el.textContent = ok ? 'LIVE' : 'STALE';
  el.classList.toggle('stale', !ok);
}

// ── Summary strip ──────────────────────────────────────────────────────────
function renderSummary() {
  if (!_state) return;
  const queued = (_state.incidents||[]).filter(i=>i.status==='QUEUED').length;
  const active = (_state.incidents||[]).filter(i=>i.status==='ACTIVE').length;
  const av     = (_state.units||[]).filter(u=>u.active&&u.status==='AV').length;
  const set = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
  set('ssQueued', queued);
  set('ssActive', active);
  set('ssAv', av);
}

// ── Incident queue render ────────────────────────────────────────────────────────
function resolveDestName(code) {
  if (!code || !_state) return code || '';
  const v = String(code).trim().toUpperCase();
  const d = (_state.destinations||[]).find(x=>x.code===v);
  return (d && d.name) ? d.name : v;
}

function renderQueue() {
  if (!_state) return;
  const wrap = document.getElementById('queueWrap');
  const queued = (_state.incidents||[]).filter(i=>i.status==='QUEUED');
  const active = (_state.incidents||[]).filter(i=>i.status==='ACTIVE');
  queued.sort((a,b)=>new Date(normTs(a.created_at))-new Date(normTs(b.created_at)));
  active.sort((a,b)=>new Date(normTs(a.created_at))-new Date(normTs(b.created_at)));

  if (!queued.length && !active.length) {
    wrap.innerHTML = '<div class="no-inc">NO QUEUED OR ACTIVE INCIDENTS</div>';
    return;
  }
  let h = '';
  if (queued.length) {
    h += '<div class="section-hdr queued">QUEUED (' + queued.length + ')</div>';
    h += _buildIncTable(queued, true);
  }
  if (active.length) {
    h += '<div class="section-hdr active">ACTIVE (' + active.length + ')</div>';
    h += _buildIncTable(active, false);
  }
  wrap.innerHTML = h;
}

function _buildIncTable(incidents, showAssign) {
  let h = '<table class="inc-tbl"><thead><tr>';
  h += '<th>INC #</th><th>DEST</th><th>SCENE</th><th>TYPE</th><th>UNITS</th><th>NOTE</th><th>WAIT</th><th>ACTIONS</th>';
  h += '</tr></thead><tbody>';

  incidents.forEach(function(inc) {
    var pri   = inc.priority || '';
    var rawNote = inc.incident_note || '';
    var isMa  = /\[MA\]/i.test(rawNote);
    var cbM   = rawNote.match(/\[CB:([^\]]+)\]/i);
    var note  = rawNote.replace(/\[[^\]]*\]/g,'').replace(/\s{2,}/g,' ').trim();
    var isUrg = rawNote.includes('[URGENT]') || pri==='PRI-1' || pri==='CRITICAL';
    var rowCl = (isUrg ? 'inc-urgent' : '') + (isMa ? ' inc-mutual-aid' : '');
    var shortId = inc.incident_id.replace(/^\d{2}-/,'');
    var waitM = Math.floor((Date.now()-new Date(normTs(inc.created_at)).getTime())/60000);
    var waitCl = waitM>=20 ? 'wait-cell wait-over' : waitM>=10 ? 'wait-cell wait-warn' : 'wait-cell wait-ok';
    var destName = resolveDestName(inc.destination);
    var scene = inc.scene_address || '';
    var units = inc.units || '';
    var holdM = rawNote.match(/\[HOLD:(\d{1,2}:\d{2})\]/i);
    var holdBadge = '';
    if (holdM) {
      var hParts = holdM[1].split(':'), hNow = new Date();
      var hDue = new Date(hNow.getFullYear(), hNow.getMonth(), hNow.getDate(), parseInt(hParts[0],10), parseInt(hParts[1],10), 0, 0);
      holdBadge = '<span class="hold-badge' + (hNow >= hDue ? ' hold-badge-due' : '') + '">&#9200; ' + esc(holdM[1]) + '</span>';
    }
    var maBadge = isMa ? '<span class="ma-badge">MA</span>' : '';
    var cbBadge = cbM ? '<span class="cb-badge">CB:'+esc(cbM[1].trim())+'</span>' : '';
    var priBadge = pri ? '<span class="pri-badge priority-'+esc(pri)+'">'+esc(pri)+'</span>' : '';
    var ppBadge = inc.pp_incident_id ? '<span class="pp-rel-badge" title="PulsePoint Link">PP:'+esc(inc.pp_incident_id)+'</span>' : '';
    var relIds = Array.isArray(inc.related_incidents) ? inc.related_incidents : [];
    var relBadge = relIds.map(function(rid) {
      var shortRel = String(rid).replace(/^\d{2}-/,'');
      return '<span class="rel-badge" title="Linked Incident">REL:'+esc(shortRel)+'</span>';
    }).join('');
    var incType = inc.incident_type || '';
    var iid = esc(inc.incident_id);

    h += '<tr class="'+rowCl+'" onclick="reviewInc(\x27'+iid+'\x27)">';
    h += '<td class="inc-id-cell" data-label="INC">INC'+esc(shortId)+priBadge+holdBadge+maBadge+cbBadge+ppBadge+relBadge+'</td>';
    h += '<td class="dest-cell" data-label="DEST">'+esc(destName)+'</td>';
    h += '<td class="scene-cell" data-label="SCENE" title="'+esc(scene)+'">'+(scene?esc(scene):'')+'</td>';
    h += '<td data-label="TYPE">'+(incType?'<span class="inc-type-badge">'+esc(incType)+'</span>':'')+'</td>';
    h += '<td class="units-cell" data-label="UNITS">'+(units?esc(units):'')+'</td>';
    h += '<td class="note-cell" data-label="NOTE" title="'+esc(note)+'">'+(note?esc(note):'')+'</td>';
    h += '<td class="'+waitCl+'" data-label="WAIT">'+waitM+'M</td>';
    h += '<td class="td-actions" style="white-space:nowrap;display:flex;gap:4px;padding:4px 6px;">';
    if (showAssign) h += '<button class="act-btn btn-assign" onclick="event.stopPropagation();openAssign(\x27'+iid+'\x27)">ASSIGN</button>';
    h += '<button class="act-btn btn-review" onclick="event.stopPropagation();reviewInc(\x27'+iid+'\x27)">REVIEW</button>';
    h += '<button class="act-btn btn-close" onclick="event.stopPropagation();closeInc(\x27'+iid+'\x27)">CLOSE</button>';
    h += '</td>';
    h += '</tr>';
  });

  h += '</tbody></table>';
  return h;
}

// ── Actions ──────────────────────────────────────────────────────────────
function reviewInc(incId) {
  // Ask main board to open the incident review modal
  if (window.opener && !window.opener.closed) {
    window.opener.postMessage({ type: 'HOSCAD_REVIEW_INCIDENT', incidentId: incId }, window.location.origin);
    window.opener.focus();
  }
}

function openAssign(incId) {
  if (!_state) return;
  _assignIncId = incId;
  const inc = (_state.incidents||[]).find(i=>i.incident_id===incId);
  const shortId = incId.replace(/^\d{2}-/,'');
  document.getElementById('assignIncLabel').textContent = 'INC' + shortId + (inc && inc.destination ? ' → '+resolveDestName(inc.destination) : '');
  const sel = document.getElementById('assignUnitSel');
  sel.innerHTML = '<option value="">— SELECT UNIT —</option>';
  const assigned = (_state.assignments||[]).filter(a=>a.incident_id===incId&&!a.cleared_at).map(a=>a.unit_id);
  const avUnits = (_state.units||[]).filter(u=>u.active && (u.status==='AV'||u.status==='BRK') && u.include_in_recommendations!==false && !assigned.includes(u.unit_id));
  const lvlRank = {'CCT':0,'ALS':0,'AEMT':1,'BLS':2,'EMT':2};
  avUnits.sort((a,b)=>{
    if (a.status!==b.status) return a.status==='AV'?-1:1;
    return (lvlRank[a.level]??3)-(lvlRank[b.level]??3)||String(a.unit_id).localeCompare(String(b.unit_id));
  });
  avUnits.forEach(u => {
    const o = document.createElement('option');
    o.value = u.unit_id;
    o.textContent = u.unit_id + (u.level ? ' ['+u.level+']' : '') + (u.status==='BRK'?' [BRK]':'') + (u.destination ? ' @ '+u.destination : '');
    sel.appendChild(o);
  });
  document.getElementById('assignModal').style.display = 'flex';
}

function closeAssign() {
  document.getElementById('assignModal').style.display = 'none';
  _assignIncId = null;
}

async function doAssign() {
  const unitId = document.getElementById('assignUnitSel').value;
  if (!unitId || !_assignIncId) return;
  closeAssign();
  try {
    await API.assignUnit(_token, _assignIncId, unitId);
    await API.upsertUnit(_token, unitId, { status: 'D', incident: _assignIncId });
    doPoll();
  } catch(e) { alert('ASSIGN FAILED: ' + e.message); }
}

function closeInc(incId) {
  const shortId = incId.replace(/^\d{2}-/,'');
  _confirmCb = async function(ok) {
    if (!ok) return;
    try {
      await API.call('closeIncident', _token, incId);
      doPoll();
    } catch(e) { alert('CLOSE FAILED: ' + e.message); }
  };
  document.getElementById('confirmTitle').textContent = 'CLOSE INCIDENT';
  document.getElementById('confirmBody').textContent = 'Close INC' + shortId + '? This cannot be undone from this window.';
  document.getElementById('confirmModal').style.display = 'flex';
}

function closeConfirm(ok) {
  document.getElementById('confirmModal').style.display = 'none';
  if (_confirmCb) { _confirmCb(ok); _confirmCb = null; }
}

// ── Boot ─────────────────────────────────────────────────────────────────
setupRelay();
</script>
</body>
</html>
