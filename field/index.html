<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#070a0f" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="HOSCADField" />
  <title>HOSCAD FIELD</title>
  <link rel="manifest" href="../manifest-field.json" />
  <link rel="icon" type="image/x-icon" href="../icons/favicon.ico?v=3" />
  <link rel="icon" type="image/png" sizes="32x32" href="../icons/icon-32.png?v=3" />
  <link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png?v=3" />
  <style>
    :root {
      --bg: #070a0f;
      --panel: #0c111a;
      --panel2: #0a0f17;
      --line: #1f2b3d;
      --text: #d9e3f2;
      --muted: #8fa1b8;
      --hi: #ffffff;
      --blue: #2f6cff;
      --yellow: #ffd66b;
      --red: #ff6b6b;
      --green: #7fffb2;
      --purple: #c084fc;
      --orange: #ffaa5b;
      --font-mono: Consolas, Menlo, Monaco, "Courier New", monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      height: 100dvh; /* accounts for iOS browser chrome */
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-mono);
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.3px;
      overflow: hidden;
    }

    input, select, button {
      text-transform: uppercase;
      font-family: inherit;
      letter-spacing: 0.3px;
      background: var(--panel);
      color: var(--text);
      border: 2px solid var(--line);
      padding: 10px 12px;
      font-size: 13px;
      outline: none;
    }

    button { cursor: pointer; }
    button:hover { filter: brightness(1.08); }
    input::placeholder { color: #657892; }

    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Header — safe-area-inset-top pushes content below the iOS status bar notch */
    .header {
      padding: max(10px, env(safe-area-inset-top)) 16px 10px;
      background: var(--panel2);
      border-bottom: 2px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .brand {
      font-weight: 900;
      color: var(--hi);
      font-size: 14px;
    }

    .callsign-label {
      color: var(--green);
      font-weight: 900;
      font-size: 12px;
    }

    .cad-unit-status {
      padding: 3px 8px;
      font-weight: 900;
      font-size: 11px;
      border: 2px solid var(--line);
      min-width: 32px;
      text-align: center;
    }

    .cad-status-AV  { background: rgba(127,255,178,0.2); color: #7fffb2; border-color: #214434; }
    .cad-status-DE  { background: rgba(255,214,107,0.2); color: #ffd66b; border-color: #6a5220; }
    .cad-status-OS  { background: rgba(255,107,107,0.2); color: #ff6b6b; border-color: #5b2727; }
    .cad-status-T   { background: rgba(192,132,252,0.2); color: #c084fc; border-color: #4a2d78; }
    .cad-status-TH  { background: rgba(0,200,200,0.2);   color: #00cccc; border-color: #1a5555; }
    .cad-status-D   { background: rgba(47,108,255,0.2);  color: #6ba3ff; border-color: #1f4488; }
    .cad-status-OOS { background: rgba(100,100,100,0.2); color: #999;    border-color: #444; }
    .cad-status-BRK { background: rgba(100,100,100,0.2); color: #bbb;    border-color: #555; }
    .cad-status-UV  { background: rgba(100,100,100,0.2); color: #999;    border-color: #444; }
    .cad-status-F   { background: rgba(255,170,91,0.2);  color: #ffaa5b; border-color: #6a4520; }
    .cad-status-FD  { background: rgba(255,170,91,0.2);  color: #ffaa5b; border-color: #6a4520; }

    .offline-indicator {
      padding: 3px 8px;
      font-weight: 900;
      font-size: 11px;
      background: rgba(255,107,107,0.2);
      color: var(--red);
      border: 2px solid #5b2727;
      display: none;
    }

    .pending-badge {
      padding: 3px 8px;
      font-weight: 900;
      font-size: 11px;
      background: rgba(255,214,107,0.15);
      color: var(--yellow);
      border: 2px solid #6a5220;
    }

    .btn-logout {
      background: #2a1212;
      border-color: #5b2727;
      color: var(--red);
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 900;
      min-height: 48px;
    }

    .btn-refresh {
      background: #0a1628;
      border-color: #1a3a5c;
      color: #5ba3e6;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 900;
      min-height: 48px;
    }

    .btn-night {
      background: #1a1a2e;
      border-color: #333;
      color: var(--muted);
      padding: 8px 10px;
      font-size: 10px;
      font-weight: 900;
      min-height: 48px;
    }

    /* Wake Lock button — green when active, muted when off */
    .btn-wake {
      background: #0a1a0a;
      border-color: #214434;
      color: #4a7a4a;
      padding: 8px 10px;
      font-size: 10px;
      font-weight: 900;
      min-height: 48px;
    }
    .btn-wake.wake-active {
      background: rgba(127,255,178,0.1);
      border-color: #3a8a5a;
      color: #7fffb2;
    }

    /* Login Screen */
    .login-screen {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-card {
      background: var(--panel2);
      border: 2px solid var(--line);
      padding: 20px;
      width: 100%;
      max-width: 360px;
    }

    .login-card h2 {
      color: var(--hi);
      font-size: 16px;
      margin-bottom: 12px;
    }

    .login-card .field {
      margin-bottom: 10px;
    }

    .login-card .field-label {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .login-card input {
      width: 100%;
      min-height: 48px;
      font-size: 14px;
    }

    .login-card .btn-login {
      background: #0f2518;
      border-color: #214434;
      width: 100%;
      font-weight: 900;
      min-height: 52px;
      font-size: 14px;
    }

    .login-err {
      color: var(--red);
      font-size: 11px;
      margin-top: 8px;
      min-height: 16px;
    }

    .btn-install {
      background: #0a1628;
      border: 1px solid #1a3a5c;
      color: #5ba3e6;
      width: 100%;
      padding: 10px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: none;
    }

    /* Field Panel — outer wrapper; tab content panels handle their own scrolling */
    .field-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .field-panel.hidden { display: none; }

    /* Alert/Note Banners */
    .field-banner {
      padding: 10px 16px;
      font-weight: 900;
      font-size: 13px;
      display: none;
      line-height: 1.3;
    }

    .field-banner.alert {
      background: rgba(255,107,107,0.2);
      color: #ffb0b0;
      border-bottom: 2px solid #5b2727;
    }

    .field-banner.note {
      background: rgba(255,214,107,0.15);
      color: var(--yellow);
      border-bottom: 2px solid #6a5220;
    }

    .banner-ack-btn {
      display: inline-block;
      margin-left: 10px;
      padding: 2px 10px;
      font-size: 10px;
      font-weight: 900;
      font-family: var(--font-mono);
      text-transform: uppercase;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.25);
      color: #ccc;
      cursor: pointer;
      vertical-align: middle;
      letter-spacing: .04em;
    }
    .banner-ack-btn.acked {
      background: rgba(76,175,80,0.15);
      border-color: rgba(76,175,80,0.4);
      color: #4caf50;
    }

    /* ════════════════════════════════════════════════════════════
       INCIDENT DISPLAY PANEL - Primary focus of the field app
       ════════════════════════════════════════════════════════════ */
    .incident-panel {
      flex: 0 0 auto;
      background: var(--panel2);
      border-bottom: 2px solid var(--line);
    }

    .incident-panel.no-incident {
      padding: 30px 16px;
      text-align: center;
    }

    .incident-panel.no-incident .no-call-text {
      color: var(--muted);
      font-size: 14px;
      font-weight: 700;
    }

    .incident-panel.no-incident .no-call-status {
      color: var(--green);
      font-size: 18px;
      font-weight: 900;
      margin-top: 8px;
    }

    .incident-panel.has-incident {
      padding: 12px 16px;
    }

    /* Incident Header Row */
    .inc-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .inc-number {
      font-weight: 900;
      color: var(--yellow);
      font-size: 14px;
      background: rgba(255,214,107,0.1);
      padding: 4px 10px;
      border: 1px solid #6a5220;
    }

    .inc-priority {
      font-weight: 900;
      font-size: 11px;
      padding: 4px 10px;
      border: 2px solid;
    }

    .inc-priority.priority-high {
      background: rgba(255,107,107,0.2);
      color: var(--red);
      border-color: #5b2727;
    }

    .inc-priority.priority-med {
      background: rgba(255,170,91,0.2);
      color: var(--orange);
      border-color: #6a4520;
    }

    .inc-priority.priority-low {
      background: rgba(127,255,178,0.15);
      color: var(--green);
      border-color: #214434;
    }

    /* PRI-1/2/3/4 priority classes (M-1) */
    .inc-priority.inc-priority-1 {
      background: rgba(255,60,60,0.25);
      color: #ff4444;
      border-color: #7b1c1c;
    }

    .inc-priority.inc-priority-2 {
      background: rgba(255,153,0,0.2);
      color: #ff9900;
      border-color: #7a4a00;
    }

    .inc-priority.inc-priority-3 {
      background: rgba(255,214,107,0.15);
      color: var(--yellow);
      border-color: #6a5220;
    }

    .inc-priority.inc-priority-4 {
      background: rgba(76,175,80,0.15);
      color: #4caf50;
      border-color: #1a4a1c;
    }

    .inc-ma-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 900;
      padding: 3px 7px;
      background: rgba(255,153,0,.18);
      border: 1px solid rgba(255,153,0,.5);
      color: #ff9900;
      letter-spacing: .07em;
      vertical-align: middle;
    }

    .inc-nature {
      font-weight: 900;
      color: var(--hi);
      font-size: 15px;
    }

    /* Address - THE MOST IMPORTANT ELEMENT */
    .inc-address {
      font-weight: 900;
      color: var(--hi);
      font-size: 22px;
      line-height: 1.2;
      margin-bottom: 6px;
      background: rgba(255,255,255,0.03);
      padding: 8px 12px;
      border-left: 4px solid var(--blue);
    }

    .inc-address-detail {
      font-size: 13px;
      color: var(--text);
      margin-bottom: 2px;
      padding-left: 16px;
    }

    .inc-cross {
      color: var(--yellow);
      font-weight: 700;
    }

    .inc-callback {
      color: var(--green);
      font-weight: 700;
      font-size: 14px;
    }

    /* Incident Notes - Scrollable */
    .inc-notes-container {
      margin-top: 8px;
      max-height: 80px;
      overflow-y: auto;
      background: rgba(0,0,0,0.2);
      padding: 8px 12px;
      border: 1px solid var(--line);
    }

    .inc-notes-label {
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .inc-notes-text {
      color: var(--yellow);
      font-weight: 700;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Times Row */
    .inc-times {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .inc-time-item {
      display: flex;
      gap: 4px;
    }

    .inc-time-label {
      color: #657892;
    }

    .inc-time-value {
      color: var(--text);
      font-weight: 700;
    }

    /* Other Units */
    .inc-units {
      margin-top: 6px;
      font-size: 11px;
      color: var(--green);
    }

    /* Field Status Buttons */
    .field-status-buttons {
      display: flex;
      gap: 4px;
      padding: 8px 16px;
      border-bottom: 1px solid var(--line);
      flex-wrap: wrap;
    }

    .field-status-btn {
      flex: 1;
      padding: 14px 4px;
      font-weight: 900;
      font-size: 13px;
      font-family: var(--font-mono);
      text-transform: uppercase;
      cursor: pointer;
      border: 2px solid var(--line);
      text-align: center;
      min-width: 0;
      min-height: 48px;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      touch-action: manipulation;
    }

    .field-status-de  { background: rgba(255,214,107,0.15); color: #ffd66b; border-color: #6a5220; }
    .field-status-os  { background: rgba(255,107,107,0.15); color: #ff6b6b; border-color: #5b2727; }
    .field-status-t   { background: rgba(192,132,252,0.15); color: #c084fc; border-color: #4a2d78; }
    .field-status-th  { background: rgba(0,200,200,0.15);   color: #00cccc; border-color: #1a5555; }
    .field-status-av  { background: rgba(127,255,178,0.15); color: #7fffb2; border-color: #214434; }
    .field-status-oos { background: rgba(100,100,100,0.15); color: #999;    border-color: #444; }
    .field-status-brk { background: rgba(100,100,100,0.15); color: #bbb;    border-color: #555; }
    .field-status-iq  { background: rgba(224,224,224,0.10); color: #e0e0e0; border-color: #666; }

    .field-status-btn:active { filter: brightness(1.3); }
    .field-status-btn.current { box-shadow: 0 0 0 2px var(--hi) inset; }

    /* Status grid layout (Change 5) */
    .field-status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      padding: 8px 16px 0;
    }
    .field-status-grid .field-status-btn {
      min-height: 88px;
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .06em;
      flex: unset;
    }
    .field-status-secondary {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      padding: 6px 16px 8px;
      border-bottom: 1px solid var(--line);
    }
    /* LOC button */
    .field-status-loc { background: rgba(91,163,230,.12); border-color: rgba(91,163,230,.4); color: #4fa3e0; }
    .field-status-loc.loc-active { box-shadow: 0 0 0 2px #4fa3e0 inset; }
    /* LOC slide-up input panel */
    .field-loc-panel {
      display: flex;
      gap: 6px;
      padding: 8px 16px;
      background: rgba(91,163,230,.07);
      border-bottom: 1px solid rgba(91,163,230,.22);
      align-items: center;
    }
    .field-loc-panel input {
      flex: 1;
      background: #0b1018;
      border: 1px solid rgba(91,163,230,.5);
      color: #e2e8f0;
      padding: 8px 10px;
      font-family: inherit;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .04em;
      border-radius: 2px;
    }
    .field-loc-panel button {
      padding: 8px 13px;
      font-family: inherit;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .05em;
      border: 1px solid rgba(91,163,230,.4);
      background: rgba(91,163,230,.15);
      color: #4fa3e0;
      cursor: pointer;
      border-radius: 2px;
      touch-action: manipulation;
      -webkit-touch-callout: none;
    }
    .field-loc-panel .loc-clr-btn { border-color: rgba(255,100,100,.35); background: rgba(255,100,100,.1); color: #ff8888; }
    .field-loc-panel .loc-close-btn { border-color: #333; background: transparent; color: #666; }
    .field-status-secondary .field-status-btn {
      min-height: 56px;
      font-size: 12px;
      flex: unset;
    }

    /* Command Bar Area — sticky to bottom so it's always accessible on small screens */
    .cmd-area {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      position: sticky;
      bottom: 0;
      z-index: 5;
      background: var(--bg);
      border-top: 1px solid var(--line);
    }

    .cmd-feed {
      min-height: 60px;
      max-height: 180px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 8px 16px;
      font-size: 12px;
      background: var(--bg);
    }

    .cmd-feed-line {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .cmd-feed-line .cmd-ts { color: #555; font-size: 11px; }
    .cmd-feed-line .cmd-from { color: var(--blue); font-weight: 900; }
    .cmd-feed-line .cmd-urgent { color: var(--red); font-weight: 900; }
    .cmd-feed-line .cmd-sys { color: var(--yellow); font-weight: 700; }
    .cmd-feed-line .cmd-err { color: var(--red); font-weight: 700; }
    .cmd-feed-line .cmd-status-change { color: var(--green); font-weight: 900; }
    .cmd-feed-line .cmd-alert { color: var(--red); font-weight: 900; background: rgba(255,107,107,0.1); padding: 2px 6px; }

    .cmd-input-row {
      display: flex;
      gap: 6px;
      padding: 6px 16px;
      background: var(--panel2);
      border-top: 1px solid var(--line);
    }

    .cmd-input-row input {
      flex: 1;
      padding: 10px 10px;
      font-size: 13px;
      min-height: 48px;
    }

    .cmd-input-row button {
      padding: 10px 16px;
      background: #0f2518;
      border-color: #214434;
      font-weight: 900;
      font-size: 12px;
      min-height: 48px;
    }

    .cmd-quick-row {
      display: flex;
      gap: 4px;
      padding: 6px 16px max(8px, env(safe-area-inset-bottom));
      background: var(--panel2);
      flex-wrap: wrap;
    }

    .cmd-quick-btn {
      padding: 10px 12px;
      font-size: 12px;
      font-weight: 900;
      font-family: var(--font-mono);
      text-transform: uppercase;
      background: var(--panel);
      border: 1px solid var(--line);
      color: var(--muted);
      cursor: pointer;
      min-height: 48px;
    }

    .cmd-quick-btn:hover {
      background: var(--line);
      color: var(--hi);
    }

    /* Confirm Dialog */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.80);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }

    .confirm-overlay.active { display: flex; }

    .confirm-box {
      background: var(--panel2);
      border: 2px solid var(--line);
      padding: 20px;
      max-width: 400px;
      width: 100%;
    }

    .confirm-title {
      font-size: 14px;
      font-weight: 900;
      color: var(--hi);
      margin-bottom: 12px;
    }

    .confirm-message {
      color: var(--text);
      margin-bottom: 16px;
      line-height: 1.4;
      font-size: 12px;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
    }

    .confirm-buttons button {
      flex: 1;
      min-height: 52px;
      font-size: 14px;
      font-weight: 900;
    }

    .btn-confirm-yes {
      background: #0f2518;
      border-color: #214434;
      color: var(--green);
    }

    .btn-confirm-no {
      background: #2a1212;
      border-color: #5b2727;
      color: var(--red);
    }

    /* Night mode — dims field panel for night driving; overlays outside #fieldPanel are unaffected */
    body.night-mode #fieldPanel {
      filter: brightness(0.45) saturate(0.7);
    }

    /* Mobile sizing */
    @media (max-width: 600px) {
      .field-status-btn { padding: 16px 4px; font-size: 14px; }
      .cmd-quick-btn { padding: 12px 14px; font-size: 13px; }
      .inc-address { font-size: 18px; }
    }

    @media (max-width: 400px) {
      .field-status-buttons { flex-wrap: wrap; }
      .field-status-btn { flex: 1 1 30%; }
    }

    /* Landscape layout now handled by .field-tab-shell sidebar nav (Phase 1) */

    /* Collapsible command area toggle (Change 6) */
    .cmd-toggle-btn {
      width: 100%;
      padding: 6px;
      background: transparent;
      border: none;
      border-top: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      color: #8b949e;
      font-family: inherit;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .cmd-toggle-btn:hover { background: rgba(255,255,255,0.04); }
    #cmdCollapsible { transition: none; }
    #cmdCollapsible.collapsed { display: none; }

    /* Quick phrase buttons */
    .cmd-phrases-row {
      display: flex;
      gap: 4px;
      padding: 4px 16px 2px;
      background: var(--bg);
      flex-wrap: wrap;
      border-top: 1px solid var(--line);
    }
    .cmd-phrase-btn {
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 900;
      font-family: var(--font-mono, monospace);
      text-transform: uppercase;
      background: rgba(47,108,255,0.1);
      border: 1px solid #1f3d6a;
      color: #6ba3ff;
      cursor: pointer;
      min-height: 48px;
    }
    .cmd-phrase-btn:active { filter: brightness(1.3); }

    /* Hospital Quick Reference */
    .btn-info {
      background: #091a18; border-color: #194030; color: #7fffcc;
      padding: 8px 10px; font-size: 12px; font-weight: 900; min-height: 48px;
    }
    .info-overlay {
      position: fixed; inset: 0; z-index: 8000; background: rgba(0,0,0,.88);
      display: flex; flex-direction: column;
    }
    .info-overlay-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 2px solid #1f2b3d;
      background: #0c111a; flex-shrink: 0;
    }
    .info-overlay-title { font-weight: 900; font-size: 14px; color: #fff; letter-spacing: .05em; }
    .info-overlay-body { flex: 1; overflow-y: auto; padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; }
    .info-cat-label { font-size: 10px; color: #8fa1b8; font-weight: 900; letter-spacing: .1em; padding: 4px 0 2px; }
    .info-card { background: #0c111a; border: 1px solid #1f2b3d; padding: 12px; }
    .info-card.diverted { border-color: #5b2727; }
    .info-card-name { color: #fff; font-weight: 900; font-size: 13px; }
    .info-card-code { color: #ffd66b; font-weight: 900; font-size: 11px; margin-right: 4px; }
    .info-card-addr { color: #8fa1b8; font-size: 11px; margin: 4px 0; }
    .info-card-phone { color: #5ba3e6; font-size: 11px; margin-bottom: 4px; }
    .info-card-caps { margin: 4px 0 6px; }
    .cap-badge {
      display: inline-block; padding: 2px 6px; font-size: 10px; font-weight: 900;
      border-radius: 2px; margin-right: 3px; margin-bottom: 2px; letter-spacing: .04em;
    }
    .cap-l1  { background:rgba(255,60,60,.2);  color:#ff6b6b; border:1px solid #5b2727; }
    .cap-l2  { background:rgba(255,120,60,.2); color:#ffaa5b; border:1px solid #6a4020; }
    .cap-l3  { background:rgba(255,200,60,.2); color:#ffd66b; border:1px solid #6a5220; }
    .cap-air { background:rgba(192,132,252,.2);color:#c084fc; border:1px solid #4a2d78; }
    .cap-def { background:rgba(100,150,220,.15);color:#5ba3e6;border:1px solid #1a3a5c; }
    .cap-div-badge { background:rgba(255,60,60,.25);color:#ff6b6b;border:1px solid #7b1c1c;font-weight:900;padding:2px 8px;font-size:10px;margin-left:4px; }
    .btn-set-dest {
      margin-top: 8px; width: 100%; min-height: 44px; padding: 8px 14px;
      background: #0f2518; border: 2px solid #214434; color: #7fffb2;
      font-family: inherit; font-size: 12px; font-weight: 900; cursor: pointer;
      text-transform: uppercase; letter-spacing: .04em;
    }
    .btn-set-dest:active { filter: brightness(1.2); }

    /* Phase 2E — NEXT CALL strip */
    .next-call-panel {
      flex: 0 0 auto;
      border-left: 3px solid var(--text-muted, #666);
      background: rgba(255,255,255,.04);
      padding: 6px 10px;
      margin: 0 0 2px;
    }
    .next-call-panel.ncp-pri1 { border-left-color: #ff4444; }
    .next-call-panel.ncp-pri2 { border-left-color: #ff9900; }
    .next-call-panel.ncp-pri3 { border-left-color: #ffd66b; }
    .next-call-panel.ncp-pri4 { border-left-color: #4caf50; }
    .next-call-hdr {
      display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
    }
    .next-call-lbl {
      font-size: 10px; font-weight: 900; color: #888; letter-spacing: .06em; flex: 1;
    }
    .next-call-count {
      font-size: 10px; color: #888;
    }
    .next-call-ack-btn {
      font-size: 10px; font-weight: 700; font-family: inherit;
      background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.2);
      color: #ccc; padding: 2px 8px; border-radius: 2px; cursor: pointer;
    }
    .next-call-ack-btn.acked {
      background: rgba(76,175,80,.15); border-color: rgba(76,175,80,.4); color: #4caf50;
    }
    .next-call-body {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    }
    .next-call-type {
      font-size: 12px; font-weight: 700; color: var(--text, #eee); letter-spacing: .03em;
    }
    .next-call-dest {
      font-size: 11px; color: #aaa; font-weight: 600;
    }
    #nextCallRows { margin-top: 4px; }
    .next-call-extra-row {
      display: flex; align-items: center; gap: 6px;
      padding: 2px 0; border-top: 1px solid rgba(255,255,255,.06);
      font-size: 11px; color: #999;
    }
    .next-call-extra-num {
      font-size: 10px; font-weight: 700; color: #666; min-width: 16px;
    }

    /* New-call flash: animate the incident panel border for 3 seconds when
       a new incident is assigned so it is visible even with cmd area collapsed. */
    @keyframes newCallPulse {
      0%   { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.9); border-color: #ff6b6b; }
      50%  { box-shadow: 0 0 0 8px rgba(255, 107, 107, 0); border-color: #ff4444; }
      100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); border-color: var(--line); }
    }
    .incident-panel.new-call-flash {
      animation: newCallPulse 0.6s ease-out 5;
    }

    /* ── Tablet breakpoint (768px+) — larger fonts + touch targets for vehicle-mounted displays ── */
    @media (min-width: 768px) {
      html, body { font-size: 15px; }
      .app { max-width: 900px; }
      .header { padding: max(12px, env(safe-area-inset-top)) 20px 12px; }
      .brand { font-size: 16px; }
      .callsign-label { font-size: 14px; }
      .cad-unit-status { font-size: 13px; padding: 4px 12px; }
      .btn-logout, .btn-refresh, .btn-night, .btn-wake, .btn-info { min-height: 52px; font-size: 13px; padding: 10px 14px; }
      .field-banner { font-size: 15px; padding: 12px 20px; }
      .incident-panel.has-incident { padding: 16px 20px; }
      .incident-panel.no-incident .no-call-text { font-size: 16px; }
      .incident-panel.no-incident .no-call-status { font-size: 22px; }
      .inc-number { font-size: 16px; }
      .inc-nature { font-size: 17px; }
      .inc-address { font-size: 26px; padding: 10px 16px; }
      .inc-address-detail { font-size: 15px; }
      .inc-callback { font-size: 16px; }
      .inc-notes-container { max-height: 120px; padding: 10px 14px; }
      .inc-notes-text { font-size: 14px; }
      .inc-notes-label { font-size: 12px; }
      .inc-times { font-size: 13px; gap: 20px; }
      .inc-units { font-size: 13px; }
      .field-status-grid .field-status-btn { min-height: 100px; font-size: 17px; }
      .field-status-secondary .field-status-btn { min-height: 64px; font-size: 13px; }
      .cmd-feed { font-size: 14px; padding: 10px 20px; max-height: 220px; }
      .cmd-input-row { padding: 8px 20px; }
      .cmd-input-row input { font-size: 15px; min-height: 52px; }
      .cmd-input-row button { font-size: 14px; min-height: 52px; }
      .cmd-quick-btn { font-size: 13px; padding: 12px 16px; min-height: 52px; }
      .cmd-phrase-btn { font-size: 12px; padding: 10px 12px; min-height: 52px; }
      .next-call-type { font-size: 14px; }
      .next-call-dest { font-size: 13px; }
      .confirm-box { max-width: 500px; padding: 24px; }
      .confirm-title { font-size: 16px; }
      .confirm-message { font-size: 14px; }
      .confirm-buttons button { min-height: 56px; font-size: 16px; }
      .login-card { max-width: 440px; padding: 24px; }
      .login-card h2 { font-size: 18px; }
      .login-card input { font-size: 16px; min-height: 52px; }
      .login-card .btn-login { font-size: 16px; min-height: 56px; }
    }

    /* ── Large tablet / MDT monitor (1024px+) ── */
    @media (min-width: 1024px) {
      html, body { font-size: 16px; }
      .app { max-width: 1100px; }
      .inc-address { font-size: 30px; }
      .inc-nature { font-size: 19px; }
      .field-status-grid .field-status-btn { min-height: 110px; font-size: 18px; }
      .cmd-feed { max-height: 260px; }
    }

    /* ── Destination quick-select buttons (from styles.css, needed inline) ── */
    .dest-quick-row { display: flex; flex-wrap: wrap; gap: 4px; padding: 4px 0; }
    .dest-quick-btn {
      padding: 7px 10px; font-size: 11px; font-weight: 900;
      background: #080e18; border: 1px solid #14304a; color: #4a90c8;
      cursor: pointer; font-family: inherit; text-transform: uppercase; border-radius: 0;
    }
    .dest-quick-btn:hover { filter: brightness(1.15); }
    .dest-diverted { background: #180808 !important; border-color: #802020 !important; color: #e05050 !important; }
    .btn-handoff {
      width: 100%; padding: 10px; font-size: 13px; font-weight: 900;
      background: rgba(192,132,252,.12); border: 2px solid #7c3aed; color: #c084fc;
      cursor: pointer; font-family: inherit; letter-spacing: .06em;
    }

    /* ═══════════════════════════════════════════════════════════════════════
       PHASE 1: BOTTOM NAV + 5-TAB SHELL
       ═══════════════════════════════════════════════════════════════════════ */

    /* Slim persistent header — always visible after login */
    .field-slim-header {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: max(8px, env(safe-area-inset-top)) 12px 8px;
      background: var(--panel2);
      border-bottom: 1px solid var(--line);
      flex-wrap: nowrap;
      overflow: hidden;
      flex-shrink: 0;
    }

    /* Tab content panels — hidden by default, flex when active */
    .tab-content {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }
    .tab-content.active { display: flex; }

    /* Bottom nav bar — hidden until logged in */
    .bottom-nav {
      display: none;
      flex: 0 0 auto;
      flex-direction: row;
      background: var(--panel2);
      border-top: 2px solid var(--line);
      padding-bottom: max(0px, env(safe-area-inset-bottom));
      z-index: 20;
    }
    .bottom-nav.visible { display: flex; }

    /* Individual nav tab buttons */
    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      cursor: pointer;
      background: transparent;
      border: none;
      border-top: 3px solid transparent;
      color: var(--muted);
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      min-height: 56px;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      padding: 0;
    }
    .nav-tab:active { filter: brightness(1.2); }
    .nav-tab.active { color: var(--hi); border-top-color: var(--blue); }
    .nav-tab-icon { font-size: 17px; line-height: 1; }
    .nav-tab-badge {
      position: absolute;
      top: 6px;
      right: calc(50% - 20px);
      background: var(--red);
      color: #fff;
      font-size: 9px;
      font-weight: 900;
      min-width: 14px;
      height: 14px;
      border-radius: 7px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 3px;
    }
    .nav-tab-badge.visible { display: flex; }

    /* STATUS tab dispatch feed */
    #tabStatusFeed {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 8px 12px;
      font-size: 11px;
      background: var(--bg);
      min-height: 80px;
    }
    .tab-status-feed-label {
      font-size: 9px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing: .1em;
      padding: 8px 0 4px;
    }

    /* ROSTER tab */
    .roster-unit-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      -webkit-tap-highlight-color: transparent;
    }
    .roster-unit-id {
      font-weight: 900;
      color: var(--hi);
      min-width: 70px;
      font-size: 12px;
    }
    .roster-unit-status {
      font-size: 11px;
      font-weight: 900;
      padding: 2px 6px;
      border: 1px solid;
      min-width: 38px;
      text-align: center;
    }
    .roster-unit-inc {
      color: var(--yellow);
      font-size: 11px;
      font-weight: 700;
      flex: 1;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .roster-unit-note {
      font-size: 10px;
      color: var(--muted);
      max-width: 100px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    /* MORE tab utility rows */
    .more-section-label {
      font-size: 10px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: 0.1em;
      padding: 12px 16px 4px;
      background: var(--bg);
      flex-shrink: 0;
    }
    .more-row {
      display: flex;
      width: 100%;
      text-align: left;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: var(--panel2);
      min-height: 56px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.04em;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      cursor: pointer;
      color: var(--text);
      border-left: none;
      border-right: none;
      border-top: none;
      border-radius: 0;
      font-family: var(--font-mono);
      text-transform: uppercase;
    }
    .more-row:active { filter: brightness(1.12); }
    .more-row-label { color: var(--text); font-weight: 700; }
    .more-row-sub { font-size: 10px; color: var(--muted); font-weight: 400; margin-top: 2px; text-transform: uppercase; letter-spacing: .04em; }
    .more-row-arrow { color: var(--muted); font-size: 14px; flex-shrink: 0; margin-left: 8px; }

    /* CALLS tab */
    .call-queue-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: var(--panel2);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .call-queue-row:active { filter: brightness(1.1); }
    .call-queue-row.is-new { border-left: 3px solid var(--yellow); }
    .call-queue-pri { font-size: 12px; font-weight: 900; min-width: 56px; }
    .call-queue-type { font-weight: 900; font-size: 12px; color: var(--hi); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .call-queue-dest { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .call-queue-units { font-size: 10px; color: var(--blue); font-weight: 700; }

    /* CALLS detail sheet */
    #callDetailBackdrop {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9299;
      background: rgba(0,0,0,.5);
    }
    #callDetailSheet {
      display: none;
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 9300;
      background: var(--panel2);
      border-top: 2px solid var(--blue);
      max-height: 80vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }
    .cds-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .cds-title { font-size: 14px; font-weight: 900; color: var(--hi); letter-spacing: .04em; }
    .cds-close { background: none; border: none; color: var(--muted); font-size: 22px; padding: 4px 8px; cursor: pointer; line-height: 1; }
    .cds-field { padding: 8px 16px; border-bottom: 1px solid var(--line); display: flex; align-items: baseline; gap: 8px; }
    .cds-field-lbl { font-size: 10px; color: var(--muted); letter-spacing: .08em; min-width: 64px; flex-shrink: 0; }
    .cds-field-val { font-size: 12px; font-weight: 700; color: var(--text); flex: 1; word-break: break-word; }
    .cds-actions { padding: 14px 16px; display: flex; gap: 10px; flex-wrap: wrap; }
    .cds-btn { flex: 1; min-width: 120px; padding: 14px; font-family: var(--font-mono); font-size: 13px; font-weight: 900; cursor: pointer; letter-spacing: .04em; text-transform: uppercase; }
    .cds-btn-enroute { background: rgba(47,108,255,.15); border: 2px solid var(--blue); color: var(--blue); }
    .cds-btn-onscene { background: rgba(255,170,91,.12); border: 2px solid var(--orange); color: var(--orange); }
    .cds-btn-enroute:active, .cds-btn-onscene:active { filter: brightness(1.2); }
    .cds-btn-assigned { opacity: .6; }
    .cds-units-section { padding: 8px 16px 12px; }
    .cds-units-lbl { font-size: 10px; color: var(--muted); letter-spacing: .08em; margin-bottom: 6px; }
    .cds-unit-chip { display: inline-block; padding: 3px 8px; border: 1px solid var(--line); font-size: 11px; font-weight: 700; margin: 2px 3px 2px 0; }
    .cds-unit-chip.is-self { border-color: var(--blue); color: var(--blue); }

    /* MAP tab */
    #fieldMapTabEl { flex: 1; min-height: 200px; width: 100%; background: #0a0f17; }

    /* Landscape: bottom nav becomes left sidebar */
    @media (orientation: landscape) and (min-width: 600px) {
      .bottom-nav {
        flex-direction: column;
        width: 68px;
        height: auto;
        border-top: none;
        border-right: 2px solid var(--line);
        padding-bottom: 0;
        order: -1;
      }
      .nav-tab {
        width: 68px;
        min-height: 60px;
        flex: 0 0 auto;
        border-top: none;
        border-left: 3px solid transparent;
      }
      .nav-tab.active { border-top: none; border-left-color: var(--blue); }
      #fieldPanel { flex-direction: row; flex-wrap: nowrap; }
      .field-slim-header { flex-direction: row; width: 100%; flex-shrink: 0; order: 0; }
      .field-tab-shell { flex-direction: row; flex: 1; min-height: 0; }
    }

  </style>
</head>
<body>

<div id="sessionExpiredBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:#7f0000;color:#fff;font-weight:900;font-size:15px;font-family:inherit;padding:12px 16px;align-items:center;justify-content:space-between;letter-spacing:0.05em;">
  <span>⚠ SESSION EXPIRED — TAP TO LOG OUT AND RECONNECT</span>
  <button onclick="cadLogout().then(function(){location.reload();})" style="background:#fff;color:#7f0000;border:none;padding:6px 14px;font-weight:900;font-size:13px;cursor:pointer;font-family:inherit;">LOG OUT</button>
</div>

<div class="app">
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>HOSCAD FIELD</h2>
      <div class="field">
        <div class="field-label">CALLSIGN</div>
        <input id="loginCallsign" type="text" placeholder="ENTER CALLSIGN (E.G. EMS12, CC1)" autocomplete="off" autocorrect="off" autocapitalize="characters" />
      </div>
      <div id="crewPinLoginSection">
      <div class="field">
        <div class="field-label">CREW 1 (REQUIRED)</div>
        <div id="crew1PinRow" style="display:flex;gap:6px;align-items:center;">
          <input id="loginCrew1CadId" type="text" inputmode="numeric" placeholder="CAD ID" autocomplete="off" autocorrect="off" style="width:72px;" maxlength="6" />
          <input id="loginCrew1Pin" type="password" inputmode="numeric" placeholder="PIN" autocomplete="off" style="width:60px;" maxlength="6" />
          <span id="crew1Tag" style="flex:1;font-size:11px;color:#4fa3e0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;"></span>
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-top:4px;">
          <select id="loginCrew1Cert" style="width:100px;font-size:12px;">
            <option value="">CAPABILITY</option>
            <option value="EMT">EMT</option>
            <option value="AEMT">AEMT</option>
            <option value="MEDIC">MEDIC</option>
            <option value="RN">RN</option>
            <option value="OTHER">OTHER</option>
          </select>
          <span style="font-size:10px;color:var(--muted);">AUTO-FILLS FROM CAD ID</span>
        </div>
      </div>
      <div class="field">
        <div class="field-label">CREW 2 (OPTIONAL)</div>
        <div id="crew2PinRow" style="display:flex;gap:6px;align-items:center;">
          <input id="loginCrew2CadId" type="text" inputmode="numeric" placeholder="CAD ID" autocomplete="off" autocorrect="off" style="width:72px;" maxlength="6" />
          <input id="loginCrew2Pin" type="password" inputmode="numeric" placeholder="PIN" autocomplete="off" style="width:60px;" maxlength="6" />
          <span id="crew2Tag" style="flex:1;font-size:11px;color:#4fa3e0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;"></span>
        </div>
        <div style="display:flex;gap:6px;align-items:center;margin-top:4px;">
          <select id="loginCrew2Cert" style="width:100px;font-size:12px;">
            <option value="">CAPABILITY</option>
            <option value="EMT">EMT</option>
            <option value="AEMT">AEMT</option>
            <option value="MEDIC">MEDIC</option>
            <option value="RN">RN</option>
            <option value="OTHER">OTHER</option>
          </select>
          <span style="font-size:10px;color:var(--muted);">AUTO-FILLS FROM CAD ID</span>
        </div>
      </div>
      </div><!-- /crewPinLoginSection -->
      <div class="field">
        <button class="btn-login" id="btnLogin">CONNECT</button>
      </div>
      <div class="login-err" id="loginErr"></div>
      <button class="btn-install" id="btnInstall">INSTALL APP</button>
    </div>
  </div>

  <!-- Field Panel (hidden until login) -->
  <div id="fieldPanel" class="field-panel hidden" style="display:none;flex-direction:column;flex:1;min-height:0;">

    <!-- SLIM PERSISTENT HEADER — always visible after login -->
    <div class="field-slim-header" id="fieldSlimHeader">
      <span class="callsign-label" id="callsignLabel"></span>
      <span class="cad-unit-status cad-status-AV" id="cadUnitStatus">AV</span>
      <span class="offline-indicator" id="offlineIndicator">OFFLINE</span>
      <span id="gpsAutoBadge" style="display:none;font-size:10px;font-weight:700;letter-spacing:.06em;color:#4caf50;padding:2px 5px;border:1px solid #4caf50;">GPS&#9650;</span>
      <span class="pending-badge" id="pendingBadge" style="display:none;"></span>
      <span style="flex:1;"></span>
      <span style="font-size:10px;color:var(--muted);font-weight:700;letter-spacing:.06em;">HOSCAD</span>
    </div>

    <!-- TAB SHELL -->
    <div class="field-tab-shell" style="display:flex;flex-direction:column;flex:1;min-height:0;">

      <!-- ─── TAB: MY CALL ─── -->
      <div id="tabMyCall" class="tab-content active">
        <!-- Alert/Note Banners (referenced by showLogin reset) -->
        <div id="alertBanner" class="field-banner alert" style="display:none;"></div>
        <div id="noteBanner" class="field-banner note" style="display:none;"></div>

        <!-- Unit Location Bar -->
        <div id="fieldLocationBar" style="display:none;padding:4px 16px;background:rgba(30,40,60,0.7);border-bottom:1px solid var(--line);font-size:11px;letter-spacing:.04em;flex-shrink:0;">
          <span style="color:#8b949e;">LOC: </span><span id="fieldLocationText" style="color:#7fb3ff;font-weight:700;"></span>
        </div>

        <!-- INCIDENT DISPLAY PANEL -->
        <div id="incidentPanel" class="incident-panel no-incident">
          <!-- No Incident State -->
          <div id="noIncidentView">
            <div class="no-call-text">NO ACTIVE INCIDENT</div>
            <div class="no-call-status" id="noIncidentStatus">AVAILABLE</div>
          </div>

          <!-- Has Incident State (hidden by default) -->
          <div id="hasIncidentView" style="display:none;">
            <button id="dispatchAckBtn" onclick="ackDispatch()" style="display:none;width:100%;margin-bottom:6px;padding:7px 12px;background:rgba(47,108,255,0.2);border:2px solid #2f6cff;color:#7fb3ff;font-family:inherit;font-size:13px;font-weight:900;letter-spacing:.08em;cursor:pointer;animation:newCallPulse 0.6s ease-out 3;">&#9679; ACK &#8212; TAP TO CONFIRM DISPATCH</button>
            <div class="inc-header" onclick="openIncDetail()" style="cursor:pointer;" title="Tap for details / add note">
              <span class="inc-number" id="incNumber">--</span>
              <span class="inc-priority inc-priority-3" id="incPriority">ROUTINE</span>
              <span class="inc-ma-badge" id="incMaBadge" style="display:none;">MUTUAL AID</span>
              <span class="inc-nature" id="incNature"></span>
              <span style="margin-left:auto;font-size:10px;color:#5ba3e6;font-weight:700;letter-spacing:.04em;white-space:nowrap;">+ NOTE &#8250;</span>
            </div>
            <div id="fieldSceneRow" style="display:none;margin-bottom:8px;">
              <div style="font-size:10px;color:#8b949e;letter-spacing:.05em;margin-bottom:2px;">SCENE ADDRESS</div>
              <div style="display:flex;align-items:center;gap:8px;">
                <span id="fieldSceneAddr" style="font-size:18px;font-weight:900;color:#e6edf3;flex:1;"></span>
                <button id="btnNavScene" onclick="openNavScene()" style="padding:6px 10px;background:#1a3a6a;border:1px solid #2f6cff;color:#7fb3ff;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">&#9654; NAV</button>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <div class="inc-address" id="incAddress" style="flex:1;margin-bottom:0;">--</div>
              <button id="btnNavDest" onclick="openNavDest()" style="padding:6px 10px;background:#1a3a6a;border:1px solid #2f6cff;color:#7fb3ff;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;flex-shrink:0;">&#9654; NAV</button>
            </div>
            <div class="inc-address-detail" id="incCity"></div>
            <div class="inc-address-detail inc-cross" id="incCross"></div>
            <div class="inc-address-detail inc-callback" id="incCallback"></div>
            <div class="inc-address-detail inc-callback" id="incCbFromNote" style="display:none;"></div>
            <div class="inc-notes-container" id="incNotesContainer" style="display:none;">
              <div class="inc-notes-label">DISPATCH NOTES</div>
              <div class="inc-notes-text" id="incNotes"></div>
            </div>
            <div class="inc-times" id="incTimes">
              <div class="inc-time-item"><span class="inc-time-label">DISP:</span><span class="inc-time-value" id="incTimeDisp">--:--</span></div>
              <div class="inc-time-item"><span class="inc-time-label">ENRT:</span><span class="inc-time-value" id="incTimeEnrt">--:--</span></div>
              <div class="inc-time-item"><span class="inc-time-label">OS:</span><span class="inc-time-value" id="incTimeOS">--:--</span></div>
              <div class="inc-time-item" id="incTimeTRow" style="display:none;"><span class="inc-time-label">TRANS:</span><span class="inc-time-value" id="incTimeTrans">--:--</span></div>
              <div class="inc-time-item" id="incTimeTHRow" style="display:none;"><span class="inc-time-label">AT HOSP:</span><span class="inc-time-value" id="incTimeTH">--:--</span></div>
              <div class="inc-time-item" id="incTimeElapsedRow" style="display:none;"><span class="inc-time-label">FOR:</span><span class="inc-time-value" id="incTimeElapsed" style="color:#f0a040;">--</span></div>
            </div>
            <div class="inc-units" id="incUnits"></div>
            <div id="destQuickRow" class="dest-quick-row" style="display:none;"></div>
            <button id="btnHandoff" class="btn-handoff" style="display:none;">PATIENT HANDOFF</button>
          </div>
        </div>

        <!-- NEXT CALL strip -->
        <div id="nextCallPanel" style="display:none;" class="next-call-panel">
          <div class="next-call-hdr">
            <span class="next-call-lbl">&#9654; NEXT CALL</span>
            <span id="nextCallCount" class="next-call-count"></span>
            <button id="nextCallAck" class="next-call-ack-btn" onclick="ackNextCall()">ACK</button>
            <button onclick="switchTab('calls')" style="font-size:9px;padding:2px 8px;background:rgba(47,108,255,.12);border:1px solid rgba(47,108,255,.35);color:#5ba3e6;cursor:pointer;font-family:inherit;font-weight:700;letter-spacing:.04em;flex-shrink:0;">QUEUE &#9654;</button>
          </div>
          <div class="next-call-body">
            <span id="nextCallPri" class="inc-priority"></span>
            <span id="nextCallType" class="next-call-type"></span>
            <span id="nextCallDest" class="next-call-dest"></span>
          </div>
          <div id="nextCallScene" style="display:none;margin-top:2px;padding:0 2px;display:flex;align-items:center;gap:6px;">
            <span id="nextCallSceneText" style="font-size:10px;color:#8b949e;flex:1;"></span>
            <button id="btnNavNextCall" onclick="openNavNextCall()" style="padding:2px 7px;background:#1a3a6a;border:1px solid #2f6cff;color:#7fb3ff;font-family:inherit;font-size:10px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;flex-shrink:0;">NAV</button>
          </div>
          <div id="nextCallNote" style="display:none;font-size:11px;color:#c9d1d9;margin-top:3px;padding:2px 2px;font-style:italic;"></div>
          <div id="nextCallRows"></div>
        </div>
      </div><!-- end #tabMyCall -->

      <!-- ─── TAB: STATUS ─── -->
      <div id="tabStatus" class="tab-content">
        <!-- Primary 2x2 status grid -->
        <div class="field-status-grid">
          <button class="field-status-btn field-status-de" data-status="DE">ENROUTE</button>
          <button class="field-status-btn field-status-os" data-status="OS">ON SCENE</button>
          <button class="field-status-btn field-status-t"  data-status="T">TRANSPORT</button>
          <button class="field-status-btn field-status-av" data-status="AV">AVAILABLE</button>
        </div>
        <!-- Secondary status row -->
        <div class="field-status-secondary">
          <button class="field-status-btn field-status-th" id="fieldTHBtn" data-status="TH">AT HOSP</button>
          <button class="field-status-btn field-status-iq" data-status="IQ">IN QTRS</button>
          <button class="field-status-btn field-status-oos" data-status="OOS">OOS</button>
          <button class="field-status-btn field-status-brk" data-status="BRK">BREAK</button>
          <button class="field-status-btn field-status-loc" id="fieldLocBtn" onclick="toggleFieldLocPanel()">LOC</button>
        </div>
        <!-- LOC input panel -->
        <div id="fieldLocPanel" class="field-loc-panel" style="display:none;">
          <input id="fieldLocInput" placeholder="ADDRESS OR SHORTCODE" autocomplete="off" autocorrect="off" autocapitalize="characters" />
          <button onclick="setFieldLoc()">SET</button>
          <button class="loc-clr-btn" onclick="clearFieldLoc()">CLR</button>
          <button class="loc-close-btn" onclick="closeFieldLocPanel()">&#x2715;</button>
        </div>
        <!-- Command console — primary home after login -->
        <div class="cmd-feed" id="cmdFeed" style="flex:1;max-height:none;">
          <div class="cmd-feed-line"><span class="cmd-sys">HOSCAD FIELD READY. TYPE HELP FOR COMMANDS.</span></div>
        </div>
        <div class="cmd-input-row">
          <input id="cmdInput" placeholder="COMMAND..." maxlength="300" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          <button id="btnCmdSend">SEND</button>
        </div>
        <div class="cmd-phrases-row">
          <button class="cmd-phrase-btn" data-phrase="ON SCENE">ON SCENE</button>
          <button class="cmd-phrase-btn" data-phrase="PATIENT STABLE">PT STABLE</button>
          <button class="cmd-phrase-btn" data-phrase="REQUESTING ADDITIONAL">REQ ADD</button>
          <button class="cmd-phrase-btn" data-phrase="ETA 5 MIN">ETA 5</button>
          <button class="cmd-phrase-btn" data-phrase="ENROUTE">ENROUTE</button>
        </div>
        <div class="cmd-quick-row">
          <button class="cmd-quick-btn" data-cmd="10-4">10-4</button>
          <button class="cmd-quick-btn" data-cmd="WHO">WHO</button>
          <button class="cmd-quick-btn" data-cmd="UR">UR</button>
          <button class="cmd-quick-btn" data-cmd="HOLDING">HOLDING</button>
          <button class="cmd-quick-btn" data-cmd="CLR">CLR</button>
          <button class="cmd-quick-btn" data-cmd="NOTE; ">NOTE</button>
          <button class="cmd-quick-btn" data-cmd="ETA ">ETA</button>
          <button class="cmd-quick-btn" data-cmd="DEST; ">DEST</button>
          <button class="cmd-quick-btn" data-cmd="MSGDP ">MSGDP</button>
          <button class="cmd-quick-btn" data-cmd="REFRESH">REFRESH</button>
          <button class="cmd-quick-btn" onclick="switchTab('map');return false;" style="color:#5ba3e6;">MAP</button>
          <button class="cmd-quick-btn" onclick="fieldGpsUpdateLocation();return false;" style="color:#ffd700;">GPS&#9650;</button>
          <button class="cmd-quick-btn" onclick="openFieldIncHist();return false;" style="color:#a08cff;">INCLOG</button>
        </div>
      </div><!-- end #tabStatus -->

      <!-- ─── TAB: MAP ─── -->
      <div id="tabMap" class="tab-content" style="position:relative;">
        <div id="fieldMapTabEl"></div>
        <div id="fmapTabStatus" style="flex-shrink:0;padding:6px 12px;font-size:10px;color:#8b949e;background:#0d1117;border-top:1px solid #1f2b3d;min-height:24px;"></div>
        <div style="position:absolute;top:8px;right:8px;z-index:1000;">
          <button id="fmapTabNavBtn" onclick="openFieldMapTabNav()" style="display:none;padding:6px 10px;background:rgba(91,163,230,.15);border:1px solid rgba(91,163,230,.35);color:#5ba3e6;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;">OPEN IN MAPS</button>
        </div>
      </div><!-- end #tabMap -->

      <!-- ─── TAB: CALLS ─── -->
      <div id="tabCalls" class="tab-content">
        <div style="padding:8px 12px;font-size:10px;color:var(--muted);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;background:var(--bg);">
          <span style="font-weight:900;letter-spacing:.08em;">INCIDENTS</span>
          <span id="callsQueueCount" style="color:var(--text);font-weight:700;"></span>
        </div>
        <div id="callsContent" style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;">
          <div style="color:var(--muted);text-align:center;padding:36px 16px;font-size:12px;line-height:1.8;">WAITING FOR DATA...</div>
        </div>
      </div><!-- end #tabCalls -->

      <!-- ─── TAB: ROSTER ─── -->
      <div id="tabRoster" class="tab-content">
        <div style="padding:8px 12px;font-size:10px;color:var(--muted);border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
          <span style="font-weight:900;letter-spacing:.08em;">ACTIVE UNITS</span>
          <span id="rosterUnitCount" style="color:var(--text);font-weight:700;"></span>
        </div>
        <div id="rosterContent" style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;">
          <div style="color:var(--muted);text-align:center;padding:24px;font-size:12px;">WAITING FOR DATA...</div>
        </div>
      </div><!-- end #tabRoster -->

      <!-- ─── TAB: MORE ─── -->
      <div id="tabMore" class="tab-content">
        <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;">
          <!-- Unit identity -->
          <div style="padding:12px 16px;border-bottom:2px solid var(--line);background:var(--panel2);flex-shrink:0;">
            <div style="font-size:10px;color:var(--muted);letter-spacing:.08em;margin-bottom:4px;">LOGGED IN AS</div>
            <div id="moreCallsignLabel" style="font-size:20px;font-weight:900;color:var(--green);"></div>
            <div id="moreUnitInfo" style="font-size:11px;color:var(--muted);margin-top:2px;"></div>
          </div>

          <!-- DISPLAY controls -->
          <div class="more-section-label">DISPLAY</div>
          <button class="more-row" id="moreWakeBtn" onclick="toggleWakeLock()">
            <div><div class="more-row-label">WAKE LOCK</div><div class="more-row-sub">KEEP SCREEN ON + ENABLE ALERTS</div></div>
            <span class="more-row-arrow" id="moreWakeStatus">OFF</span>
          </button>
          <button class="more-row" id="moreNightBtn" onclick="toggleNightMode()">
            <div><div class="more-row-label">NIGHT MODE</div><div class="more-row-sub">REDUCE BRIGHTNESS</div></div>
            <span class="more-row-arrow" id="moreNightStatus">AUTO</span>
          </button>
          <button class="more-row" id="moreRefreshBtn" onclick="(function(btn){btn.style.color='var(--green)';btn.disabled=true;feedSys('REFRESHING...');pollOnce().then(function(){feedSys('REFRESH COMPLETE.');btn.style.color='';btn.disabled=false;}).catch(function(){btn.style.color='';btn.disabled=false;});})(this)">
            <div><div class="more-row-label">REFRESH</div><div class="more-row-sub">FORCE POLL NOW</div></div>
            <span class="more-row-arrow">&#8635;</span>
          </button>

          <!-- TOOLS -->
          <div class="more-section-label">TOOLS</div>
          <button class="more-row" onclick="showInfoOverlay()">
            <div>
              <div class="more-row-label">HOSPITAL REFERENCE
                <span id="fieldMsgBadge" style="display:none;background:#2f6cff;color:#fff;border-radius:10px;font-size:10px;font-weight:900;padding:1px 6px;margin-left:6px;vertical-align:middle;">0</span>
              </div>
              <div class="more-row-sub">FACILITIES, CAPABILITIES, DESTINATIONS</div>
            </div>
            <span class="more-row-arrow">&#9654;</span>
          </button>
          <button class="more-row" onclick="openFieldIncHist()">
            <div><div class="more-row-label">INCIDENT LOG</div><div class="more-row-sub">YOUR RECENT CALLS</div></div>
            <span class="more-row-arrow">&#9654;</span>
          </button>
          <button class="more-row" onclick="fieldGpsUpdateLocation()">
            <div><div class="more-row-label">GPS UPDATE</div><div class="more-row-sub">SEND LOCATION TO BOARD NOW</div></div>
            <span class="more-row-arrow">&#9654;</span>
          </button>

          <!-- ACCOUNT -->
          <div class="more-section-label">ACCOUNT</div>
          <button class="more-row" onclick="openPinChangeDialog()">
            <div><div class="more-row-label">CHANGE PIN</div><div class="more-row-sub">UPDATE YOUR CAD PIN</div></div>
            <span class="more-row-arrow">&#9654;</span>
          </button>
          <button class="more-row" onclick="openFieldBugReport()">
            <div><div class="more-row-label" style="color:#e09000;">REPORT ISSUE</div><div class="more-row-sub">SUBMIT BUG REPORT</div></div>
            <span class="more-row-arrow">&#9654;</span>
          </button>
          <button class="more-row" id="btnLogout">
            <div><div class="more-row-label" style="color:var(--red);">LOG OUT</div><div class="more-row-sub">END SESSION</div></div>
            <span class="more-row-arrow" style="color:var(--red);">&#9654;</span>
          </button>

          <!-- COMMAND CONSOLE — now lives on STATUS tab -->
          <div class="more-section-label">COMMAND CONSOLE</div>
          <button class="more-row" onclick="switchTab('status')">
            <div><div class="more-row-label">OPEN CONSOLE</div><div class="more-row-sub">FEED + INPUT ON STATUS TAB</div></div>
            <span class="more-row-arrow">&#9654;</span>
          </button>
        </div><!-- end inner scroll div -->
      </div><!-- end #tabMore -->

      <!-- BOTTOM NAV BAR (hidden until login) -->
      <nav class="bottom-nav" id="bottomNav">
        <button class="nav-tab active" id="navMyCall" onclick="switchTab('mycall')">
          <span class="nav-tab-icon">&#128222;</span>
          <span>MY CALL</span>
        </button>
        <button class="nav-tab" id="navStatus" onclick="switchTab('status')">
          <span class="nav-tab-icon">&#9654;</span>
          <span>STATUS</span>
        </button>
        <button class="nav-tab" id="navMap" onclick="switchTab('map')">
          <span class="nav-tab-icon">&#9974;</span>
          <span>MAP</span>
        </button>
        <button class="nav-tab" id="navCalls" onclick="switchTab('calls')">
          <span class="nav-tab-badge" id="callsTabBadge"></span>
          <span class="nav-tab-icon">&#128680;</span>
          <span>CALLS</span>
        </button>
        <button class="nav-tab" id="navRoster" onclick="switchTab('roster')">
          <span class="nav-tab-icon">&#9776;</span>
          <span>ROSTER</span>
        </button>
        <button class="nav-tab" id="navMore" onclick="switchTab('more')">
          <span class="nav-tab-badge" id="moreTabBadge"></span>
          <span class="nav-tab-icon">&#8943;</span>
          <span>MORE</span>
        </button>
      </nav>

    </div><!-- end .field-tab-shell -->
  </div><!-- end #fieldPanel -->
</div>

<!-- Call Detail Sheet backdrop -->
<div id="callDetailBackdrop" onclick="closeCallDetail()"></div>

<!-- Call Detail Sheet (slide-up panel) -->
<div id="callDetailSheet">
  <div class="cds-header">
    <span class="cds-title" id="cdsTitle">INCIDENT</span>
    <button class="cds-close" onclick="closeCallDetail()">&#x2715;</button>
  </div>
  <div id="cdsFields"><!-- populated by openCallDetail() --></div>
</div>

<!-- Confirm Dialog -->
<div id="confirmOverlay" class="confirm-overlay">
  <div class="confirm-box">
    <div class="confirm-title" id="confirmTitle">CONFIRM</div>
    <div class="confirm-message" id="confirmMessage"></div>
    <div class="confirm-buttons">
      <button class="btn-confirm-yes" id="confirmYes">YES</button>
      <button class="btn-confirm-no" id="confirmNo">CANCEL</button>
    </div>
  </div>
</div>

<!-- Clear Note overlay — optional note before going AV or patient handoff -->
<div id="clearNoteOverlay" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.85);align-items:center;justify-content:center;">
  <div style="background:#0d1117;border:2px solid #1a3a5c;padding:24px;min-width:280px;max-width:90vw;">
    <div style="font-size:14px;font-weight:900;margin-bottom:4px;letter-spacing:.06em;color:#e6edf3;" id="clearNoteTitle">CLEARING FROM CALL</div>
    <div style="font-size:11px;color:#8b949e;margin-bottom:12px;">OPTIONAL NOTE — LEAVE BLANK TO SKIP</div>
    <input id="clearNoteInput" type="text" autocomplete="off"
      style="width:100%;box-sizing:border-box;padding:10px 8px;background:#0a1628;border:2px solid #1a3a5c;color:#e6edf3;font-family:inherit;font-size:14px;font-weight:700;text-transform:uppercase;outline:none;"
      placeholder="E.G. PT STABLE, NO TRANSPORT..." />
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="btnClearNoteConfirm" style="flex:1;padding:12px;background:#1a3a5c;border:none;color:#5ba3e6;font-family:inherit;font-size:13px;font-weight:900;cursor:pointer;text-transform:uppercase;">CLEAR</button>
      <button id="btnClearNoteSkip" style="flex:1;padding:12px;background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase;">NO NOTE</button>
      <button id="btnClearNoteCancel" style="padding:12px;background:transparent;border:1px solid #c0392b;color:#ff6b6b;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase;">CANCEL</button>
    </div>
  </div>
</div>

<!-- Delete Incident overlay — reason picker for DEL command -->
<div id="delReasonOverlay" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.85);align-items:center;justify-content:center;">
  <div style="background:#0d1117;border:2px solid #c0392b;padding:24px;min-width:280px;max-width:90vw;">
    <div style="font-size:14px;font-weight:900;margin-bottom:4px;letter-spacing:.06em;color:#e6edf3;">DELETE INCIDENT</div>
    <div style="font-size:12px;color:#8b949e;margin-bottom:4px;" id="delReasonIncLabel"></div>
    <div style="font-size:10px;font-weight:700;color:#ffd700;margin-bottom:14px;">INCIDENT REMAINS AUDITABLE — SELECT REASON</div>
    <div style="display:flex;gap:8px;flex-direction:column;">
      <button id="btnDelDup" style="padding:12px;background:rgba(255,170,0,.1);border:2px solid rgba(255,170,0,.4);color:#ffd700;font-family:inherit;font-size:13px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:.05em;">DUPLICATE CALL (DUP)</button>
      <button id="btnDelErr" style="padding:12px;background:rgba(255,107,107,.1);border:2px solid rgba(255,107,107,.4);color:#ff6b6b;font-family:inherit;font-size:13px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:.05em;">DATA ENTRY ERROR (ERR)</button>
      <button id="btnDelCancel" style="padding:10px;background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase;">CANCEL</button>
    </div>
  </div>
</div>

<!-- Hospital Quick Reference Overlay -->
<div id="infoOverlay" class="info-overlay" style="display:none;">
  <div class="info-overlay-header">
    <span class="info-overlay-title">HOSPITAL REFERENCE</span>
    <button id="btnInfoClose" style="background:#2a1212;border:2px solid #5b2727;color:#ff6b6b;padding:8px 16px;font-family:inherit;font-size:12px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:.05em;">CLOSE</button>
  </div>
  <div id="infoCards" class="info-overlay-body"></div>
</div>

<!-- Transport destination overlay (shown on T status) -->
<div id="transportOverlay" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.85);align-items:center;justify-content:center;">
  <div style="background:#0d1117;border:2px solid #1a3a5c;padding:24px;min-width:280px;max-width:90vw;">
    <div style="font-size:14px;font-weight:900;margin-bottom:4px;letter-spacing:.06em;color:#e6edf3;">TRANSPORTING TO:</div>
    <div style="font-size:11px;color:#8b949e;margin-bottom:12px;" id="transportDismissLabel">TAP QUICK PICK OR TYPE DESTINATION</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;" id="transportQuickPicks"></div>
    <input id="transportDestInput" type="text" autocomplete="off"
      style="width:100%;box-sizing:border-box;padding:10px 8px;background:#0a1628;border:2px solid #1a3a5c;color:#e6edf3;font-family:inherit;font-size:14px;font-weight:700;text-transform:uppercase;outline:none;"
      placeholder="ENTER DESTINATION..." />
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="btnTransportConfirm" style="flex:1;padding:12px;background:#1a3a5c;border:none;color:#5ba3e6;font-family:inherit;font-size:13px;font-weight:900;cursor:pointer;text-transform:uppercase;">CONFIRM</button>
      <button id="btnTransportSkip" style="flex:1;padding:12px;background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase;">SKIP</button>
    </div>
  </div>
</div>

<!-- mustChangePassword warning overlay (non-blocking, once per session) -->
<div id="mustChangePwOverlay" style="display:none;position:fixed;inset:0;z-index:9800;background:rgba(0,0,0,.75);align-items:center;justify-content:center;">
  <div style="background:#0d1117;border:2px solid #c0392b;padding:24px;max-width:340px;width:90vw;">
    <div style="font-size:13px;font-weight:900;letter-spacing:.06em;color:#e05050;margin-bottom:10px;">&#9888; PASSWORD CHANGE REQUIRED</div>
    <div style="font-size:12px;color:#cdd9e5;line-height:1.5;margin-bottom:16px;">YOUR PASSWORD MUST BE CHANGED.<br>LOG IN TO THE DISPATCHER BOARD TO SET A NEW PASSWORD.</div>
    <button onclick="document.getElementById('mustChangePwOverlay').style.display='none';" style="width:100%;padding:10px;background:rgba(192,57,43,.2);border:1px solid #c0392b;color:#e05050;font-family:inherit;font-size:12px;font-weight:900;cursor:pointer;text-transform:uppercase;letter-spacing:.06em;">CLOSE</button>
  </div>
</div>

<!-- Field Map Overlay -->
<div id="fieldMapOverlay" style="display:none;position:fixed;inset:0;z-index:9400;background:#0d1117;flex-direction:column;">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:max(10px,env(safe-area-inset-top)) 16px 10px;background:#0d1117;border-bottom:1px solid #1f2b3d;flex-shrink:0;">
    <div>
      <span style="font-size:13px;font-weight:900;letter-spacing:.06em;color:#e6edf3;">INCIDENT MAP</span>
      <span id="fmapIncLabel" style="font-size:11px;color:#8b949e;margin-left:8px;"></span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button id="fmapNavBtn" onclick="openFieldMapNav()" style="display:none;padding:4px 10px;background:rgba(91,163,230,.15);border:1px solid rgba(91,163,230,.35);color:#5ba3e6;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;min-height:36px;">OPEN IN MAPS</button>
      <button onclick="closeFieldMap()" style="background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;padding:4px 10px;cursor:pointer;min-height:36px;">✕ CLOSE</button>
    </div>
  </div>
  <div id="fieldMapEl" style="flex:1;min-height:0;"></div>
  <div id="fmapStatus" style="flex-shrink:0;padding:6px 12px;font-size:10px;color:#8b949e;background:#0d1117;border-top:1px solid #1f2b3d;min-height:28px;"></div>
</div>

<!-- Field Incident History Overlay -->
<div id="fieldIncHistOverlay" style="display:none;position:fixed;inset:0;z-index:9400;background:#0d1117;flex-direction:column;">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:max(10px,env(safe-area-inset-top)) 16px 10px;background:#0d1117;border-bottom:1px solid #1f2b3d;flex-shrink:0;">
    <span style="font-size:13px;font-weight:900;letter-spacing:.06em;color:#e6edf3;">INCIDENT LOG</span>
    <button onclick="closeFieldIncHist()" style="background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;padding:4px 10px;cursor:pointer;min-height:36px;">✕ CLOSE</button>
  </div>
  <div id="fieldIncHistContent" style="flex:1;overflow-y:auto;padding:12px;"></div>
</div>

<!-- Field Incident Note Modal -->
<div id="fieldIncNoteModal" style="display:none;position:fixed;inset:0;z-index:9450;background:rgba(0,0,0,.75);align-items:flex-end;justify-content:center;">
  <div style="background:#0d1117;border-top:2px solid #1a3a5c;width:100%;padding:0 0 env(safe-area-inset-bottom,8px);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;border-bottom:1px solid #1f2b3d;">
      <span id="finmTitle" style="font-size:13px;font-weight:900;letter-spacing:.06em;color:#e6edf3;">ADD NOTE</span>
      <button onclick="closeFieldIncNote()" style="background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;padding:4px 10px;cursor:pointer;min-height:36px;">✕</button>
    </div>
    <div style="padding:14px 16px 0;">
      <textarea id="finmText" placeholder="ENTER NOTE (E.G. PATIENT STABLE, ETA 10 MIN)..."
        style="width:100%;box-sizing:border-box;min-height:90px;background:#0a0f17;border:1px solid #1f2b3d;color:#e6edf3;font-family:inherit;font-size:13px;padding:10px;resize:none;text-transform:uppercase;border-radius:2px;"
        autocorrect="off" autocapitalize="characters"></textarea>
      <div id="finmStatus" style="font-size:11px;color:#ff6b6b;min-height:16px;margin-top:4px;"></div>
      <div style="display:flex;gap:8px;margin-top:10px;margin-bottom:8px;">
        <button onclick="submitFieldIncNote()" style="flex:1;padding:14px;background:#0f3a1a;border:1px solid #2aaa5a;color:#7fffb2;font-family:inherit;font-size:13px;font-weight:900;cursor:pointer;letter-spacing:.05em;min-height:48px;">SUBMIT NOTE</button>
        <button onclick="closeFieldIncNote()" style="padding:14px 18px;background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;min-height:48px;">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<!-- Bug Report Modal (field) -->
<div id="fieldBugModal" style="display:none;position:fixed;inset:0;z-index:9600;background:rgba(0,0,0,.82);align-items:flex-end;justify-content:center;">
  <div style="background:#0d1117;border-top:2px solid #1a3a5c;width:100%;max-height:85vh;overflow-y:auto;padding:0 0 env(safe-area-inset-bottom,8px);">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;border-bottom:1px solid #1f2b3d;position:sticky;top:0;background:#0d1117;z-index:1;">
      <span style="font-size:14px;font-weight:900;letter-spacing:.06em;color:#e6edf3;">REPORT ISSUE</span>
      <button onclick="closeFieldBugReport()" style="background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;padding:4px 10px;cursor:pointer;min-height:40px;">✕ CLOSE</button>
    </div>
    <div style="padding:14px 16px 0;">
      <div style="font-size:10px;color:#8b949e;margin-bottom:10px;">REPORTER: <span id="fbReporterLabel" style="color:#e6edf3;"></span> &nbsp;|&nbsp; PAGE: FIELD &nbsp;|&nbsp; <span id="fbTimeLabel" style="color:#e6edf3;"></span></div>
      <div style="font-size:10px;color:#8b949e;margin-bottom:4px;">SEVERITY</div>
      <select id="fbSeverity" style="width:100%;margin-bottom:12px;min-height:44px;font-size:13px;background:#0a0f17;border:1px solid #1f2b3d;color:#e6edf3;font-family:inherit;">
        <option value="LOW">LOW — Minor / cosmetic</option>
        <option value="MED" selected>MED — Functional problem</option>
        <option value="HIGH">HIGH — Critical / blocking</option>
      </select>
      <div style="font-size:10px;color:#8b949e;margin-bottom:4px;">DESCRIPTION</div>
      <textarea id="fbDescription"
        style="width:100%;box-sizing:border-box;min-height:90px;background:#0a0f17;border:1px solid #1f2b3d;color:#e6edf3;font-family:inherit;font-size:13px;padding:10px;resize:vertical;text-transform:uppercase;"
        placeholder="DESCRIBE THE ISSUE..." autocorrect="off" autocapitalize="characters"></textarea>
      <details style="margin-top:8px;">
        <summary style="font-size:10px;color:#6e7681;cursor:pointer;user-select:none;letter-spacing:.05em;">AUTO-CAPTURED CONTEXT (SENT WITH REPORT)</summary>
        <pre id="fbContextPreview" style="margin:4px 0 0;padding:6px 8px;background:#0a0f17;border:1px solid #1f2b3d;font-size:10px;color:#6e7681;white-space:pre-wrap;word-break:break-all;font-family:monospace;"></pre>
      </details>
      <div id="fbStatus" style="font-size:11px;color:#ff6b6b;margin-top:6px;min-height:16px;"></div>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button onclick="submitFieldBugReport()" style="flex:1;padding:14px;background:#0f3a1a;border:1px solid #2aaa5a;color:#7fffb2;font-family:inherit;font-size:13px;font-weight:900;cursor:pointer;letter-spacing:.05em;min-height:48px;">SUBMIT</button>
        <button onclick="closeFieldBugReport()" style="padding:14px 18px;background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;min-height:48px;">CANCEL</button>
      </div>
    </div>
  </div>
</div>

<!-- Incident Detail Modal -->
<div id="incDetailModal" style="display:none;position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,.7);align-items:flex-end;justify-content:center;">
  <div id="incDetailSheet" style="background:#0d1117;border-top:2px solid #1a3a5c;width:100%;max-height:90vh;overflow-y:auto;padding:0 0 24px;">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px 10px;border-bottom:1px solid #1f2b3d;position:sticky;top:0;background:#0d1117;z-index:1;">
      <div>
        <span id="idmIncNum" style="font-size:16px;font-weight:900;letter-spacing:.06em;color:#e6edf3;"></span>
        <span id="idmPriority" style="margin-left:8px;font-size:10px;font-weight:700;padding:2px 6px;border-radius:2px;background:#2a1400;color:#ffd66b;letter-spacing:.04em;"></span>
      </div>
      <button onclick="closeIncDetail()" style="background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:12px;font-weight:700;padding:4px 10px;cursor:pointer;letter-spacing:.04em;">✕ CLOSE</button>
    </div>
    <!-- Details -->
    <div style="padding:12px 16px 0;">
      <div id="idmSceneRow" style="display:none;margin-bottom:10px;">
        <div style="font-size:10px;color:#8b949e;letter-spacing:.05em;margin-bottom:2px;">SCENE ADDRESS</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span id="idmScene" style="font-size:15px;font-weight:900;color:#e6edf3;flex:1;"></span>
          <button onclick="openNavScene()" style="padding:5px 9px;background:#1a3a6a;border:1px solid #2f6cff;color:#7fb3ff;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">&#9654; NAV</button>
        </div>
      </div>
      <div id="idmDestRow" style="display:none;margin-bottom:10px;">
        <div style="font-size:10px;color:#8b949e;letter-spacing:.05em;margin-bottom:2px;">DESTINATION</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span id="idmDest" style="font-size:14px;font-weight:700;color:#7fffb2;flex:1;"></span>
          <button onclick="openNavDest()" style="padding:5px 9px;background:#1a3a6a;border:1px solid #2f6cff;color:#7fb3ff;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">&#9654; NAV</button>
        </div>
      </div>
      <div style="display:flex;gap:16px;margin-bottom:10px;flex-wrap:wrap;">
        <div><div style="font-size:10px;color:#8b949e;letter-spacing:.05em;">TYPE</div><div id="idmType" style="font-size:12px;font-weight:700;color:#e6edf3;"></div></div>
        <div><div style="font-size:10px;color:#8b949e;letter-spacing:.05em;">UNITS</div><div id="idmUnits" style="font-size:12px;font-weight:700;color:#e6edf3;"></div></div>
      </div>
      <div style="display:flex;gap:16px;margin-bottom:12px;flex-wrap:wrap;">
        <div><div style="font-size:10px;color:#8b949e;letter-spacing:.05em;">DISP</div><div id="idmTimeDisp" style="font-size:12px;font-family:monospace;color:#e6edf3;">--:--</div></div>
        <div><div style="font-size:10px;color:#8b949e;letter-spacing:.05em;">ENRT</div><div id="idmTimeEnrt" style="font-size:12px;font-family:monospace;color:#e6edf3;">--:--</div></div>
        <div><div style="font-size:10px;color:#8b949e;letter-spacing:.05em;">ON SCN</div><div id="idmTimeOS" style="font-size:12px;font-family:monospace;color:#e6edf3;">--:--</div></div>
        <div><div style="font-size:10px;color:#8b949e;letter-spacing:.05em;">TRANS</div><div id="idmTimeTrans" style="font-size:12px;font-family:monospace;color:#e6edf3;">--:--</div></div>
        <div id="idmAtHospRow" style="display:none;"><div style="font-size:10px;color:#00cccc;letter-spacing:.05em;">AT HOSP</div><div id="idmTimeAtHosp" style="font-size:12px;font-family:monospace;color:#00cccc;">--:--</div></div>
      </div>
      <!-- Current note -->
      <div id="idmCurrentNoteRow" style="display:none;margin-bottom:12px;">
        <div style="font-size:10px;color:#8b949e;letter-spacing:.05em;margin-bottom:4px;">CURRENT NOTE</div>
        <div id="idmCurrentNote" style="font-size:12px;color:#e6edf3;background:#0a0f17;border:1px solid #1f2b3d;padding:8px;border-radius:2px;white-space:pre-wrap;"></div>
      </div>
      <!-- Add note -->
      <div style="margin-bottom:10px;">
        <div style="font-size:10px;color:#8b949e;letter-spacing:.05em;margin-bottom:6px;">ADD NOTE</div>
        <!-- Quick-tap note buttons -->
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;">
          <button onclick="appendFieldNote('PT STABLE')" style="padding:7px 10px;background:#0a1a0a;border:1px solid #2aaa5a44;color:#7fffb2;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">PT STABLE</button>
          <button onclick="appendFieldNote('PT CRITICAL')" style="padding:7px 10px;background:#1a0a0a;border:1px solid #cc222244;color:#ff8888;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">PT CRITICAL</button>
          <button onclick="appendFieldNote('ON SCENE')" style="padding:7px 10px;background:#0a120a;border:1px solid #2aaa5a44;color:#7fffb2;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">ON SCENE</button>
          <button onclick="appendFieldNote('TRANSPORT CONFIRMED')" style="padding:7px 10px;background:#0a0a1a;border:1px solid #7b57ff44;color:#a888ff;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">TRANSPORT CONFIRMED</button>
          <button onclick="appendFieldNote('DECLINED TRANSPORT')" style="padding:7px 10px;background:#1a1000;border:1px solid #ffd66b44;color:#ffd66b;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">DECLINED TX</button>
          <button onclick="appendFieldNote('CLEAR')" style="padding:7px 10px;background:#0a0f17;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">CLEAR</button>
          <button onclick="appendFieldNote('BLS ASSESSMENT COMPLETE')" style="padding:7px 10px;background:#0a0f17;border:1px solid #30363d;color:#c9d1d9;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">BLS DONE</button>
          <button onclick="appendFieldNote('ALS ASSESSMENT COMPLETE')" style="padding:7px 10px;background:#0a0f17;border:1px solid #30363d;color:#c9d1d9;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">ALS DONE</button>
          <button onclick="appendFieldNote('VITALS OBTAINED')" style="padding:7px 10px;background:#0a0f17;border:1px solid #30363d;color:#c9d1d9;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">VITALS</button>
          <button onclick="appendFieldNote('IV ACCESS ESTABLISHED')" style="padding:7px 10px;background:#0a0f17;border:1px solid #30363d;color:#c9d1d9;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">IV ACCESS</button>
          <button onclick="appendFieldNote('AIRWAY SECURED')" style="padding:7px 10px;background:#0a0f17;border:1px solid #30363d;color:#c9d1d9;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">AIRWAY</button>
          <button onclick="appendFieldNote('NARCAN ADMINISTERED')" style="padding:7px 10px;background:#0a0f17;border:1px solid #30363d;color:#c9d1d9;font-family:inherit;font-size:11px;font-weight:700;cursor:pointer;border-radius:2px;white-space:nowrap;">NARCAN</button>
        </div>
        <textarea id="idmNoteInput" style="width:100%;box-sizing:border-box;background:#0a0f17;border:1px solid #1f2b3d;color:#e6edf3;font-family:inherit;font-size:13px;padding:10px;min-height:80px;resize:vertical;text-transform:uppercase;" placeholder="E.G. PATIENT STABLE. GCS 15. VITALS WNL." autocorrect="off" autocapitalize="characters"></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:16px;">
        <button onclick="saveFieldIncNote()" id="idmSaveBtn" style="flex:1;padding:12px;background:#0f3a1a;border:1px solid #2aaa5a;color:#7fffb2;font-family:inherit;font-size:13px;font-weight:900;cursor:pointer;letter-spacing:.05em;">SAVE NOTE</button>
        <button onclick="closeIncDetail()" style="padding:12px 16px;background:transparent;border:1px solid #30363d;color:#8b949e;font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;">CANCEL</button>
      </div>
      <!-- Incident history -->
      <div style="border-top:1px solid #1f2b3d;padding-top:10px;">
        <div style="font-size:10px;color:#8b949e;letter-spacing:.05em;margin-bottom:6px;">INCIDENT HISTORY</div>
        <div id="idmAudit" style="font-size:11px;color:#8b949e;font-family:monospace;"></div>
      </div>
    </div>
  </div>
</div>

<script src="../api.js"></script>

<script>
(function() {
  const loginScreen = document.getElementById('loginScreen');
  const fieldPanel = document.getElementById('fieldPanel');
  const loginErr = document.getElementById('loginErr');
  const callsignLabel = document.getElementById('callsignLabel');
  const cadUnitStatus = document.getElementById('cadUnitStatus');
  const cmdFeed = document.getElementById('cmdFeed');
  const cmdInput = document.getElementById('cmdInput');
  const offlineIndicator = document.getElementById('offlineIndicator');

  // ════════════════════════════════════════════════════════════════════════════
  // PHASE 1: TAB NAVIGATION STATE
  // ════════════════════════════════════════════════════════════════════════════
  var _activeTab = 'mycall';
  var _mapTabInitialized = false;
  var _fieldMapTabObj = null;
  var _fieldMapTabLayers = [];
  var _fmapTabNavUrl = null;
  var _tabStatusFeedEl = null; // removed — console now lives directly on STATUS tab

  var TAB_MAP = {
    'mycall': { content: 'tabMyCall',  nav: 'navMyCall'  },
    'status': { content: 'tabStatus', nav: 'navStatus' },
    'map':    { content: 'tabMap',    nav: 'navMap'    },
    'calls':  { content: 'tabCalls',  nav: 'navCalls'  },
    'roster': { content: 'tabRoster', nav: 'navRoster' },
    'more':   { content: 'tabMore',   nav: 'navMore'   }
  };

  function switchTab(tabId) {
    if (!TAB_MAP[tabId]) return;
    Object.keys(TAB_MAP).forEach(function(id) {
      var el = document.getElementById(TAB_MAP[id].content);
      if (el) el.classList.remove('active');
      var nav = document.getElementById(TAB_MAP[id].nav);
      if (nav) nav.classList.remove('active');
    });
    var target = document.getElementById(TAB_MAP[tabId].content);
    if (target) target.classList.add('active');
    var navBtn = document.getElementById(TAB_MAP[tabId].nav);
    if (navBtn) navBtn.classList.add('active');
    _activeTab = tabId;

    if (tabId === 'map') {
      if (!_mapTabInitialized) {
        _mapTabInitialized = true;
        _loadLeaflet(function() { _renderFieldMapTab(); });
      } else if (_fieldMapTabObj) {
        setTimeout(function() { _fieldMapTabObj.invalidateSize(); }, 50);
      }
    }
    if (tabId === 'roster') _renderRosterTab();
    if (tabId === 'calls')  { _renderCallsTab(); _clearCallsBadge(); }
    if (tabId === 'more')   _updateMoreTab();
    if (tabId === 'status') { _unreadMessages = 0; updateMsgBadge(); }

    try { localStorage.setItem('hoscadfield_tab', tabId); } catch(e) {}
  }

  function _autoSwitchOnDispatch() {
    if (_activeTab !== 'mycall') switchTab('mycall');
  }

  function _renderRosterTab() {
    var content = document.getElementById('rosterContent');
    var countEl = document.getElementById('rosterUnitCount');
    if (!content) return;
    if (!_lastState || !_lastState.units) {
      content.innerHTML = '<div style="color:var(--muted);text-align:center;padding:24px;font-size:12px;">NO DATA &#8212; WAITING FOR POLL</div>';
      return;
    }
    var activeUnits = (_lastState.units || []).filter(function(u) { return u.active; });
    if (countEl) countEl.textContent = activeUnits.length;
    if (!activeUnits.length) {
      content.innerHTML = '<div style="color:var(--muted);text-align:center;padding:24px;font-size:12px;">NO ACTIVE UNITS</div>';
      return;
    }
    var STATUS_SORT = { D:0, DE:1, OS:2, T:3, TH:4, AV:5, IQ:6, BRK:7, OOS:8, UV:9 };
    activeUnits.sort(function(a, b) {
      if (a.unit_id === _cadCallsign) return -1;
      if (b.unit_id === _cadCallsign) return 1;
      var sa = STATUS_SORT[a.status] !== undefined ? STATUS_SORT[a.status] : 99;
      var sb = STATUS_SORT[b.status] !== undefined ? STATUS_SORT[b.status] : 99;
      if (sa !== sb) return sa - sb;
      return (a.unit_id || '').localeCompare(b.unit_id || '');
    });
    var html = activeUnits.map(function(u) {
      var isSelf = u.unit_id === _cadCallsign;
      var incText = u.incident ? ('INC ' + String(u.incident).replace(/^[A-Z]*\d{2}-0*/, '')) : '';
      var noteText = (u.note && !incText) ? u.note : '';
      var statusClass = 'cad-status-' + (u.status || 'UV');
      return '<div class="roster-unit-row" style="' + (isSelf ? 'background:rgba(47,108,255,0.07);' : '') + '">' +
        '<span class="roster-unit-id">' + esc(u.unit_id) + (isSelf ? ' &#9654;' : '') + '</span>' +
        '<span class="roster-unit-status ' + statusClass + '">' + esc(u.status || '?') + '</span>' +
        '<span class="roster-unit-inc">' + esc(incText) + '</span>' +
        '<span class="roster-unit-note">' + esc(noteText) + '</span>' +
        '</div>';
    }).join('');
    content.innerHTML = html;
  }

  // ── CALLS TAB ──────────────────────────────────────────────────────────────

  function _renderCallsTab() {
    var content = document.getElementById('callsContent');
    var countEl = document.getElementById('callsQueueCount');
    if (!content) return;
    var allIncs = (_lastState && _lastState.incidents) || [];
    // Show all active/queued incidents — unassigned first, then assigned
    var active = allIncs.filter(function(i) {
      return i.status === 'ACTIVE' || i.status === 'QUEUED';
    });
    // Sort: unassigned first, then self-assigned, then others; within group by incident_id desc
    active.sort(function(a, b) {
      var aUnits = Array.isArray(a.units) ? a.units : (a.units ? String(a.units).split(',').map(function(s){return s.trim();}).filter(Boolean) : []);
      var bUnits = Array.isArray(b.units) ? b.units : (b.units ? String(b.units).split(',').map(function(s){return s.trim();}).filter(Boolean) : []);
      var aHas = aUnits.length > 0, bHas = bUnits.length > 0;
      if (aHas !== bHas) return aHas ? 1 : -1; // unassigned first
      return String(b.incident_id).localeCompare(String(a.incident_id)); // newest first within group
    });
    var unassignedCount = active.filter(function(i) {
      var u = Array.isArray(i.units) ? i.units : (i.units ? String(i.units).split(',').map(function(s){return s.trim();}).filter(Boolean) : []);
      return u.length === 0;
    }).length;
    if (countEl) countEl.textContent = active.length ? (active.length + ' ACTIVE' + (unassignedCount ? ' / ' + unassignedCount + ' OPEN' : '')) : 'NONE';
    if (!active.length) {
      content.innerHTML = '<div style="color:var(--muted);text-align:center;padding:36px 16px;font-size:12px;line-height:1.8;">NO ACTIVE INCIDENTS<br><span style="font-size:10px;opacity:.6;">ACTIVE AND QUEUED CALLS APPEAR HERE</span></div>';
      return;
    }
    var html = active.map(function(inc) {
      var pri = (inc.priority || '').toUpperCase();
      var priClass = '';
      if (pri === 'PRI-1' || pri === 'CRITICAL') priClass = 'inc-priority-1';
      else if (pri === 'PRI-2') priClass = 'inc-priority-2';
      else if (pri === 'PRI-3') priClass = 'inc-priority-3';
      else if (pri === 'PRI-4') priClass = 'inc-priority-4';
      var units = Array.isArray(inc.units) ? inc.units : (inc.units ? String(inc.units).split(',').map(function(s){return s.trim();}).filter(Boolean) : []);
      var shortId = String(inc.incident_id).replace(/^[A-Z]*\d{2}-0*/, '');
      var isSelf = units.indexOf(_cadCallsign) !== -1;
      var isOpen = units.length === 0;
      return '<div class="call-queue-row' + (isOpen ? ' is-new' : '') + '" onclick="openCallDetail(\'' + esc(inc.incident_id) + '\')">' +
        '<span class="call-queue-pri ' + priClass + '">' + esc(pri || 'ROUT') + '</span>' +
        '<div style="flex:1;min-width:0;">' +
          '<div class="call-queue-type">' + esc(inc.incident_type || 'INC' + shortId) + '</div>' +
          (inc.scene_address ? '<div class="call-queue-dest">' + esc(inc.scene_address) + '</div>' : '') +
          (inc.destination ? '<div class="call-queue-dest">\u2192 ' + esc(inc.destination) + '</div>' : '') +
        '</div>' +
        '<div style="text-align:right;flex-shrink:0;min-width:54px;">' +
          (isSelf ? '<div style="font-size:10px;color:var(--green);font-weight:900;">YOU</div>' : '') +
          (isOpen ? '<div style="font-size:10px;color:var(--yellow);font-weight:900;">OPEN</div>' : '') +
          (!isSelf && !isOpen ? '<div class="call-queue-units">' + units.length + ' UNIT' + (units.length > 1 ? 'S' : '') + '</div>' : '') +
          '<div style="font-size:9px;color:var(--muted);margin-top:2px;">' + inc.incident_id + '</div>' +
        '</div>' +
        '<span style="color:var(--muted);font-size:16px;margin-left:8px;flex-shrink:0;">&#9654;</span>' +
        '</div>';
    }).join('');
    content.innerHTML = html;
  }

  function openCallDetail(incId) {
    // Source data from _lastState.incidents (all incidents, not just queued stack)
    var allIncs = (_lastState && _lastState.incidents) || [];
    var inc = allIncs.find(function(i) { return i.incident_id === incId; });
    // Also check stack for supplemental fields (priority, etc.)
    var stackItem = (_lastStack || []).find(function(x) { return x.incident_id === incId; });
    var src = inc || stackItem;
    if (!src) return;
    var shortId = String(incId).replace(/^[A-Z]*\d{2}-0*/, '');
    var pri = ((inc && inc.priority) || (stackItem && stackItem.priority) || '').toUpperCase();
    var units = Array.isArray(inc && inc.units) ? inc.units : (inc && inc.units ? String(inc.units).split(',').map(function(s){return s.trim();}).filter(Boolean) : []);
    var noteRaw = (inc && inc.incident_note) || (stackItem && stackItem.incident_note) || '';
    var noteClean = noteRaw.replace(/\[[^\]]*\]/g, '').replace(/\s{2,}/g, ' ').trim();
    var isSelfAssigned = units.indexOf(_cadCallsign) !== -1;
    var incType = (inc && inc.incident_type) || (stackItem && stackItem.incident_type) || '';
    var sceneAddr = (inc && inc.scene_address) || (stackItem && stackItem.scene_address) || '';
    var dest = (inc && inc.destination) || (stackItem && stackItem.destination) || '';

    var titleEl = document.getElementById('cdsTitle');
    if (titleEl) titleEl.textContent = incId + (incType ? ' \u2014 ' + incType : '');

    var fieldsEl = document.getElementById('cdsFields');
    if (!fieldsEl) return;

    var unitsHtml = '';
    if (units.length) {
      var chips = units.map(function(u) {
        var s = u === _cadCallsign;
        return '<span class="cds-unit-chip' + (s ? ' is-self' : '') + '">' + esc(u) + '</span>';
      }).join('');
      unitsHtml = '<div class="cds-units-section"><div class="cds-units-lbl">ASSIGNED UNITS</div>' + chips + '</div>';
    }

    // Self-assign buttons use data-attributes + JS listeners (not inline onclick)
    // to avoid JS-in-HTML-attribute injection if incident_id ever contains quotes.
    var selfAssignHtml = (_fieldFF.field_self_assign !== false)
      ? '<div class="cds-actions">' +
          '<button class="cds-btn cds-btn-enroute' + (isSelfAssigned ? ' cds-btn-assigned' : '') + '" data-sa-inc="' + esc(incId) + '" data-sa-status="DE">' +
            (isSelfAssigned ? '\u2713 ENROUTE (ASSIGNED)' : 'I\'M ENROUTE') +
          '</button>' +
          '<button class="cds-btn cds-btn-onscene" data-sa-inc="' + esc(incId) + '" data-sa-status="OS">' +
            'ON SCENE' +
          '</button>' +
        '</div>'
      : '';
    fieldsEl.innerHTML = selfAssignHtml +
      '<div class="cds-field"><span class="cds-field-lbl">PRIORITY</span><span class="cds-field-val">' + esc(pri || '\u2014') + '</span></div>' +
      '<div class="cds-field"><span class="cds-field-lbl">TYPE</span><span class="cds-field-val">' + esc(incType || '\u2014') + '</span></div>' +
      (sceneAddr ? '<div class="cds-field"><span class="cds-field-lbl">SCENE</span><span class="cds-field-val">' + esc(sceneAddr) + '</span></div>' : '') +
      (dest ? '<div class="cds-field"><span class="cds-field-lbl">DEST</span><span class="cds-field-val">' + esc(dest) + '</span></div>' : '') +
      (noteClean ? '<div class="cds-field"><span class="cds-field-lbl">NOTE</span><span class="cds-field-val">' + esc(noteClean) + '</span></div>' : '') +
      unitsHtml;
    // Wire self-assign button listeners after innerHTML is set (data-attribute approach avoids JS-in-attribute injection)
    fieldsEl.querySelectorAll('[data-sa-inc]').forEach(function(btn) {
      btn.addEventListener('click', function() { handleSelfAssign(btn.dataset.saInc, btn.dataset.saStatus); });
    });

    var backdrop = document.getElementById('callDetailBackdrop');
    var sheet = document.getElementById('callDetailSheet');
    if (backdrop) backdrop.style.display = 'block';
    if (sheet) sheet.style.display = 'block';
  }

  function closeCallDetail() {
    var backdrop = document.getElementById('callDetailBackdrop');
    var sheet = document.getElementById('callDetailSheet');
    if (backdrop) backdrop.style.display = 'none';
    if (sheet) sheet.style.display = 'none';
  }

  function handleSelfAssign(incId, statusCode) {
    var shortId = String(incId).replace(/^[A-Z]*\d{2}-0*/, '');
    closeCallDetail();
    feedSys(statusCode + ' SELF-ASSIGNING TO INC' + shortId + '...');
    API.selfAssign(_cadToken, incId, statusCode).then(function(res) {
      if (res.ok) {
        feedSys('ASSIGNED TO INC' + shortId + ' \xB7 STATUS: ' + statusCode);
        switchTab('mycall');
      } else {
        feedErr('SELF-ASSIGN FAILED: ' + (res.error || 'UNKNOWN'));
      }
    }).catch(function() { setOnline(false); feedErr('SELF-ASSIGN FAILED \u2014 OFFLINE'); });
  }

  function _clearCallsBadge() {
    var badge = document.getElementById('callsTabBadge');
    if (badge) { badge.textContent = ''; badge.classList.remove('visible'); }
  }

  // ── END CALLS TAB ──────────────────────────────────────────────────────────

  function _updateMoreTab() {
    var moreCS = document.getElementById('moreCallsignLabel');
    if (moreCS) moreCS.textContent = _cadCallsign || '';
    var moreUI = document.getElementById('moreUnitInfo');
    if (moreUI) moreUI.textContent = _cadUnitInfo || '';
    var wakeStatus = document.getElementById('moreWakeStatus');
    if (wakeStatus) wakeStatus.textContent = _wakeLock ? 'ON' : 'OFF';
    var nightStatus = document.getElementById('moreNightStatus');
    if (nightStatus) {
      if (_nightOverride === true) nightStatus.textContent = 'ON';
      else if (_nightOverride === false) nightStatus.textContent = 'OFF';
      else nightStatus.textContent = 'AUTO';
    }
  }

  function _renderFieldMapTab() {
    var el = document.getElementById('fieldMapTabEl');
    var stat = document.getElementById('fmapTabStatus');
    var navBtn = document.getElementById('fmapTabNavBtn');
    if (!el || !window.L) return;

    var center = [44.058, -121.315];
    var curIncId = _currentIncident || '';
    var incs  = (_lastState && _lastState.incidents) || [];
    var units = (_lastState && _lastState.units)     || [];
    var curInc = curIncId ? incs.find(function(i) { return i.incident_id === curIncId; }) : null;

    if (!_fieldMapTabObj) {
      _fieldMapTabObj = L.map(el, { zoomControl: true, attributionControl: false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(_fieldMapTabObj);
    } else {
      _fieldMapTabLayers.forEach(function(ly) { try { _fieldMapTabObj.removeLayer(ly); } catch(e2) {} });
      _fieldMapTabLayers = [];
    }
    setTimeout(function() { if (_fieldMapTabObj) _fieldMapTabObj.invalidateSize(); }, 120);

    function addTabLayer(ly) { ly.addTo(_fieldMapTabObj); _fieldMapTabLayers.push(ly); return ly; }

    var bounds = [];

    // Unit markers — same logic as overlay map
    var activeUnits = units.filter(function(u) { return u.active; });
    activeUnits.forEach(function(u) {
      var pos = null;
      var locMatch = (u.note || '').match(/\[LOC:(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\]/i);
      if (locMatch) { pos = [parseFloat(locMatch[1]), parseFloat(locMatch[2])]; }
      if (!pos) { pos = (_SUGGEST_AGENCY_COORDS_FIELD && _SUGGEST_AGENCY_COORDS_FIELD[String(u.agency_id || '').toUpperCase()]) || null; }
      if (!pos) return;
      var isSelf = (u.unit_id === _cadCallsign);
      addTabLayer(L.circleMarker(pos, {
        radius: isSelf ? 10 : 7,
        color: isSelf ? '#5ba3e6' : '#ffd66b',
        fillColor: isSelf ? '#1a3a5c' : '#3a2800',
        fillOpacity: 0.85, weight: 2
      }).bindPopup('<b>' + esc(u.unit_id) + '</b><br>' + esc(u.status || '') +
        (u.incident ? '<br>INC: ' + esc(String(u.incident).replace(/^[A-Z]*\d{2}-0*/, '')) : '')));
      bounds.push(pos);
    });

    // GPS dot
    if (_fieldGpsPos) {
      addTabLayer(L.circleMarker(_fieldGpsPos, {
        radius: 10, color: '#00e5ff', fillColor: '#001a2e', fillOpacity: 0.9, weight: 3, dashArray: '4 2'
      }).bindPopup('<b>YOU ARE HERE</b>'));
      bounds.push(_fieldGpsPos);
    }

    // Incident markers
    _fmapTabNavUrl = null;
    if (navBtn) navBtn.style.display = 'none';
    var geoQueue = [];

    var activeIncs = incs.filter(function(i) {
      return i.status === 'ACTIVE' || i.status === 'QUEUED' || i.status === 'IQ';
    });
    activeIncs.forEach(function(inc) {
      if (!inc.scene_address) return;
      var addr = inc.scene_address.trim();
      var isCur = (inc.incident_id === curIncId);
      if (isCur) {
        _fmapTabNavUrl = 'https://maps.google.com/?q=' + encodeURIComponent(addr);
        if (navBtn) navBtn.style.display = '';
      }
      var color = isCur ? '#ff4444' : '#ff9900';
      var fillColor = isCur ? '#8b0000' : '#7a4300';
      var label = (isCur ? '<b>SCENE</b>' : '<b>INC ' + esc(String(inc.incident_id).replace(/^[A-Z]*\d{2}-0*/, '')) + '</b>') + '<br>' + esc(addr);
      var normAddr = addr.toUpperCase().trim();
      if (_FIELD_KNOWN_COORDS && _FIELD_KNOWN_COORDS[normAddr]) {
        var kc = _FIELD_KNOWN_COORDS[normAddr];
        var mk = addTabLayer(L.circleMarker(kc, { radius: 12, color: color, fillColor: fillColor, fillOpacity: 0.9, weight: 3 }).bindPopup(label));
        if (isCur) mk.openPopup();
        bounds.push(kc);
      } else {
        geoQueue.push({ inc: inc, addr: addr, isCur: isCur, color: color, fillColor: fillColor, label: label });
      }
    });

    // Fit bounds
    if (bounds.length > 1) _fieldMapTabObj.fitBounds(bounds, { padding: [30, 30] });
    else if (bounds.length === 1) _fieldMapTabObj.setView(bounds[0], curInc ? 14 : 12);
    else _fieldMapTabObj.setView(center, 12);

    if (stat) stat.textContent = curInc && curInc.scene_address ? ('SCENE: ' + curInc.scene_address.trim()) : (activeIncs.length ? (activeIncs.length + ' ACTIVE INCIDENTS') : 'NO ACTIVE INCIDENTS');

    // Geocode queue — Nominatim 1 req/1.5s
    if (geoQueue.length) {
      var idx = 0;
      function _tabGeoNext() {
        if (idx >= geoQueue.length || !_fieldMapTabObj) return;
        var item = geoQueue[idx++];
        var q = item.addr.replace(/\bNE\b/g,'NORTHEAST').replace(/\bNW\b/g,'NORTHWEST')
                         .replace(/\bSE\b/g,'SOUTHEAST').replace(/\bSW\b/g,'SOUTHWEST');
        if (!/\bOR\b|\boregon\b/i.test(q)) q += ', Oregon';
        fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data && data[0] && _fieldMapTabObj) {
              var lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);
              var mk = addTabLayer(L.circleMarker([lat, lon], { radius: 12, color: item.color, fillColor: item.fillColor, fillOpacity: 0.9, weight: 3 }).bindPopup(item.label));
              if (item.isCur) mk.openPopup();
              bounds.push([lat, lon]);
              if (bounds.length > 1) _fieldMapTabObj.fitBounds(bounds, { padding: [30, 30] });
              else _fieldMapTabObj.setView([lat, lon], 14);
            }
            setTimeout(_tabGeoNext, 1500);
          })
          .catch(function() { setTimeout(_tabGeoNext, 1500); });
      }
      _tabGeoNext();
    }
  }

  function openFieldMapTabNav() {
    if (_fmapTabNavUrl) window.open(_fmapTabNavUrl, '_blank');
  }

  function _maybeRefreshMapTab() {
    if (_activeTab === 'map' && _fieldMapTabObj && _mapTabInitialized) {
      _renderFieldMapTab();
    }
  }

  // Expose for inline onclick handlers
  window.switchTab = switchTab;
  window.openFieldMapTabNav = openFieldMapTabNav;

  // ════════════════════════════════════════════════════════════════════════════
  // AUDIO TONES - Different sounds for different events
  // Field CAD needs MORE audio feedback than dispatch since crews aren't watching
  // ════════════════════════════════════════════════════════════════════════════

  // Pre-loaded audio cache — created on first user gesture so iOS allows playback.
  // Reusing the same objects is more reliable than new Audio() each time.
  var _audioPool = {};
  function _getAudio(src) {
    if (!_audioPool[src]) {
      var a = new Audio(src);
      a.load();
      _audioPool[src] = a;
    }
    return _audioPool[src];
  }
  function _playAudio(src, vol, fallback) {
    try {
      var a = _getAudio(src);
      a.volume = vol || 1.0;
      a.currentTime = 0;
      a.play().catch(function() { if (fallback) fallback(); });
    } catch(e) { if (fallback) fallback(); }
  }

  // Urgent tone — HTMSG / urgent messages
  function _toneUrgent() {
    _playAudio('../sounds/htmsg.mp3', 1.0, _toneUrgentSynth);
  }

  // Shared WebAudio beep helper — plays sequence of tones
  function _fieldBeep(freqs, dur, vol) {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      ctx.resume().then(function() {
        var gap = 0.05;
        freqs.forEach(function(freq, i) {
          var start = i * (dur + gap);
          var osc = ctx.createOscillator();
          var gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0, ctx.currentTime + start);
          gain.gain.linearRampToValueAtTime(vol, ctx.currentTime + start + 0.02);
          gain.gain.linearRampToValueAtTime(0, ctx.currentTime + start + dur - 0.01);
          osc.start(ctx.currentTime + start);
          osc.stop(ctx.currentTime + start + dur);
        });
        setTimeout(function() { try { ctx.close(); } catch(e) {} },
          (freqs.length * (dur + gap) + 0.3) * 1000);
      });
    } catch(e) {}
  }

  // Message tone — incoming MSG from dispatch
  function _toneMessage() {
    _playAudio('../sounds/msg.mp3', 0.9, function() { _fieldBeep([660, 660], 0.18, 0.5); });
  }

  // Urgent tone override via WebAudio (fallback if WAV fails)
  function _toneUrgentSynth() {
    _fieldBeep([880, 1100, 880, 1100], 0.22, 0.8);
  }

  // Dispatch tone — new call assigned to this unit (plays 6x unless acked or DE)
  var _dispatchAlertTimer = null;
  var _dispatchAlertCount = 0;
  function _toneDispatch() {
    _playAudio('../sounds/new-call.mp3', 1.0, _toneUrgentSynth);
  }
  function _startDispatchAlert() {
    _stopDispatchAlert();
    _toneDispatch();
    _dispatchAlertCount = 1;
    var ackEl = document.getElementById('dispatchAckBtn');
    if (ackEl) { ackEl.style.display = 'inline-block'; ackEl.textContent = 'ACK (5 MORE)'; }
    // Auto-switch to MY CALL tab so crew sees the incident immediately
    _autoSwitchOnDispatch();
    _dispatchAlertTimer = setInterval(function() {
      _dispatchAlertCount++;
      _toneDispatch();
      var btn = document.getElementById('dispatchAckBtn');
      var remaining = 6 - _dispatchAlertCount;
      if (btn) btn.textContent = remaining > 0 ? 'ACK (' + remaining + ' MORE)' : 'ACK';
      if (_dispatchAlertCount >= 6) _stopDispatchAlert();
    }, 4000);
  }
  function _stopDispatchAlert() {
    if (_dispatchAlertTimer) { clearInterval(_dispatchAlertTimer); _dispatchAlertTimer = null; }
    _dispatchAlertCount = 0;
    var ackEl = document.getElementById('dispatchAckBtn');
    if (ackEl) ackEl.style.display = 'none';
  }
  function ackDispatch() {
    _stopDispatchAlert();
    feedAppend('<span class="cmd-sys">ACK — DISPATCH ACKNOWLEDGED.</span>');
    // Notify board — fire-and-forget (non-blocking)
    if (_cadToken && _currentIncident) {
      API.ackDispatch(_cadToken, _currentIncident).catch(function() {});
    }
  }

  // STACK ALERT — 3× repeat at 4s intervals (lighter than full 6× dispatch alert)
  // Fires when dispatch stages a new queued call while unit is active
  var _stackAlertTimer = null;
  var _stackAlertCount = 0;
  function _startStackAlert() {
    _stopStackAlert();
    _toneDispatch();
    _stackAlertCount = 1;
    var ackBtn = document.getElementById('nextCallAck');
    if (ackBtn) { ackBtn.textContent = 'ACK STACK'; ackBtn.style.animation = 'newCallPulse 0.6s ease-out 3'; }
    _stackAlertTimer = setInterval(function() {
      _stackAlertCount++;
      _toneDispatch();
      var btn = document.getElementById('nextCallAck');
      var rem = 3 - _stackAlertCount;
      if (btn) btn.textContent = rem > 0 ? 'ACK STACK (' + rem + ')' : 'ACK STACK';
      if (_stackAlertCount >= 3) _stopStackAlert();
    }, 4000);
  }
  function _stopStackAlert() {
    if (_stackAlertTimer) { clearInterval(_stackAlertTimer); _stackAlertTimer = null; }
    _stackAlertCount = 0;
    var ackBtn = document.getElementById('nextCallAck');
    if (ackBtn) { ackBtn.textContent = 'ACK'; ackBtn.style.animation = ''; }
  }

  // MDT alert tone — status change forced by dispatch
  function _toneStatus() {
    _playAudio('../sounds/msg.mp3', 0.9, _toneMessage);
  }

  // Page tone — radio page from dispatcher
  function _tonePage() {
    _playAudio('../sounds/pg.mp3', 1.0, _toneUrgentSynth);
  }

  // Unlock audio on first user gesture (mobile requirement)
  let _audioUnlocked = false;
  ['touchstart','mousedown','keydown'].forEach(function(evt) {
    document.addEventListener(evt, function() {
      if (_audioUnlocked) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        ctx.resume().then(function() { ctx.close(); });
        const a = new Audio();
        a.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=';
        a.volume = 0;
        a.play().then(function() { a.pause(); }).catch(function(){});
        _audioUnlocked = true;
        // Pre-load all tone files now that audio is unlocked
        ['../sounds/new-call.mp3','../sounds/htmsg.mp3','../sounds/msg.mp3','../sounds/pg.mp3'].forEach(_getAudio);
      } catch(e) {}
    }, { passive: true });
  });

  // Cross-platform notification helper — uses SW showNotification() for iOS PWA support.
  // new Notification() is blocked on iOS; SW-based notifications work on iOS 16.4+.
  function _notify(title, body, tag, requireInteraction) {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') return;
    var opts = {
      body: body,
      icon: '../download.png',
      badge: '../download.png',
      tag: tag || ('hoscad-field-' + Date.now()),
      requireInteraction: !!requireInteraction
    };
    try {
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(function(reg) {
          reg.showNotification(title, opts);
        }).catch(function() {});
      } else {
        // Fallback for desktop where SW may not be active
        new Notification(title, opts);
      }
    } catch(e) {}
  }

  // ════════════════════════════════════════════════════════════════════════════
  // STATE
  // ════════════════════════════════════════════════════════════════════════════
  let _cadToken = null;
  let _cadCallsign = '';
  let _cadUnitInfo = '';
  let _pollTimer = null;
  let _gpsAutoInterval = null;
  let _fieldRT = null;            // Supabase Realtime WebSocket
  let _fieldRtHbTimer = null;     // heartbeat interval (25s)
  let _fieldRtReconTimer = null;  // reconnect timeout (5s)
  let _fieldRtRef = 0;            // Phoenix message ref counter
  // Feature flags — persisted in localStorage so login screen can apply flags on next page load
  var _fieldFF = (function() { try { return JSON.parse(localStorage.getItem('hoscad_field_ff') || '{}'); } catch(e) { return {}; } })();
  let _fieldIncHistPushed = false;
  let _knownMsgIds = new Set();
  let _loginTime = null;
  let _currentStatus = 'AV';
  let _currentIncident = '';
  let _currentNature = '';
  let _currentDestination = '';
  let _currentNote = '';
  let _previousStatus = '';
  let _previousIncident = '';
  let _previousNature = '';
  let _previousDestination = '';
  let _previousNote = '';
  let _addrCache = {};
  let _addrList = [];
  let _lastState = null;
  let _isOnline = true;
  let _offlineQueue = [];
  let _nightOverride = null;
  let _incidentTimes = {}; // { dispatched, enroute, onscene } — local fallback only
  let _lastStack = [];           // Phase 2E: queued assignment stack
  // M-6: Banner acknowledgment state
  let _bannerAckState = { alert: { msg: '', acked: false }, note: { msg: '', acked: false } };
  let _prevQueuedIds = '';       // Phase 2E: track changes for tone
  let _ackedIncIds = new Set(JSON.parse(localStorage.getItem('hoscadfield_acked') || '[]'));
  // Track self-initiated status changes so the poll doesn't misfire a "STATUS CHANGED BY DISPATCH" tone.
  // Set when the user taps a button; cleared once the poll confirms the server matches.
  let _pendingStatus = null;
  // Delta-resilient state merge:
  // _mergedUnits and _mergedIncidents are running caches that survive partial
  // (delta) poll responses.  When a poll returns only changed units, unchanged
  // unit rows are not present in state.units — but they ARE in the cache.
  // This is critical for the field unit's own row: if the backend omits it
  // (e.g. because updated_at didn't change, as happens with assignUnit-only
  // dispatches), we still know the last good unit state including incident.
  let _mergedUnits = {};     // unit_id.toUpperCase() → unit object
  let _mergedIncidents = {}; // incident_id.toUpperCase() → incident object
  let _lastTs = null;        // serverTime from last successful poll (for future sinceTs delta use)
  let _fieldActionLog = []; // Ring buffer of last 10 field actions for bug report context

  const STATUS_LABELS = {
    D: 'DISPATCHED', DE: 'ENROUTE', OS: 'ON SCENE', T: 'TRANSPORT',
    TH: 'AT HOSPITAL', AV: 'AVAILABLE', UV: 'UNAVAILABLE', BRK: 'BREAK',
    OOS: 'OUT OF SERVICE', F: 'FUELING', FD: 'FUELING/DEST', IQ: 'IN QUARTERS'
  };

  // Valid next-status transitions for context-sensitive button highlighting.
  // Buttons for listed statuses get full opacity; others are dimmed to 0.35.
  // All buttons remain tappable — dimming is a hint, not a lock.
  const VALID_TRANSITIONS = {
    'AV':  ['DE', 'OOS', 'IQ'],
    'D':   ['DE', 'OS', 'AV'],
    'DE':  ['OS', 'AV'],
    'OS':  ['T', 'TH', 'AV'],   // TH added: non-transport scene clearance through hospital
    'T':   ['TH', 'AV'],
    'TH':  ['AV', 'OOS'],
    'OOS': ['AV'],
    'IQ':  ['AV', 'DE'],
    'BRK': ['AV', 'DE'],
    'UV':  ['AV'],
    'F':   ['AV'],               // DC911 fire status — safe fallback
    'FD':  ['AV'],               // DC911 fire/dest status — safe fallback
  };

  const URGENT_NATURES = ['CARDIAC', 'CHEST PAIN', 'RESPIRATORY', 'STROKE', 'TRAUMA', 'MVC', 'SHOOTING', 'STABBING', 'OVERDOSE', 'UNRESPONSIVE', 'CPR', 'CODE'];

  // ════════════════════════════════════════════════════════════════════════════
  // HELPERS
  // ════════════════════════════════════════════════════════════════════════════
  function esc(s) {
    return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function fmtTime(iso) {
    if (!iso) return '--:--';
    const d = new Date(iso);
    if (isNaN(d)) return '--:--';
    return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
  }

  function nowTS() {
    const d = new Date();
    return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0') + ':' + String(d.getSeconds()).padStart(2,'0');
  }

  function elapsedStr(isoDate) {
    if (!isoDate) return '';
    const diff = Math.floor((Date.now() - new Date(isoDate).getTime()) / 60000);
    if (diff < 1) return '<1M';
    if (diff < 60) return diff + 'M';
    return Math.floor(diff/60) + 'H' + (diff%60) + 'M';
  }

  function feedAppend(html) {
    const div = document.createElement('div');
    div.className = 'cmd-feed-line';
    div.innerHTML = html;
    cmdFeed.appendChild(div);
    while (cmdFeed.children.length > 300) cmdFeed.removeChild(cmdFeed.firstChild);
    cmdFeed.scrollTop = cmdFeed.scrollHeight;
  }

  function feedSys(text) { feedAppend('<span class="cmd-sys">' + esc(text) + '</span>'); }
  function feedErr(text) { feedAppend('<span class="cmd-err">' + esc(text) + '</span>'); }
  function feedAlert(text) { feedAppend('<span class="cmd-alert">' + esc(text) + '</span>'); }

  function isUrgentNature(nature) {
    if (!nature) return false;
    const upper = nature.toUpperCase();
    return URGENT_NATURES.some(function(n) { return upper.includes(n); });
  }

  // ════════════════════════════════════════════════════════════════════════════
  // STATE MERGE — delta-resilient unit + incident caches
  // ════════════════════════════════════════════════════════════════════════════

  /**
   * Merge a poll response into _mergedUnits and _mergedIncidents.
   *
   * Full state (isDelta=false or missing): replace entire caches and prune
   *   closed incidents that disappeared from the response.
   * Delta state (isDelta=true): only overwrite entries present in response;
   *   keep everything else so unchanged rows remain available.
   *
   * Also updates _lastState.units/incidents to reflect merged state so any
   * code that reads _lastState directly (e.g. UR command, openIncDetail) gets
   * a complete view.
   */
  function _mergeState(state) {
    if (!state) return;

    const isDelta = !!state.isDelta;
    const units = state.units || [];
    const incidents = state.incidents || [];

    if (!isDelta) {
      // Full response: rebuild caches from scratch
      _mergedUnits = {};
      units.forEach(function(u) {
        if (u && u.unit_id) _mergedUnits[u.unit_id.toUpperCase()] = u;
      });
      // For incidents: full list = exactly what the server sent (closed ones are absent)
      _mergedIncidents = {};
      incidents.forEach(function(i) {
        _mergedIncidents[(i.incident_id || '').toUpperCase()] = i;
      });
    } else {
      // Delta response: merge-in changed rows, preserve the rest
      units.forEach(function(u) {
        if (u && u.unit_id) _mergedUnits[u.unit_id.toUpperCase()] = u;
      });
      incidents.forEach(function(i) {
        _mergedIncidents[(i.incident_id || '').toUpperCase()] = i;
      });
      // Incidents list from full state already only has non-CLOSED ones;
      // in delta mode we can't tell which got closed, so we keep all cached.
    }

    // Update serverTime tracker for potential future delta polling
    if (state.serverTime) _lastTs = state.serverTime;

    // Patch _lastState so downstream readers (UR command, openIncDetail, etc.)
    // see a complete merged view rather than only the delta slice.
    if (_lastState) {
      _lastState.units = Object.values(_mergedUnits);
      _lastState.incidents = Object.values(_mergedIncidents);
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // ADDRESS CACHE
  // ════════════════════════════════════════════════════════════════════════════
  async function loadAddresses() {
    try {
      if (!_cadToken) return;
      const res = await API.getAddresses(_cadToken);
      if (res.ok && res.addresses) {
        _addrCache = {};
        _addrList = res.addresses;
        res.addresses.forEach(function(a) { _addrCache[a.id] = a; });
      }
    } catch(e) { console.warn('[field] Address load failed:', e); }
  }

  function resolveAddr(dest) {
    if (!dest) return '--';
    const a = _addrCache[dest.toUpperCase ? dest.toUpperCase() : dest];
    return a ? a.name : dest;
  }

  function getAddrDetails(dest) {
    if (!dest) return null;
    return _addrCache[dest.toUpperCase ? dest.toUpperCase() : dest] || null;
  }

  // Parse [LOC:address] tag from note string
  function _parseLocTag(note) {
    if (!note) return '';
    var m = note.match(/\[LOC:([^\]]*)\]/);
    return m ? m[1].trim() : '';
  }

  // Update the field location bar to match board LOCATION column
  function updateFieldLocation(unit, state) {
    var bar = document.getElementById('fieldLocationBar');
    var txt = document.getElementById('fieldLocationText');
    if (!bar || !txt) return;
    if (!unit) { bar.style.display = 'none'; return; }

    var st = String(unit.status || '').toUpperCase();
    var loc = '';

    // Priority: match board formatLocation logic
    // 1) D/DE/OS → incident scene_address
    if (['D', 'DE', 'OS'].includes(st) && unit.incident && state) {
      var incs = state.incidents || [];
      for (var i = 0; i < incs.length; i++) {
        if (incs[i].incident_id === unit.incident && incs[i].scene_address) {
          loc = incs[i].scene_address; break;
        }
      }
    }
    // 2) IQ → station
    if (!loc && st === 'IQ' && unit.station) {
      loc = String(unit.station).trim().toUpperCase();
    }
    // 3) T/AT/TH → transport destination
    if (!loc && ['T', 'AT', 'TH'].includes(st) && unit.destination) {
      loc = resolveAddr(unit.destination);
    }
    // 4) Fallback: destination
    if (!loc && unit.destination) {
      loc = resolveAddr(unit.destination);
    }
    // 5) Fallback: LOC tag from note
    if (!loc) {
      loc = _parseLocTag(unit.note);
      if (loc) loc = resolveAddr(loc);
    }

    if (loc) {
      txt.textContent = loc;
      bar.style.display = '';
    } else {
      bar.style.display = 'none';
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // HOSPITAL QUICK REFERENCE
  // ════════════════════════════════════════════════════════════════════════════
  var CAP_PATTERNS = [
    { re: /LEVEL\s*1\s*TRAUMA/,  label: 'L1 TRAUMA',      cls: 'cap-l1'  },
    { re: /LEVEL\s*2\s*TRAUMA/,  label: 'L2 TRAUMA',      cls: 'cap-l2'  },
    { re: /LEVEL\s*3\s*TRAUMA/,  label: 'L3 TRAUMA',      cls: 'cap-l3'  },
    { re: /CRITICAL ACCESS/,     label: 'CRITICAL ACCESS', cls: 'cap-def' },
    { re: /CATH LAB/,            label: 'CATH LAB',        cls: 'cap-l2'  },
    { re: /STROKE/,              label: 'STROKE',           cls: 'cap-air' },
    { re: /TRAUMA CENTER/,       label: 'TRAUMA CTR',      cls: 'cap-l2'  },
    { re: /AIR AMBULANCE/,       label: 'AIR AMBULANCE',   cls: 'cap-air' },
    { re: /DIALYSIS/,            label: 'DIALYSIS',         cls: 'cap-def' },
    { re: /PSYCH/,               label: 'PSYCH',            cls: 'cap-def' },
    { re: /PEDS/,                label: 'PEDS',             cls: 'cap-def' },
    { re: /BURN/,                label: 'BURN',             cls: 'cap-l2'  },
    { re: /CARDIAC/,             label: 'CARDIAC',          cls: 'cap-l2'  },
  ];

  function parseCapBadges(notes) {
    if (!notes) return '';
    var upper = notes.toUpperCase();
    var seen = {};
    var html = '';
    for (var i = 0; i < CAP_PATTERNS.length; i++) {
      var p = CAP_PATTERNS[i];
      if (p.re.test(upper) && !seen[p.label]) {
        seen[p.label] = true;
        html += '<span class="cap-badge ' + p.cls + '">' + p.label + '</span>';
      }
    }
    if (!html && notes.trim()) {
      html = '<span class="cap-badge cap-def">' + esc(notes.substring(0, 50)) + '</span>';
    }
    return html;
  }

  function showInfoOverlay() {
    renderInfoCards();
    document.getElementById('infoOverlay').style.display = 'flex';
  }

  function closeInfoOverlay() {
    document.getElementById('infoOverlay').style.display = 'none';
  }

  function renderInfoCards() {
    var el = document.getElementById('infoCards');
    if (!el) return;
    if (!_addrList.length) {
      el.innerHTML = '<div style="color:#8fa1b8;font-size:13px;padding:20px 0;text-align:center;">NO ADDRESSES LOADED.<br>CHECK CONNECTION AND REFRESH.</div>';
      return;
    }
    var divertedSet = {};
    var dests = (_lastState && _lastState.destinations) || [];
    dests.forEach(function(d) { if (d.diverted) divertedSet[(d.code || '').toUpperCase()] = true; });

    var CAT_ORDER = ['HOSPITAL', 'AIR_AMBULANCE', 'DIALYSIS'];
    var sorted = _addrList.slice().sort(function(a, b) {
      var ai = CAT_ORDER.indexOf((a.category || '').toUpperCase());
      var bi = CAT_ORDER.indexOf((b.category || '').toUpperCase());
      if (ai === -1) ai = 99;
      if (bi === -1) bi = 99;
      if (ai !== bi) return ai - bi;
      return (a.name || '').localeCompare(b.name || '');
    });

    var html = '';
    var lastCat = null;
    sorted.forEach(function(a) {
      var cat = (a.category || 'OTHER').toUpperCase();
      if (cat !== lastCat) {
        html += '<div class="info-cat-label">' + esc(cat) + '</div>';
        lastCat = cat;
      }
      var isDiverted = !!divertedSet[(a.id || '').toUpperCase()];
      var addrLine = [a.address, a.city, a.state].filter(Boolean).join(', ');
      var caps = parseCapBadges(a.notes || '');
      html += '<div class="info-card' + (isDiverted ? ' diverted' : '') + '">';
      html += '<div><span class="info-card-code">[' + esc(a.id) + ']</span>';
      html += '<span class="info-card-name">' + esc(a.name) + '</span>';
      if (isDiverted) html += '<span class="cap-badge cap-div-badge">DIVERTED</span>';
      html += '</div>';
      if (addrLine) html += '<div class="info-card-addr">' + esc(addrLine) + '</div>';
      if (a.phone) html += '<div class="info-card-phone">' + esc(a.phone) + '</div>';
      if (caps) html += '<div class="info-card-caps">' + caps + '</div>';
      html += '<button class="btn-set-dest" data-dest-code="' + esc(a.id) + '">SET DEST: ' + esc(a.id) + '</button>';
      html += '</div>';
    });
    el.innerHTML = html;
  }

  function infoSetDest(destCode) {
    API.upsertUnit(_cadToken, _cadCallsign, { destination: destCode }, '').then(function(res) {
      if (res.ok) {
        _currentDestination = destCode;
        feedSys('DEST SET: ' + destCode);
        closeInfoOverlay();
        pollOnce();
      } else {
        feedErr('DEST FAILED: ' + (res.error || 'UNKNOWN'));
        closeInfoOverlay();
      }
    });
  }

  // ════════════════════════════════════════════════════════════════════════════
  // OFFLINE QUEUE
  // ════════════════════════════════════════════════════════════════════════════
  function loadOfflineQueue() {
    try {
      const q = localStorage.getItem('hoscadfield_queue');
      if (q) _offlineQueue = JSON.parse(q);
    } catch(e) { _offlineQueue = []; }
    updatePendingBadge();
  }

  function saveOfflineQueue() {
    try { localStorage.setItem('hoscadfield_queue', JSON.stringify(_offlineQueue)); } catch(e) {}
  }

  function updatePendingBadge() {
    const el = document.getElementById('pendingBadge');
    if (!el) return;
    const n = _offlineQueue.length;
    if (!n) { el.style.display = 'none'; return; }
    el.style.display = 'inline-block';
    el.textContent = '[' + n + ' PENDING]';
  }

  function queueStatusUpdate(statusCode, note) {
    _offlineQueue.push({ type: 'status', status: statusCode, note: note || '', ts: Date.now() });
    saveOfflineQueue();
    updatePendingBadge();
  }

  function queueMessage(to, message, urgent) {
    _offlineQueue.push({ type: 'message', to: to, message: message, urgent: !!urgent, ts: Date.now() });
    saveOfflineQueue();
    updatePendingBadge();
  }

  function queueNoteAppend(incidentId, message) {
    _offlineQueue.push({ type: 'note', incidentId: incidentId, message: message, ts: Date.now() });
    saveOfflineQueue();
    updatePendingBadge();
  }

  async function flushOfflineQueue() {
    if (!_isOnline || !_cadToken || !_cadCallsign) return;
    while (_offlineQueue.length > 0) {
      const item = _offlineQueue[0];
      let result;
      try {
        if (item.type === 'status') {
          const patch = { status: item.status };
          if (item.note) patch.note = item.note;
          result = await API.upsertUnit(_cadToken, _cadCallsign, patch);
          if (result.ok) feedSys('QUEUED STATUS ' + item.status + ' SENT');
        } else if (item.type === 'message') {
          result = await API.sendMessage(_cadToken, item.to, item.message, item.urgent);
          if (result.ok) feedSys('QUEUED MSG TO ' + item.to + ' SENT');
        } else if (item.type === 'note') {
          result = await API.appendIncidentNote(_cadToken, item.incidentId, item.message);
          if (result.ok) feedSys('QUEUED NOTE FOR INC ' + item.incidentId + ' SENT');
        } else {
          // Unknown item type — remove and skip
          result = { ok: true };
        }
        if (result && result.ok) {
          _offlineQueue.shift(); // Remove only on success
          saveOfflineQueue();
          updatePendingBadge();
        } else {
          // Server returned an error — stop flushing, leave remaining items
          feedErr('QUEUED ITEM FAILED: ' + (result && result.error || 'SERVER ERROR'));
          break;
        }
      } catch(e) {
        // Network error — stop flushing, all remaining items preserved
        break;
      }
    }
    updatePendingBadge();
  }

  function setOnline(online) {
    _isOnline = online;
    offlineIndicator.style.display = online ? 'none' : 'inline-block';
    if (online && _offlineQueue.length) {
      flushOfflineQueue();
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // LOCALSTORAGE CACHE
  // ════════════════════════════════════════════════════════════════════════════
  function cacheCallInfo(data) {
    try { localStorage.setItem('hoscadfield_callcache', JSON.stringify(data)); } catch(e) {}
  }

  function loadCachedCallInfo() {
    try {
      const c = localStorage.getItem('hoscadfield_callcache');
      return c ? JSON.parse(c) : null;
    } catch(e) { return null; }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // STATUS BADGE
  // ════════════════════════════════════════════════════════════════════════════
  function updateStatusBadge(code) {
    _previousStatus = _currentStatus;
    _currentStatus = code;
    cadUnitStatus.textContent = code;
    cadUnitStatus.className = 'cad-unit-status cad-status-' + code;
    document.querySelectorAll('.field-status-btn').forEach(function(btn) {
      btn.classList.toggle('current', btn.dataset.status === code);
    });
    // Update the "no incident" status text
    const noIncStatus = document.getElementById('noIncidentStatus');
    if (noIncStatus) noIncStatus.textContent = STATUS_LABELS[code] || code;
    _updateHandoffBtn();
    _updateContextButtons(code);
  }

  function _updateContextButtons(code) {
    var nextValid = VALID_TRANSITIONS[code] || [];
    document.querySelectorAll('.field-status-btn[data-status]').forEach(function(btn) {
      var s = btn.dataset.status;
      if (s === code) {
        btn.style.opacity = '1'; // current status — always full (also gets .current class)
      } else if (nextValid.includes(s)) {
        btn.style.opacity = '1';
        btn.style.fontWeight = '900';
      } else {
        btn.style.opacity = '0.35';
        btn.style.fontWeight = '';
      }
    });
  }

  function _updateHandoffBtn() {
    // Show PATIENT HANDOFF button for T (transporting) and TH (at hospital) status
    const btn = document.getElementById('btnHandoff');
    if (btn) {
      var show = (_currentStatus === 'T' || _currentStatus === 'TH') && _currentIncident;
      btn.style.display = show ? '' : 'none';
      btn.textContent = _currentStatus === 'TH' ? 'PATIENT HANDOFF / CLEAR' : 'PATIENT HANDOFF';
    }
    const thBtn = document.getElementById('fieldTHBtn');
    if (thBtn) thBtn.style.opacity = (_currentStatus === 'T' || _currentStatus === 'TH') ? '1' : '0.45';
  }

  // ════════════════════════════════════════════════════════════════════════════
  // INCIDENT DISPLAY PANEL
  // ════════════════════════════════════════════════════════════════════════════
  function updateIncidentPanel(unit, state) {
    const panel = document.getElementById('incidentPanel');
    const noIncView = document.getElementById('noIncidentView');
    const hasIncView = document.getElementById('hasIncidentView');

    // Save previous values for change detection
    _previousIncident = _currentIncident;
    _previousNature = _currentNature;
    _previousDestination = _currentDestination;

    if (unit && unit.incident) {
      _currentIncident = unit.incident;

      // Find incident details
      const inc = (state && state.incidents || []).find(function(i) {
        return i.incident_id === unit.incident;
      });

      // Switch to "has incident" view
      panel.classList.remove('no-incident');
      panel.classList.add('has-incident');
      noIncView.style.display = 'none';
      hasIncView.style.display = '';

      // Always show scene row so NAV button is accessible even before inc details load
      const sceneRowEl = document.getElementById('fieldSceneRow');
      if (sceneRowEl) sceneRowEl.style.display = '';

      // Incident number
      document.getElementById('incNumber').textContent = unit.incident;

      if (inc) {
        _currentNature = inc.incident_type || '';
        _currentDestination = inc.destination || unit.destination || '';
        _currentNote = inc.incident_note || '';

        // Nature
        document.getElementById('incNature').textContent = _currentNature;

        // Priority badge — use inc.priority field directly (PRI-1/2/3/4)
        const prioEl = document.getElementById('incPriority');
        const rawPri = (inc.priority || '').toUpperCase();
        prioEl.className = 'inc-priority';
        if (rawPri === 'PRI-1' || rawPri === 'CRITICAL') {
          prioEl.classList.add('inc-priority-1');
        } else if (rawPri === 'PRI-2') {
          prioEl.classList.add('inc-priority-2');
        } else if (rawPri === 'PRI-3') {
          prioEl.classList.add('inc-priority-3');
        } else if (rawPri === 'PRI-4') {
          prioEl.classList.add('inc-priority-4');
        } else {
          // Fallback for unknown/missing priority values
          prioEl.classList.add('inc-priority-3');
        }
        prioEl.textContent = rawPri || 'ROUTINE';

        // Scene address — always show row when there's an active incident
        const sceneAddr = inc.scene_address || '';
        const sceneRow = document.getElementById('fieldSceneRow');
        const sceneAddrEl = document.getElementById('fieldSceneAddr');
        const btnNavSceneEl = document.getElementById('btnNavScene');
        sceneAddrEl.textContent = sceneAddr || '—';
        sceneRow.style.display = '';
        if (btnNavSceneEl) {
          btnNavSceneEl.disabled = !sceneAddr;
          btnNavSceneEl.style.opacity = sceneAddr ? '1' : '0.35';
        }

        // Destination address (THE MOST IMPORTANT)
        const destAddr = resolveAddr(_currentDestination);
        document.getElementById('incAddress').textContent = destAddr;

        // Address details from cache
        const addrObj = getAddrDetails(_currentDestination);
        if (addrObj) {
          document.getElementById('incCity').textContent = [addrObj.city, addrObj.state, addrObj.zip].filter(Boolean).join(' ');
          document.getElementById('incCross').textContent = addrObj.cross ? 'X: ' + addrObj.cross : '';
          document.getElementById('incCallback').textContent = addrObj.phone ? 'CALLBACK: ' + addrObj.phone : '';
        } else {
          document.getElementById('incCity').textContent = '';
          document.getElementById('incCross').textContent = '';
          document.getElementById('incCallback').textContent = '';
        }

        // Parse structural tags out of notes before displaying
        const _cbTagMatch = (_currentNote || '').match(/\[CB:([^\]]+)\]/i);
        const _isMutualAid = /\[MA\]/i.test(_currentNote || '');
        // Strip ALL bracket tags ([CB:...], [DISP:...], [MA], [PP:...], [HOLD:...], etc.)
        const _cleanNote = (_currentNote || '').replace(/\[[^\]]*\]/g, '').replace(/\s{2,}/g, ' ').trim();

        // MA badge
        const maBadgeEl = document.getElementById('incMaBadge');
        if (maBadgeEl) maBadgeEl.style.display = _isMutualAid ? 'inline-block' : 'none';

        // Call-specific callback from [CB:] tag
        const cbFromNoteEl = document.getElementById('incCbFromNote');
        if (cbFromNoteEl) {
          if (_cbTagMatch) {
            cbFromNoteEl.textContent = 'CB (CALL): ' + _cbTagMatch[1].toUpperCase();
            cbFromNoteEl.style.display = '';
          } else {
            cbFromNoteEl.style.display = 'none';
          }
        }

        // Notes (scrollable if long) — show cleaned text only
        const notesContainer = document.getElementById('incNotesContainer');
        const notesText = document.getElementById('incNotes');
        if (_cleanNote) {
          notesContainer.style.display = '';
          notesText.textContent = _cleanNote;
        } else {
          notesContainer.style.display = 'none';
        }

        // M-5: Times — prefer server-authoritative timestamps; fall back to local _incidentTimes
        // Dispatch time: use inc.dispatch_time, else inc.created_at
        document.getElementById('incTimeDisp').textContent = fmtTime(inc.dispatch_time || inc.created_at);

        // Enroute time: use inc.enroute_time (server), fall back to local cache
        if (inc.enroute_time) {
          document.getElementById('incTimeEnrt').textContent = fmtTime(inc.enroute_time);
          _incidentTimes.enroute = inc.enroute_time; // keep in sync
        } else if (unit.status === 'DE' && unit.updated_at) {
          _incidentTimes.enroute = unit.updated_at;
          document.getElementById('incTimeEnrt').textContent = fmtTime(_incidentTimes.enroute);
        } else {
          document.getElementById('incTimeEnrt').textContent = _incidentTimes.enroute ? fmtTime(_incidentTimes.enroute) : '--:--';
        }

        // On-scene time: use inc.arrival_time (server), fall back to local cache
        if (inc.arrival_time) {
          document.getElementById('incTimeOS').textContent = fmtTime(inc.arrival_time);
          _incidentTimes.onscene = inc.arrival_time;
        } else if (unit.status === 'OS' && unit.updated_at) {
          _incidentTimes.onscene = unit.updated_at;
          document.getElementById('incTimeOS').textContent = fmtTime(_incidentTimes.onscene);
        } else {
          document.getElementById('incTimeOS').textContent = _incidentTimes.onscene ? fmtTime(_incidentTimes.onscene) : '--:--';
        }

        // Transport time: show when available (inc.transport_time)
        const transRowEl = document.getElementById('incTimeTRow');
        const transVal = inc.transport_time;
        if (transVal) {
          document.getElementById('incTimeTrans').textContent = fmtTime(transVal);
          if (transRowEl) transRowEl.style.display = '';
        } else {
          if (transRowEl) transRowEl.style.display = 'none';
        }

        // M-4: At-hospital time: show when available (inc.at_hospital_time)
        const thRowEl = document.getElementById('incTimeTHRow');
        const thVal = inc.at_hospital_time;
        if (thVal) {
          document.getElementById('incTimeTH').textContent = fmtTime(thVal);
          if (thRowEl) thRowEl.style.display = '';
        } else {
          if (thRowEl) thRowEl.style.display = 'none';
        }

        // Live elapsed counter — shows time in current field status
        const elapsedRowEl = document.getElementById('incTimeElapsedRow');
        const elapsedEl = document.getElementById('incTimeElapsed');
        if (elapsedRowEl && elapsedEl) {
          const st = (unit.status || '').toUpperCase();
          let elapsedTs = null;
          if (st === 'D') elapsedTs = inc.dispatch_time || inc.created_at;
          else if (st === 'DE') elapsedTs = inc.enroute_time || _incidentTimes.enroute;
          else if (st === 'OS') elapsedTs = inc.arrival_time || _incidentTimes.onscene;
          else if (st === 'T') elapsedTs = inc.transport_time;
          else if (st === 'TH') elapsedTs = inc.at_hospital_time;
          if (elapsedTs) {
            elapsedEl.textContent = elapsedStr(elapsedTs);
            elapsedRowEl.style.display = '';
          } else {
            elapsedRowEl.style.display = 'none';
          }
        }

        // Other units
        document.getElementById('incUnits').textContent = inc.units ? 'UNITS: ' + inc.units : '';

        // Cache for offline
        cacheCallInfo({
          incident: unit.incident,
          nature: _currentNature,
          address: destAddr,
          note: _currentNote,
          units: inc.units || '',
          priority: inc.priority || '',
          ts: Date.now()
        });
      } else {
        // Incident not found in state (rare)
        _currentNature = '';
        _currentDestination = unit.destination || '';
        document.getElementById('incNature').textContent = '';
        document.getElementById('incAddress').textContent = resolveAddr(_currentDestination);
        document.getElementById('incCity').textContent = '';
        document.getElementById('incCross').textContent = '';
        document.getElementById('incCallback').textContent = '';
        const _cbFNEl = document.getElementById('incCbFromNote');
        if (_cbFNEl) _cbFNEl.style.display = 'none';
        const _maBEl = document.getElementById('incMaBadge');
        if (_maBEl) _maBEl.style.display = 'none';
        document.getElementById('incNotesContainer').style.display = 'none';
        document.getElementById('incUnits').textContent = '';
        // Hide scene row (Change 1)
        document.getElementById('fieldSceneRow').style.display = 'none';
        document.getElementById('fieldSceneAddr').textContent = '';
      }

    } else {
      // No incident - show "NO ACTIVE INCIDENT" state
      _currentIncident = '';
      _currentNature = '';
      _currentDestination = '';
      _currentNote = '';
      _incidentTimes = {};

      panel.classList.add('no-incident');
      panel.classList.remove('has-incident');
      noIncView.style.display = '';
      hasIncView.style.display = 'none';
    }

    // Update handoff button and destination quick-select after incident state changes
    _updateHandoffBtn();
    _updateDestQuickRow(state);
  }

  function _updateDestQuickRow(state) {
    const row = document.getElementById('destQuickRow');
    if (!row) return;
    if ((_currentStatus === 'D' || _currentStatus === 'DE') && _currentIncident) {
      const dests = (state && state.destinations) || [];
      if (dests.length) {
        row.style.display = '';
        row.innerHTML = dests.map(function(d) {
          const cls = 'dest-quick-btn' + (d.diverted ? ' dest-diverted' : '');
          const label = esc(d.name || d.code) + (d.diverted ? ' [DIV]' : '');
          return '<button class="' + cls + '" data-dest="' + esc(d.code) + '">' + label + '</button>';
        }).join('');
        row.querySelectorAll('.dest-quick-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            const code = btn.dataset.dest;
            API.upsertUnit(_cadToken, _cadCallsign, { destination: code }, '').then(function(res) {
              if (res.ok) {
                _currentDestination = code;
                feedSys('DEST SET: ' + code);
                pollOnce();
              } else {
                feedErr('DEST FAILED: ' + (res.error || 'UNKNOWN'));
              }
            });
          });
        });
        return;
      }
    }
    row.style.display = 'none';
  }

  // ════════════════════════════════════════════════════════════════════════════
  // NEXT CALL PANEL — Phase 2E stacked assignment
  // ════════════════════════════════════════════════════════════════════════════
  function updateNextCallPanel(stack) {
    var panel = document.getElementById('nextCallPanel');
    if (!panel) return;

    // Find queued (non-primary) assignments
    var queued = (stack || []).filter(function(a) { return !a.is_primary && !a.cleared_at; });

    // Detect new queued calls for tone
    var newIds = queued.map(function(a) { return a.incident_id; }).join(',');
    if (newIds && newIds !== _prevQueuedIds) {
      var brandNew = queued.filter(function(a) {
        return _prevQueuedIds.indexOf(a.incident_id) === -1;
      });
      if (brandNew.length) {
        _startStackAlert();
        brandNew.forEach(function(a) {
          var dest = a.destination ? ' \u2192 ' + a.destination : '';
          var type = a.incident_type ? ' [' + a.incident_type + ']' : '';
          feedAlert('[' + nowTS() + '] *** STACKED CALL: ' + esc(a.incident_id) + esc(type) + esc(dest) + ' ***');
        });
        _notify('STACKED CALL', brandNew.map(function(a) {
          return (a.incident_type || a.incident_id) + (a.destination ? ' \u2192 ' + a.destination : '');
        }).join(' | '), 'cad-stack-' + Date.now(), true);
      }
    }
    // Detect cancelled queued calls
    if (_prevQueuedIds) {
      var prevArr = _prevQueuedIds.split(',').filter(Boolean);
      prevArr.forEach(function(id) {
        if (!queued.find(function(a) { return a.incident_id === id; })) {
          feedAppend('<span class="cmd-sys">STAGED CALL ' + esc(id) + ' CANCELLED BY DISPATCH.</span>');
        }
      });
    }
    _prevQueuedIds = newIds;

    // Update CALLS tab badge — show count of open (unassigned) incidents
    var _callsBadge = document.getElementById('callsTabBadge');
    if (_callsBadge) {
      var _allActiveIncs = (_lastState && _lastState.incidents) || [];
      var _openCount = _allActiveIncs.filter(function(i) {
        if (i.status !== 'ACTIVE' && i.status !== 'QUEUED') return false;
        var u = Array.isArray(i.units) ? i.units : (i.units ? String(i.units).split(',').map(function(s){return s.trim();}).filter(Boolean) : []);
        return u.length === 0;
      }).length;
      if (_openCount > 0 && _activeTab !== 'calls') {
        _callsBadge.textContent = _openCount;
        _callsBadge.classList.add('visible');
      } else {
        _callsBadge.textContent = '';
        _callsBadge.classList.remove('visible');
      }
    }

    if (!queued.length) {
      panel.style.display = 'none';
      return;
    }

    var next = queued[0];
    panel.style.display = '';

    // Priority border color
    var pri = (next.priority || '').toUpperCase();
    panel.classList.remove('ncp-pri1','ncp-pri2','ncp-pri3','ncp-pri4');
    if (pri === 'PRI-1' || pri === 'CRITICAL') panel.classList.add('ncp-pri1');
    else if (pri === 'PRI-2') panel.classList.add('ncp-pri2');
    else if (pri === 'PRI-3') panel.classList.add('ncp-pri3');
    else if (pri === 'PRI-4') panel.classList.add('ncp-pri4');

    // Priority badge — use inc-priority-1/2/3/4 classes (M-1)
    var priEl = document.getElementById('nextCallPri');
    if (priEl) {
      priEl.className = 'inc-priority';
      priEl.textContent = pri || 'ROUTINE';
      if (pri === 'PRI-1' || pri === 'CRITICAL') priEl.classList.add('inc-priority-1');
      else if (pri === 'PRI-2') priEl.classList.add('inc-priority-2');
      else if (pri === 'PRI-3') priEl.classList.add('inc-priority-3');
      else if (pri === 'PRI-4') priEl.classList.add('inc-priority-4');
      else priEl.classList.add('inc-priority-3');
    }

    // Type
    var typeEl = document.getElementById('nextCallType');
    if (typeEl) typeEl.textContent = next.incident_type || next.incident_id || '';

    // Destination
    var destEl = document.getElementById('nextCallDest');
    if (destEl) destEl.textContent = next.destination ? ('\u2192 ' + next.destination) : '';

    // Scene address (if available) — with NAV button
    var ncSceneEl = document.getElementById('nextCallScene');
    var ncSceneTextEl = document.getElementById('nextCallSceneText');
    if (ncSceneEl && ncSceneTextEl) {
      var ncScene = (next.scene_address || '').trim().toUpperCase();
      ncSceneTextEl.textContent = ncScene ? ('SCENE: ' + ncScene) : '';
      ncSceneEl.style.display = ncScene ? 'flex' : 'none';
    }

    // Note (stripped of bracket tags)
    var ncNoteEl = document.getElementById('nextCallNote');
    if (ncNoteEl) {
      var ncNoteRaw = next.incident_note || '';
      var ncNoteClean = ncNoteRaw.replace(/\[[^\]]*\]/g, '').replace(/\s{2,}/g, ' ').trim().toUpperCase();
      ncNoteEl.textContent = ncNoteClean || '';
      ncNoteEl.style.display = ncNoteClean ? '' : 'none';
    }

    // Count badge — only show if > 3 queued (rows 2+3 are shown inline)
    var countEl = document.getElementById('nextCallCount');
    if (countEl) countEl.textContent = queued.length > 3 ? ('+' + (queued.length - 3) + ' more') : '';

    // Extra rows — show queued[1] and queued[2] inline
    var rowsEl = document.getElementById('nextCallRows');
    if (rowsEl) {
      var extraHtml = '';
      var extras = queued.slice(1, 3);
      extras.forEach(function(a, i) {
        var extraType = a.incident_type || a.incident_id || '';
        var extraDest = a.destination ? (' \u2192 ' + a.destination) : '';
        var shortId   = String(a.incident_id).replace(/^[A-Z]*\d{2}-0*/, '');
        extraHtml += '<div class="next-call-extra-row">' +
          '<span class="next-call-extra-num">' + (i + 2) + '.</span>' +
          '<span>' + esc('INC' + shortId) + '</span>' +
          '<span style="font-weight:700;color:#c9d1d9;">' + esc(extraType) + '</span>' +
          '<span>' + esc(extraDest) + '</span>' +
          '</div>';
      });
      rowsEl.innerHTML = extraHtml;
    }

    // ACK button state
    var ackBtn = document.getElementById('nextCallAck');
    if (ackBtn) {
      if (_ackedIncIds.has(next.incident_id)) {
        ackBtn.textContent = 'ACKED';
        ackBtn.classList.add('acked');
      } else {
        ackBtn.textContent = 'ACK';
        ackBtn.classList.remove('acked');
      }
    }
  }

  function ackNextCall() {
    _stopStackAlert(); // stop repeating tone when crew acks the stacked call
    var queued = (_lastStack || []).filter(function(a) { return !a.is_primary && !a.cleared_at; });
    if (!queued.length) return;
    var next = queued[0];
    _ackedIncIds.add(next.incident_id);
    // Persist acked IDs (keep last 20)
    var arr = Array.from(_ackedIncIds).slice(-20);
    try { localStorage.setItem('hoscadfield_acked', JSON.stringify(arr)); } catch(e) {}
    feedAppend('<span class="cmd-sys">ACK \u2014 WILL RESPOND TO ' + esc(next.incident_id) + '.</span>');
    // Notify board — fire-and-forget (non-blocking)
    if (_cadToken && next.incident_id) {
      API.ackDispatch(_cadToken, next.incident_id).catch(function() {});
    }
    // Update button immediately
    var ackBtn = document.getElementById('nextCallAck');
    if (ackBtn) {
      ackBtn.textContent = 'ACKED';
      ackBtn.classList.add('acked');
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // BANNERS (M-6: with ACK button)
  // ════════════════════════════════════════════════════════════════════════════
  function _renderBanner(el, kind, msg) {
    if (!el) return; // field app hides banners
    if (!msg) {
      el.style.display = 'none';
      // Reset ack state when banner clears
      if (_bannerAckState[kind].msg) {
        _bannerAckState[kind] = { msg: '', acked: false };
      }
      return;
    }
    // Detect new banner message — reset ack so prompt reappears
    if (msg !== _bannerAckState[kind].msg) {
      _bannerAckState[kind] = { msg: msg, acked: false };
    }
    const acked = _bannerAckState[kind].acked;
    el.innerHTML = '';
    // Message text span
    const textSpan = document.createElement('span');
    textSpan.textContent = msg;
    el.appendChild(textSpan);
    // ACK button
    const ackBtn = document.createElement('button');
    ackBtn.className = 'banner-ack-btn' + (acked ? ' acked' : '');
    ackBtn.textContent = acked ? '\u2713 ACKED' : '[ACK]';
    ackBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      ackBanner(kind);
    });
    el.appendChild(ackBtn);
    el.style.display = 'block';
  }

  function ackBanner(kind) {
    if (!_bannerAckState[kind].msg) return;
    _bannerAckState[kind].acked = true;
    feedSys('BANNER ACK: ' + kind.toUpperCase() + ' BANNER ACKNOWLEDGED.');
    // Fire-and-forget to backend (non-blocking)
    if (_cadToken) {
      API.call('bannerAck', _cadToken, kind).catch(function() {});
    }
    // Re-render to show acked state
    const el = document.getElementById(kind + 'Banner');
    if (el) _renderBanner(el, kind, _bannerAckState[kind].msg);
  }

  function updateBanners(state) {
    const alertEl = document.getElementById('alertBanner');
    const noteEl = document.getElementById('noteBanner');
    const alertMsg = state.banners && state.banners.alert ? state.banners.alert.message : '';
    const noteMsg = state.banners && state.banners.note ? state.banners.note.message : '';
    _renderBanner(alertEl, 'alert', alertMsg);
    _renderBanner(noteEl, 'note', noteMsg);
  }

  // ════════════════════════════════════════════════════════════════════════════
  // LOC PANEL — slide-up location input
  // ════════════════════════════════════════════════════════════════════════════
  function toggleFieldLocPanel() {
    const panel = document.getElementById('fieldLocPanel');
    const btn   = document.getElementById('fieldLocBtn');
    if (!panel) return;
    const isOpen = panel.style.display !== 'none';
    panel.style.display = isOpen ? 'none' : '';
    if (btn) btn.classList.toggle('loc-active', !isOpen);
    if (!isOpen) {
      // Pre-fill with current LOC tag if set
      const myUnit = _mergedUnits[(_cadCallsign || '').toUpperCase()];
      const cur = myUnit ? _parseLocTag(myUnit.note) : '';
      const input = document.getElementById('fieldLocInput');
      if (input) { input.value = cur; setTimeout(function() { input.focus(); }, 60); }
    }
  }

  function closeFieldLocPanel() {
    const panel = document.getElementById('fieldLocPanel');
    const btn   = document.getElementById('fieldLocBtn');
    if (panel) panel.style.display = 'none';
    if (btn)   btn.classList.remove('loc-active');
  }

  async function setFieldLoc() {
    const input = document.getElementById('fieldLocInput');
    if (!input) return;
    const addr = input.value.trim().toUpperCase();
    if (!addr) return;
    if (!_cadToken || !_cadCallsign) return;
    const myUnit  = _mergedUnits[_cadCallsign.toUpperCase()];
    const rawNote = (myUnit && myUnit.note) || '';
    const clean   = rawNote.replace(/\[LOC:[^\]]*\]\s*/g, '').trim();
    const newNote = '[LOC:' + addr + ']' + (clean ? ' ' + clean : '');
    try {
      const res = await API.upsertUnit(_cadToken, _cadCallsign, { note: newNote });
      if (res.ok) { feedSys('LOC: ' + addr); closeFieldLocPanel(); }
      else feedErr('LOC FAILED: ' + (res.error || 'UNKNOWN'));
    } catch(e) { feedErr('LOC FAILED: OFFLINE'); }
  }

  async function clearFieldLoc() {
    if (!_cadToken || !_cadCallsign) return;
    const myUnit  = _mergedUnits[_cadCallsign.toUpperCase()];
    const rawNote = (myUnit && myUnit.note) || '';
    const clean   = rawNote.replace(/\[LOC:[^\]]*\]\s*/g, '').trim();
    try {
      const res = await API.upsertUnit(_cadToken, _cadCallsign, { note: clean });
      if (res.ok) {
        feedSys('LOC CLEARED.');
        const input = document.getElementById('fieldLocInput');
        if (input) input.value = '';
        closeFieldLocPanel();
      } else feedErr('LOC CLEAR FAILED: ' + (res.error || 'UNKNOWN'));
    } catch(e) { feedErr('LOC CLEAR FAILED: OFFLINE'); }
  }

  // Enter key in LOC input triggers SET
  document.getElementById('fieldLocInput') && document.getElementById('fieldLocInput')
    .addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); setFieldLoc(); } });

  // Expose functions for inline onclick use (IIFE scope requires explicit window assignment)
  window.ackBanner            = ackBanner;
  window.toggleFieldLocPanel  = toggleFieldLocPanel;
  window.closeFieldLocPanel   = closeFieldLocPanel;
  window.setFieldLoc          = setFieldLoc;
  window.clearFieldLoc        = clearFieldLoc;
  window.openPinChangeDialog  = openPinChangeDialog;
  window.closePinChangeDialog = closePinChangeDialog;
  window.savePinChange        = savePinChange;

  // ════════════════════════════════════════════════════════════════════════════
  // ── PIN change dialog ──────────────────────────────────────────────
  function openPinChangeDialog() {
    document.getElementById('pinChangeCadLabel').textContent = 'ENTER YOUR CAD ID AND CURRENT PIN TO VERIFY.';
    document.getElementById('pinChangeCadId').value = '';
    document.getElementById('pinChangeCurrent').value = '';
    document.getElementById('pinChangeNew').value = '';
    document.getElementById('pinChangeConfirm').value = '';
    document.getElementById('pinChangeErr').textContent = '';
    document.getElementById('pinChangeDialog').style.display = 'flex';
    document.getElementById('pinChangeCadId').focus();
  }

  function closePinChangeDialog() {
    document.getElementById('pinChangeDialog').style.display = 'none';
  }

  async function savePinChange() {
    const cadId   = (document.getElementById('pinChangeCadId').value || '').trim();
    const current = (document.getElementById('pinChangeCurrent').value || '').trim();
    const newPin  = (document.getElementById('pinChangeNew').value || '').trim();
    const confirm = (document.getElementById('pinChangeConfirm').value || '').trim();
    const errEl   = document.getElementById('pinChangeErr');
    errEl.textContent = '';

    if (!cadId)   { errEl.textContent = 'ENTER YOUR CAD ID.'; return; }
    if (!current) { errEl.textContent = 'ENTER YOUR CURRENT PIN.'; return; }
    if (!newPin)  { errEl.textContent = 'ENTER A NEW PIN.'; return; }
    if (!/^\d{4,6}$/.test(newPin)) { errEl.textContent = 'PIN MUST BE 4-6 DIGITS.'; return; }
    if (newPin !== confirm) { errEl.textContent = 'PINS DO NOT MATCH.'; return; }

    const btn = document.getElementById('btnPinChangeSave');
    btn.disabled = true;
    btn.textContent = 'SAVING...';

    const res = await API.changeCrewPin(cadId, current, newPin);
    btn.disabled = false;
    btn.textContent = 'SAVE';

    if (!res.ok) { errEl.textContent = res.error || 'FAILED.'; return; }
    closePinChangeDialog();
    feedSys('PIN CHANGED SUCCESSFULLY.');
  }

  // NIGHT MODE
  // ════════════════════════════════════════════════════════════════════════════
  function checkNightMode() {
    if (_nightOverride !== null) {
      document.body.classList.toggle('night-mode', _nightOverride);
      return;
    }
    const h = new Date().getHours();
    const isNight = (h >= 18 || h < 6);
    document.body.classList.toggle('night-mode', isNight);
  }

  function toggleNightMode() {
    const isOn = document.body.classList.contains('night-mode');
    _nightOverride = !isOn;
    document.body.classList.toggle('night-mode', !isOn);
    try { localStorage.setItem('hoscadfield_nightoverride', String(_nightOverride)); } catch(e) {}
    _updateMoreTab();
  }

  function loadNightOverride() {
    try {
      const v = localStorage.getItem('hoscadfield_nightoverride');
      if (v === 'true') _nightOverride = true;
      else if (v === 'false') _nightOverride = false;
      else _nightOverride = null;
    } catch(e) { _nightOverride = null; }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // SCREEN WAKE LOCK — keeps screen on so polling never stops in the field
  // Also requests notification permission (must be inside a user gesture on iOS)
  // ════════════════════════════════════════════════════════════════════════════
  let _wakeLock = null;

  function _setWakeStatus(on) {
    var ws = document.getElementById('moreWakeStatus');
    if (ws) ws.textContent = on ? 'ON' : 'OFF';
  }

  async function toggleWakeLock() {
    // Request notification permission — must be inside a direct user gesture (iOS)
    if ('Notification' in window && Notification.permission === 'default') {
      try { await Notification.requestPermission(); } catch(e) {}
    }

    // Request GPS location permission
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        function() { feedSys('GPS: LOCATION PERMISSION GRANTED.'); },
        function(e) { feedSys('GPS: LOCATION ' + (e.code === 1 ? 'PERMISSION DENIED.' : 'NOT AVAILABLE.')); },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
      );
    }

    if (_wakeLock) {
      try { await _wakeLock.release(); } catch(e) {}
      _wakeLock = null;
      _setWakeStatus(false);
      feedSys('SCREEN WAKE LOCK OFF.');
      _updateMoreTab();
      return;
    }

    if (!('wakeLock' in navigator)) {
      feedSys('WAKE LOCK NOT SUPPORTED ON THIS DEVICE.');
      return;
    }

    try {
      _wakeLock = await navigator.wakeLock.request('screen');
      _setWakeStatus(true);
      feedSys('SCREEN WAKE LOCK ON \u2014 SCREEN WILL STAY AWAKE.');

      _wakeLock.addEventListener('release', function() {
        _wakeLock = null;
        _setWakeStatus(false);
        _updateMoreTab();
      });

      document.addEventListener('visibilitychange', async function reacquire() {
        if (document.visibilityState === 'visible' && !_wakeLock) {
          try {
            _wakeLock = await navigator.wakeLock.request('screen');
            _setWakeStatus(true);
            _wakeLock.addEventListener('release', function() {
              _wakeLock = null;
              _setWakeStatus(false);
              _updateMoreTab();
            });
          } catch(e) {}
        }
        if (!_wakeLock) document.removeEventListener('visibilitychange', reacquire);
      });
      _updateMoreTab();
    } catch(e) {
      feedSys('WAKE LOCK FAILED: ' + (e.message || e));
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // NAVIGATION DEEP-LINKS (Change 1)
  // ════════════════════════════════════════════════════════════════════════════
  function openNavScene() {
    const addr = document.getElementById('fieldSceneAddr').textContent.trim();
    if (addr && addr !== '—') window.open('https://maps.google.com/?q=' + encodeURIComponent(addr), '_blank');
  }

  function openNavNextCall() {
    const el = document.getElementById('nextCallSceneText');
    const addr = el ? el.textContent.replace(/^SCENE:\s*/i, '').trim() : '';
    if (addr) window.open('https://maps.google.com/?q=' + encodeURIComponent(addr), '_blank');
  }

  function openNavDest() {
    // Resolve the destination code to a full address string for navigation
    if (!_currentDestination) return;
    const addrObj = getAddrDetails(_currentDestination);
    let navStr = '';
    if (addrObj) {
      navStr = [addrObj.address, addrObj.city, addrObj.state, addrObj.zip].filter(Boolean).join(', ');
    }
    if (!navStr) navStr = resolveAddr(_currentDestination);
    if (navStr && navStr !== '--') window.open('https://maps.google.com/?q=' + encodeURIComponent(navStr), '_blank');
  }

  // ════════════════════════════════════════════════════════════════════════════
  // COMMAND AREA (console now on STATUS tab — no collapsible needed)
  // ════════════════════════════════════════════════════════════════════════════
  function toggleCmdArea() { /* no-op — console is always visible on STATUS tab */ }

  function restoreCmdCollapsed() {
    // no-op — collapsible removed; console always visible on STATUS tab
  }

  // ════════════════════════════════════════════════════════════════════════════
  // FIELD TOAST (Change 5)
  // ════════════════════════════════════════════════════════════════════════════
  function showFieldToast(msg, type) {
    feedSys('[NOTICE] ' + msg);
  }

  // ════════════════════════════════════════════════════════════════════════════
  // HANDOFF BUTTON (Change 5)
  // ════════════════════════════════════════════════════════════════════════════
  async function fieldHandoff() {
    if (!_cadCallsign || !_currentIncident) {
      showFieldToast('NO ACTIVE INCIDENT FOR HANDOFF.', 'warn');
      return;
    }
    var note = await promptClearNote('PATIENT HANDOFF');
    if (note === null) return; // cancelled
    feedSys('RECORDING HANDOFF...');
    try {
      if (note) {
        try { await API.appendIncidentNote(_cadToken, _currentIncident, note); } catch(e) {}
      }
      const r = await API.handoffUnit(_cadToken, _cadCallsign, '');
      if (r.ok) {
        _stopDispatchAlert();
        _toneStatus();
        feedSys('HANDOFF COMPLETE. STATUS: AV');
        _pendingStatus = 'AV';
        _currentStatus = 'AV';
        updateStatusBadge('AV');
        pollOnce();
      } else {
        feedErr('HANDOFF FAILED: ' + (r.error || 'UNKNOWN'));
      }
    } catch(e) {
      feedErr('HANDOFF FAILED: NETWORK ERROR.');
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // UNREAD MESSAGE BADGE (Change 5)
  // ════════════════════════════════════════════════════════════════════════════
  let _unreadMessages = 0;

  function updateMsgBadge() {
    const badge = document.getElementById('fieldMsgBadge');
    if (badge) {
      if (_unreadMessages > 0) {
        badge.textContent = _unreadMessages;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }
    // Also show on MORE tab nav button
    var tabBadge = document.getElementById('moreTabBadge');
    if (tabBadge) {
      tabBadge.textContent = _unreadMessages > 0 ? _unreadMessages : '';
      tabBadge.classList.toggle('visible', _unreadMessages > 0);
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // SHOW/HIDE
  // ════════════════════════════════════════════════════════════════════════════
  function showField(callsign) {
    loginScreen.style.display = 'none';
    fieldPanel.classList.remove('hidden');
    fieldPanel.style.display = 'flex';
    callsignLabel.textContent = callsign;

    // Show bottom nav
    var nav = document.getElementById('bottomNav');
    if (nav) nav.classList.add('visible');

    // Restore last saved tab, default to STATUS when no active call
    var savedTab = '';
    try { savedTab = localStorage.getItem('hoscadfield_tab') || ''; } catch(e) {}
    var startTab = savedTab || (_currentIncident ? 'mycall' : 'status');
    if (!TAB_MAP[startTab]) startTab = 'mycall';
    switchTab(startTab);
    _updateMoreTab();
  }

  function showLogin() {
    loginScreen.style.display = 'flex';
    fieldPanel.classList.add('hidden');
    fieldPanel.style.display = 'none';
    callsignLabel.textContent = '';
    cadUnitStatus.textContent = '--';
    cadUnitStatus.className = 'cad-unit-status';
    cmdFeed.innerHTML = '<div class="cmd-feed-line"><span class="cmd-sys">HOSCAD FIELD READY. TYPE HELP FOR COMMANDS.</span></div>';
    const _ab = document.getElementById('alertBanner'); if (_ab) _ab.style.display = 'none';
    const _nb = document.getElementById('noteBanner'); if (_nb) _nb.style.display = 'none';
    // Always show crew PIN section on login screen — stale cache must not hide it
    var crewSec = document.getElementById('crewPinLoginSection');
    if (crewSec) crewSec.style.display = '';
    // Reset incident panel
    const panel = document.getElementById('incidentPanel');
    panel.classList.add('no-incident');
    panel.classList.remove('has-incident');
    document.getElementById('noIncidentView').style.display = '';
    document.getElementById('hasIncidentView').style.display = 'none';
    // Hide bottom nav + reset tab state
    var nav = document.getElementById('bottomNav');
    if (nav) nav.classList.remove('visible');
    _activeTab = 'mycall';
    _mapTabInitialized = false;
    if (_fieldMapTabObj) {
      try { _fieldMapTabObj.remove(); } catch(e) {}
      _fieldMapTabObj = null;
      _fieldMapTabLayers = [];
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // SESSION
  // ════════════════════════════════════════════════════════════════════════════
  function saveSession() {
    try {
      localStorage.setItem('hoscadfield_token', _cadToken || '');
      localStorage.setItem('hoscadfield_callsign', _cadCallsign || '');
      localStorage.setItem('hoscadfield_unitinfo', _cadUnitInfo || '');
    } catch(e) {}
  }

  function loadSession() {
    try {
      _cadToken = localStorage.getItem('hoscadfield_token') || '';
      _cadCallsign = localStorage.getItem('hoscadfield_callsign') || '';
      _cadUnitInfo = localStorage.getItem('hoscadfield_unitinfo') || '';
    } catch(e) {}
  }

  function clearSession() {
    try {
      localStorage.removeItem('hoscadfield_token');
      localStorage.removeItem('hoscadfield_callsign');
      localStorage.removeItem('hoscadfield_unitinfo');
      localStorage.removeItem('hoscadfield_callcache');
      localStorage.removeItem('hoscadfield_queue');
    } catch(e) {}
    _cadToken = null;
    _cadCallsign = '';
    _cadUnitInfo = '';
    _mergedUnits = {};
    _mergedIncidents = {};
    _lastTs = null;
    // Reset per-session state so a fresh login doesn't inherit old session data
    _currentIncident = '';
    _currentStatus = 'AV';
    _currentNature = '';
    _currentDestination = '';
    _currentNote = '';
    _lastStack = [];
    _prevQueuedIds = '';
    _ackedIncIds.clear();
    _fieldGpsPos = null;
    stopGpsAuto();
    // Clear command feed (don't leak previous unit's messages into new session)
    var feed = document.getElementById('cmdFeed');
    if (feed) feed.innerHTML = '<div class="cmd-feed-line"><span class="cmd-sys">SESSION ENDED. LOGGED OUT.</span></div>';
  }

  // ════════════════════════════════════════════════════════════════════════════
  // CAD LOGIN / LOGOUT
  // ════════════════════════════════════════════════════════════════════════════
  async function cadLogin(callsign, unitInfo, crewAssignments) {
    const res = await API.login('UNIT', callsign, '');
    if (!res.ok) {
      // If backend requires a password change, this account must be reset from the dispatcher board
      if (res.mustChangePassword) return 'PASSWORD RESET REQUIRED — LOG IN FROM DISPATCHER BOARD FIRST.';
      return res.error || 'CAD LOGIN FAILED';
    }

    const info = await API.getUnitInfo(res.token, callsign.toUpperCase());
    if (info.ok && !info.everSeen) {
      const confirmed = await showConfirm(
        'NEW UNIT',
        `"${callsign.toUpperCase()}" HAS NEVER LOGGED ON.\nCONFIRM THIS IS NOT A DUPLICATE OR TYPO?`
      );
      if (!confirmed) {
        await API.logout(res.token);
        return 'LOGON CANCELLED.';
      }
    }

    _cadToken = res.token;
    _cadCallsign = callsign.toUpperCase();
    _cadUnitInfo = unitInfo;
    _loginTime = new Date();
    _knownMsgIds.clear();
    _unreadMessages = 0;
    _pendingStatus = null;
    // Reset merged caches on fresh login so stale data from a previous session
    // cannot appear as a false "new incident" notification.
    _mergedUnits = {};
    _mergedIncidents = {};
    _lastTs = null;
    updateMsgBadge();
    saveSession();

    // Only set status 'AV' for brand new units. Existing units (reconnecting while
    // enroute, on scene, etc.) must preserve their current DB status — overwriting
    // with AV would desync the board and clear active incident assignments.
    const isNewUnit = info.ok && !info.everSeen;
    // If the existing note was stamped [TEMP] by a dispatcher LUI command, clear it on real logon
    const hasStaleTemp = info.ok && info.unit && (info.unit.note || '').includes('[TEMP]');
    const upsert = await API.upsertUnit(_cadToken, _cadCallsign, {
      active: true,
      ...(isNewUnit ? { status: 'AV' } : {}),
      ...(hasStaleTemp ? { note: '' } : {}),
      ...(_cadUnitInfo ? { unitInfo: _cadUnitInfo } : {}),
      ...(crewAssignments && crewAssignments.length ? { crewAssignments } : {})
    });
    if (!upsert.ok) console.warn('[field] Unit upsert failed:', upsert.error);

    // Only set AV badge for brand-new units. Existing units keep their current
    // DB status — the first poll will immediately set the correct badge.
    if (isNewUnit) updateStatusBadge('AV');
    loadAddresses();

    // Notification permission is requested via the WAKE button (must be a direct user gesture on iOS)
    loadNightOverride();
    checkNightMode();
    startPolling();
    startGpsAuto();

    // Show password-change warning if backend flagged this account (once per session)
    if (res.mustChangePassword) {
      const overlay = document.getElementById('mustChangePwOverlay');
      if (overlay) overlay.style.display = 'flex';
    }

    return null;
  }

  async function cadLogout() {
    stopPolling();
    stopGpsAuto();
    if (_cadToken && _cadCallsign) {
      // Use logoffUnit (not upsertUnit) so the vehicle_assignments hook fires on self-logoff
      try { await API.logoffUnit(_cadToken, _cadCallsign, ''); } catch(e) {}
      try { await API.logout(_cadToken); } catch(e) {}
    }
    clearSession();
  }

  // ════════════════════════════════════════════════════════════════════════════
  // REALTIME — triggered-poll via Supabase Realtime WebSocket
  // pollOnce() is guarded by _pollInFlight so concurrent calls are dropped.
  // ════════════════════════════════════════════════════════════════════════════
  function _fieldRtSend(msg) {
    if (_fieldRT && _fieldRT.readyState === WebSocket.OPEN) {
      try { _fieldRT.send(JSON.stringify(msg)); } catch(e) {}
    }
  }

  function _fieldRtConnect() {
    if (_fieldRT && (_fieldRT.readyState === WebSocket.OPEN || _fieldRT.readyState === WebSocket.CONNECTING)) return;
    var url = 'wss://vnqiqxffedudfsdoadqg.supabase.co/realtime/v1/websocket?apikey=' + API._apiKey + '&vsn=1.0.0';
    try { _fieldRT = new WebSocket(url); } catch(e) { return; }
    _fieldRT.onopen = function() {
      _fieldRtRef = 0;
      _fieldRtSend({ topic: 'realtime:units', event: 'phx_join', payload: {
        config: { broadcast: { self: false }, presence: { key: '' },
          postgres_changes: [{ event: '*', schema: 'public', table: 'units' }] }
      }, ref: String(++_fieldRtRef) });
      _fieldRtSend({ topic: 'realtime:incidents', event: 'phx_join', payload: {
        config: { broadcast: { self: false }, presence: { key: '' },
          postgres_changes: [{ event: '*', schema: 'public', table: 'incidents' }] }
      }, ref: String(++_fieldRtRef) });
      if (_fieldRtHbTimer) clearInterval(_fieldRtHbTimer);
      _fieldRtHbTimer = setInterval(function() {
        _fieldRtSend({ topic: 'phoenix', event: 'heartbeat', payload: {}, ref: 'hb' });
      }, 25000);
      pollOnce(); // catch any state changes missed during disconnect gap
    };
    _fieldRT.onmessage = function(e) {
      try {
        var msg = JSON.parse(e.data);
        if (msg.event === 'postgres_changes') {
          pollOnce();
        }
      } catch(err) {}
    };
    _fieldRT.onclose = function() {
      if (_fieldRtHbTimer) { clearInterval(_fieldRtHbTimer); _fieldRtHbTimer = null; }
      if (!_cadToken) return; // Logged out — do not reconnect
      if (_fieldRtReconTimer) clearTimeout(_fieldRtReconTimer);
      _fieldRtReconTimer = setTimeout(_fieldRtConnect, 5000);
    };
    _fieldRT.onerror = function() {
      try { _fieldRT.close(); } catch(e) {}
    };
  }

  function _fieldRtDisconnect() {
    if (_fieldRtHbTimer) { clearInterval(_fieldRtHbTimer); _fieldRtHbTimer = null; }
    if (_fieldRtReconTimer) { clearTimeout(_fieldRtReconTimer); _fieldRtReconTimer = null; }
    if (_fieldRT) { try { _fieldRT.close(); } catch(e) {} _fieldRT = null; }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // POLLING
  // ════════════════════════════════════════════════════════════════════════════
  function startPolling() {
    stopPolling();
    pollOnce();
    _pollTimer = setInterval(pollOnce, 10000);
    _fieldRtConnect();
  }

  function stopPolling() {
    if (_pollTimer) { clearInterval(_pollTimer); _pollTimer = null; }
    _fieldRtDisconnect();
  }

  // Apply feature flags to field UI.
  // fromServer=true means the value came from a live server poll (reliable).
  // fromServer=false (default) means it's from the localStorage cache (startup only).
  // crew_pin_login is security-sensitive: NEVER hide the crew section from a stale
  // cache — only hide it when the server explicitly confirms the flag is off.
  function applyFieldFeatureFlags(ff, fromServer) {
    var crewSec = document.getElementById('crewPinLoginSection');
    if (crewSec) {
      var hideCrewSection = fromServer && ff.crew_pin_login === false;
      crewSec.style.display = hideCrewSection ? 'none' : '';
    }
  }
  // Apply on page load from cache — crew_pin_login is intentionally NOT applied
  // here (fromServer omitted/false), so the crew section is always visible at startup.
  applyFieldFeatureFlags(_fieldFF);

  let _pollInFlight = false;
  async function pollOnce() {
    if (!_cadToken || _pollInFlight) return;
    _pollInFlight = true;
    try {
      const state = await API.getState(_cadToken);
      if (!state.ok) {
        if (state.error && state.error.includes('NETWORK ERROR')) setOnline(false);
        if (state.error && (state.error.includes('TOKEN EXPIRED') || state.error.includes('NOT AUTHENTICATED'))) {
          _stopDispatchAlert();
          stopPolling();
          feedErr('SESSION ENDED. RETURNING TO LOGIN.');
          _toneUrgent();
          setTimeout(function() {
            _cadToken = ''; _cadCallsign = '';
            showLogin();
          }, 1500);
        }
        return;
      }

      setOnline(true);
      _lastState = state;
      // Merge new state into persistent caches BEFORE reading myUnit.
      // This ensures that if this poll is a delta and the field unit's own row
      // was not included (e.g. because updated_at didn't change), the last
      // known unit state is still available in _mergedUnits.
      _mergeState(state);
      // Update + persist feature flags on every successful poll
      if (state.featureFlags) {
        _fieldFF = state.featureFlags;
        try { localStorage.setItem('hoscad_field_ff', JSON.stringify(_fieldFF)); } catch(e) {}
        applyFieldFeatureFlags(_fieldFF, true); // fromServer=true: safe to apply crew_pin_login
      }
      updateBanners(state);

      // Find own unit from the MERGED cache, not just from state.units.
      // Fallback order: (1) freshly received row in this response, (2) cached row.
      const myUnit = _mergedUnits[_cadCallsign.toUpperCase()] || null;

      // Detect dispatcher LOGOFF — if unit went inactive, end field session
      if (myUnit && myUnit.active === false) {
        _stopDispatchAlert();
        feedAlert('[' + nowTS() + '] *** UNIT LOGGED OFF BY DISPATCH ***');
        _toneUrgent();
        _notify('LOGGED OFF', _cadCallsign + ' logged off by dispatch', 'cad-logoff-' + Date.now(), true);
        setTimeout(function() {
          cadLogout().catch(function(){});
          showLogin();
        }, 2000);
        return;
      }

      if (myUnit) {
        const prevStatus = _currentStatus;
        const prevIncident = _currentIncident;
        const prevNature = _currentNature;
        const prevDest = _currentDestination;
        const prevNote = _currentNote;

        updateStatusBadge(myUnit.status || 'AV');
        // Pass _lastState (which has fully merged incidents) so updateIncidentPanel
        // can look up the incident details even on a delta response that may not
        // contain the incident row itself.
        updateIncidentPanel(myUnit, _lastState);
        updateFieldLocation(myUnit, _lastState);

        // ══════════════════════════════════════════════════════════════════
        // AUDIO NOTIFICATION LOGIC FOR FIELD CAD
        // ══════════════════════════════════════════════════════════════════

        // Clear _pendingStatus once the server confirms it (suppresses false dispatch tones).
        if (_pendingStatus !== null && _currentStatus === _pendingStatus) {
          _pendingStatus = null;
        }

        // 1. NEW INCIDENT ASSIGNED - DISPATCH TONE (3× repeat) + PANEL FLASH
        if (_currentIncident && prevIncident !== _currentIncident) {
          feedAlert('[' + nowTS() + '] *** NEW CALL: INC ' + _currentIncident + ' ***');
          _startDispatchAlert();
          // Flash the incident panel border so the alert is visible even when
          // the command area is collapsed or the screen is partially obscured.
          (function() {
            var panel = document.getElementById('incidentPanel');
            if (panel) {
              panel.classList.add('new-call-flash');
              setTimeout(function() { panel.classList.remove('new-call-flash'); }, 3000);
            }
          })();
          _notify('NEW CALL: INC ' + _currentIncident,
            (_currentNature || 'INCIDENT') + ' - ' + resolveAddr(_currentDestination),
            'cad-inc-' + _currentIncident, true);
        }

        // 2. CALL CANCELLED WHILE UNIT HAS ACTIVE INCIDENT - STATUS TONE
        // Fires for any active working status (DE, OS, T, TH, D) — not just enroute.
        else if (prevIncident && !_currentIncident) {
          _stopDispatchAlert(); // stop any pending dispatch alert
          feedAlert('[' + nowTS() + '] *** CALL CANCELLED ***');
          _toneStatus();
          _notify('CALL CANCELLED', 'INC ' + prevIncident + ' has been cancelled',
            'cad-cancel-' + Date.now(), true);
        }

        // 3. NATURE/TYPE UPGRADE - URGENT TONE if critical
        else if (_currentIncident && prevNature !== _currentNature && _currentNature) {
          const wasUrgent = isUrgentNature(prevNature);
          const nowUrgent = isUrgentNature(_currentNature);
          if (nowUrgent && !wasUrgent) {
            feedAlert('[' + nowTS() + '] *** CALL UPGRADED: ' + _currentNature + ' ***');
            _toneStatus();
            _notify('CALL UPGRADED', 'Nature changed to: ' + _currentNature,
              'cad-upgrade-' + Date.now(), true);
          } else if (_currentNature !== prevNature) {
            feedAppend('<span class="cmd-status-change">[' + nowTS() + '] NATURE UPDATED: ' + esc(_currentNature) + '</span>');
          }
        }

        // 4. DESTINATION CHANGE WHILE TRANSPORTING - STATUS TONE
        else if (_currentStatus === 'T' && prevDest !== _currentDestination && _currentDestination) {
          feedAlert('[' + nowTS() + '] *** DESTINATION CHANGED: ' + resolveAddr(_currentDestination) + ' ***');
          _toneStatus();
          _notify('DESTINATION CHANGED', 'New destination: ' + resolveAddr(_currentDestination),
            'cad-dest-' + Date.now(), true);
        }

        // 5. STATUS FORCED BY DISPATCH - STATUS TONE
        // Only fires when the status change was NOT initiated by the user themselves.
        // _pendingStatus is set by updateFieldStatus/fieldHandoff and cleared above once confirmed.
        else if (prevStatus && prevStatus !== _currentStatus && _pendingStatus === null) {
          const label = STATUS_LABELS[_currentStatus] || _currentStatus;
          feedAppend('<span class="cmd-status-change">[' + nowTS() + '] STATUS CHANGED TO ' + label + ' BY DISPATCH</span>');
          _toneStatus();
          // Show alert banner in MY CALL tab so crew sees notification regardless of active tab
          (function() {
            var ab = document.getElementById('alertBanner');
            if (ab) {
              ab.textContent = '\u25CF STATUS SET TO ' + label + ' BY DISPATCH';
              ab.style.display = '';
              setTimeout(function() { if (ab.textContent.indexOf(label) !== -1) ab.style.display = 'none'; }, 8000);
            }
          })();
          _notify('STATUS: ' + label, _cadCallsign + ' status changed to ' + label,
            'cad-status-' + Date.now(), false);
        }

        // 6. SUPPLEMENTAL UPDATE — [SUP] prefix in incident note
        if (_currentIncident && _currentNote && _currentNote !== prevNote && _currentNote.indexOf('[SUP]') !== -1) {
          var supText = _currentNote.replace(/^\[SUP\]\s*/, '');
          feedAlert('[' + nowTS() + '] *** SUPPLEMENTAL: ' + esc(supText) + ' ***');
          _toneMessage();
          _notify('SUP: INC ' + _currentIncident, supText, 'cad-sup-' + Date.now(), true);
        }
      }

      // ══════════════════════════════════════════════════════════════════
      // MESSAGES
      // ══════════════════════════════════════════════════════════════════
      const msgs = state.messages || [];
      for (let i = msgs.length - 1; i >= 0; i--) {
        const m = msgs[i];
        if (_knownMsgIds.has(m.message_id)) continue;
        _knownMsgIds.add(m.message_id);

        // Skip messages from before login (don't show old messages as new)
        if (_loginTime && m.ts) {
          const msgTime = new Date(m.ts);
          if (msgTime < _loginTime) continue;
        }

        const ts = fmtTime(m.ts);
        const isPage = m.message && m.message.startsWith('[PAGE]');
        const isGpsUl = m.message && m.message.trim() === '[GPS:UL]';
        // GPS Update Location request — auto-respond silently, don't show in feed
        if (isGpsUl) {
          feedSys('GPS UPDATE REQUESTED BY DISPATCH — SENDING LOCATION...');
          fieldGpsUpdateLocation();
          API.readMessage(_cadToken, m.message_id).catch(function(){});
          continue;
        }
        if (isPage) {
          feedAlert('[' + nowTS() + '] *** RADIO PAGE FROM DISPATCH ***');
        } else {
          const urgentTag = m.urgent ? '<span class="cmd-urgent">[URGENT] </span>' : '';
          feedAppend(
            '<span class="cmd-ts">' + esc(ts) + '</span> ' +
            urgentTag +
            '<span class="cmd-from">[' + esc(m.from_role) + ']</span> ' +
            esc(m.message)
          );
        }

        // PAGE = fire/EMS tone; HTMSG = urgent tone; MSG = soft message tone
        if (isPage && !m.read_flag) {
          _tonePage();
        } else if (m.urgent && !m.read_flag) {
          _toneUrgent();
        } else if (!m.read_flag) {
          _toneMessage();
        }

        // Increment unread badge (Change 5)
        if (!m.read_flag) {
          _unreadMessages++;
          updateMsgBadge();
        }

        if (!m.read_flag) {
          const ntitle = isPage ? 'RADIO PAGE' : m.urgent ? 'URGENT MSG from ' + m.from_role : 'MSG from ' + m.from_role;
          const nbody  = isPage ? 'Radio page from dispatch' : m.message;
          _notify(ntitle, nbody, 'cad-msg-' + m.message_id, !!(m.urgent || isPage));
        }

        if (!m.read_flag) {
          API.readMessage(_cadToken, m.message_id).catch(function(){});
        }
      }

      // Phase 2E: fetch unit stack for NEXT CALL card
      try {
        var stackRes = await API.getUnitStack(_cadToken, _cadCallsign);
        _lastStack = (stackRes && stackRes.ok && stackRes.stack) ? stackRes.stack : [];
      } catch(e) {
        _lastStack = [];
      }
      updateNextCallPanel(_lastStack);

      // Refresh active tab that depends on live state
      if (_activeTab === 'roster') _renderRosterTab();
      if (_activeTab === 'calls')  _renderCallsTab();
      if (_activeTab === 'map')    _maybeRefreshMapTab();
      if (_activeTab === 'more')   _updateMoreTab();

    } catch(e) {
      console.error('[field] Poll error:', e);
      setOnline(false);
    } finally {
      _pollInFlight = false;
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // TRANSPORT DESTINATION OVERLAY
  // ════════════════════════════════════════════════════════════════════════════
  const TRANSPORT_QUICK_PICKS = ['ST CHARLES BEND','ST CHARLES REDMOND','ST CHARLES PRINEVILLE','ST CHARLES MADRAS','TRANSFER'];
  let _transportResolve = null;
  let _transportCountdown = null;
  let _transportHistoryPushed = false;

  function promptTransportDest() {
    return new Promise(function(resolve) {
      _transportResolve = resolve;
      let secs = 45;
      const timerEl = document.getElementById('transportDismissLabel');
      const input = document.getElementById('transportDestInput');
      const picks = document.getElementById('transportQuickPicks');
      if (input) input.value = '';
      if (picks) {
        const _tdests = (_lastState && _lastState.destinations && _lastState.destinations.length)
          ? _lastState.destinations
          : TRANSPORT_QUICK_PICKS.map(function(p) { return { code: p, name: p, diverted: false }; });
        picks.innerHTML = _tdests.map(function(d) {
          const label = (d.name || d.code) + (d.diverted ? ' [DIV]' : '');
          const code = (d.code || d.name || '');
          const safecode = code.replace(/&/g,'&amp;').replace(/'/g,'&#039;').replace(/"/g,'&quot;');
          const safelabel = label.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          const cls = 'dest-quick-btn' + (d.diverted ? ' dest-diverted' : '');
          return '<button onclick="selectTransportQuick(&#039;' + safecode + '&#039;)" class="' + cls + '">' + safelabel + '</button>';
        }).join('');
      }
      document.getElementById('transportOverlay').style.display = 'flex';
      _transportHistoryPushed = true;
      history.pushState({ fieldModal: 'transport' }, '');
      if (input) setTimeout(function() { input.focus(); }, 100);
      _transportCountdown = setInterval(function() {
        secs--;
        if (timerEl) timerEl.textContent = 'DISMISSES IN ' + secs + 'S — SKIP TO SEND WITHOUT DESTINATION';
        if (secs <= 0) { clearInterval(_transportCountdown); _resolveTransport(null); }
      }, 1000);
    });
  }

  function selectTransportQuick(val) {
    const input = document.getElementById('transportDestInput');
    if (input) input.value = val;
    _resolveTransport(val);
  }

  function _resolveTransport(dest) {
    clearInterval(_transportCountdown);
    document.getElementById('transportOverlay').style.display = 'none';
    const wasNav = _transportHistoryPushed;
    _transportHistoryPushed = false;
    if (wasNav) history.back();
    if (_transportResolve) { _transportResolve(dest || null); _transportResolve = null; }
  }

  document.getElementById('btnTransportConfirm').addEventListener('click', function() {
    const val = (document.getElementById('transportDestInput').value || '').trim().toUpperCase();
    _resolveTransport(val || null);
  });
  document.getElementById('btnTransportSkip').addEventListener('click', function() { _resolveTransport(null); });
  document.getElementById('transportDestInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { _resolveTransport((this.value || '').trim().toUpperCase() || null); }
  });

  // ════════════════════════════════════════════════════════════════════════════
  // CLEAR NOTE DIALOG — optional note before going AV / patient handoff
  // ════════════════════════════════════════════════════════════════════════════
  let _clearNoteResolve = null;

  function promptClearNote(title) {
    return new Promise(function(resolve) {
      _clearNoteResolve = resolve;
      var titleEl = document.getElementById('clearNoteTitle');
      if (titleEl) titleEl.textContent = title || 'CLEARING FROM CALL';
      var input = document.getElementById('clearNoteInput');
      if (input) input.value = '';
      var el = document.getElementById('clearNoteOverlay');
      if (el) { el.style.display = 'flex'; setTimeout(function() { if (input) input.focus(); }, 100); }
    });
  }

  function _resolveClearNote(note) {
    var el = document.getElementById('clearNoteOverlay');
    if (el) el.style.display = 'none';
    if (_clearNoteResolve) { _clearNoteResolve(note); _clearNoteResolve = null; }
  }

  document.getElementById('btnClearNoteConfirm').addEventListener('click', function() {
    var note = (document.getElementById('clearNoteInput').value || '').trim();
    _resolveClearNote(note); // empty string = no note, still proceed
  });
  document.getElementById('btnClearNoteSkip').addEventListener('click', function() {
    _resolveClearNote(''); // skip note, proceed
  });
  document.getElementById('btnClearNoteCancel').addEventListener('click', function() {
    _resolveClearNote(null); // null = cancelled
  });
  document.getElementById('clearNoteInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { _resolveClearNote((this.value || '').trim()); }
    if (e.key === 'Escape') { _resolveClearNote(null); }
  });

  // ════════════════════════════════════════════════════════════════════════════
  // DEL REASON DIALOG — structured reason picker for DEL command
  // ════════════════════════════════════════════════════════════════════════════
  let _delReasonResolve = null;

  function promptDelReason(incId) {
    return new Promise(function(resolve) {
      _delReasonResolve = resolve;
      var label = document.getElementById('delReasonIncLabel');
      if (label) label.textContent = incId;
      var el = document.getElementById('delReasonOverlay');
      if (el) el.style.display = 'flex';
    });
  }

  function _resolveDelReason(reason) {
    var el = document.getElementById('delReasonOverlay');
    if (el) el.style.display = 'none';
    if (_delReasonResolve) { _delReasonResolve(reason); _delReasonResolve = null; }
  }

  document.getElementById('btnDelDup').addEventListener('click', function() { _resolveDelReason('DUPLICATE'); });
  document.getElementById('btnDelErr').addEventListener('click', function() { _resolveDelReason('DATA-ERROR'); });
  document.getElementById('btnDelCancel').addEventListener('click', function() { _resolveDelReason(null); });

  // Go available — tap AV button → optional note → set status AV
  async function goAvailable() {
    var note = '';
    if (_currentIncident) {
      var resp = await promptClearNote('GO AVAILABLE');
      if (resp === null) return; // cancelled
      note = resp;
    }
    if (note) {
      try { await API.appendIncidentNote(_cadToken, _currentIncident, note); } catch(e) {}
    }
    updateFieldStatus('AV');
  }

  // ════════════════════════════════════════════════════════════════════════════
  // CONFIRM DIALOG
  // ════════════════════════════════════════════════════════════════════════════
  let _confirmResolve = null;

  function showConfirm(title, message, yesLabel, noLabel) {
    return new Promise(function(resolve) {
      _confirmResolve = resolve;
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmYes').textContent = yesLabel || 'YES';
      document.getElementById('confirmNo').textContent = noLabel || 'CANCEL';
      document.getElementById('confirmOverlay').classList.add('active');
    });
  }

  document.getElementById('confirmYes').addEventListener('click', function() {
    document.getElementById('confirmOverlay').classList.remove('active');
    if (_confirmResolve) { _confirmResolve(true); _confirmResolve = null; }
  });

  document.getElementById('confirmNo').addEventListener('click', function() {
    document.getElementById('confirmOverlay').classList.remove('active');
    if (_confirmResolve) { _confirmResolve(false); _confirmResolve = null; }
  });

  // Enter key confirms dialog
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      var overlay = document.getElementById('confirmOverlay');
      if (overlay && overlay.classList.contains('active')) {
        e.preventDefault();
        overlay.classList.remove('active');
        if (_confirmResolve) { _confirmResolve(true); _confirmResolve = null; }
      }
    }
  });

  // ════════════════════════════════════════════════════════════════════════════
  // STATUS UPDATE
  // ════════════════════════════════════════════════════════════════════════════
  async function updateFieldStatus(statusCode, note) {
    if (!_cadToken || !_cadCallsign) return;

    if (statusCode === 'OOS') {
      const ok = await showConfirm('OUT OF SERVICE', 'SET STATUS TO OUT OF SERVICE?\nTHIS WILL REMOVE YOU FROM AVAILABLE UNITS.');
      if (!ok) return;
    }

    const patch = { status: statusCode };
    if (note) patch.note = note;

    try {
      const res = await API.upsertUnit(_cadToken, _cadCallsign, patch);
      if (res.ok) {
        // Stop dispatch alert when going enroute or any other status change
        if (statusCode === 'DE' || _dispatchAlertTimer) _stopDispatchAlert();
        // Play status change tone on every status change
        _toneStatus();
        // Mark this as a self-initiated change so the next poll does not misfire a
        // "STATUS CHANGED BY DISPATCH" tone if the server hasn't propagated yet.
        _pendingStatus = statusCode;
        updateStatusBadge(statusCode);
        const label = STATUS_LABELS[statusCode] || statusCode;
        feedSys('[' + nowTS() + '] STATUS -> ' + label + (note ? ' (' + note + ')' : ''));
        // Log for bug report auto-context
        _fieldActionLog.push(nowTS() + ' STATUS->' + statusCode);
        if (_fieldActionLog.length > 10) _fieldActionLog.shift();
        // Track times for incident panel
        // M-5: update local fallback times so panel reflects change immediately before next poll
        if (statusCode === 'DE') _incidentTimes.enroute = new Date().toISOString();
        if (statusCode === 'OS') _incidentTimes.onscene = new Date().toISOString();
        if (statusCode === 'TH') _incidentTimes.athosp = new Date().toISOString();
        if (statusCode === 'AV') _incidentTimes = {};
      } else {
        const errMsg = res.error || 'UNKNOWN';
        feedErr('STATUS UPDATE FAILED: ' + errMsg);
        // If conflict, suggest retry
        if (res.conflict) {
          feedSys('HINT: STATUS CONFLICT — REFRESH AND TRY AGAIN.');
        }
        // FSM violation: server rejected the transition — sync actual status from server
        if (res.fsmViolation) {
          feedSys('SYNCING CURRENT STATUS FROM SERVER...');
          pollOnce();
        }
      }
    } catch(e) {
      setOnline(false);
      queueStatusUpdate(statusCode, note);
      _pendingStatus = statusCode;
      updateStatusBadge(statusCode);
      feedSys('[' + nowTS() + '] STATUS -> ' + statusCode + ' (QUEUED - OFFLINE)');
    }
  }

  // ════════════════════════════════════════════════════════════════════════════
  // COMMAND PROCESSING
  // ════════════════════════════════════════════════════════════════════════════
  function processCommand(raw) {
    const text = raw.trim().toUpperCase();
    if (!text) return;

    // Status commands — DE/OS optionally followed by INC#### for self-assignment
    const statusMatch = text.match(/^(DE|OS|T|TH|AV|OOS|BRK|UV|F|FD)(?:\s+(INC\S+|[A-Z]{1,4}\d{2}-\d{4}|\d{2}-\d{4}|\d{4}))?(?:\s*;\s*(.*))?$/); // D excluded — only board can dispatch
    if (statusMatch) {
      const statusCode = statusMatch[1].toUpperCase();
      const incArg = statusMatch[2] ? statusMatch[2].replace(/^INC/i, '') : null;
      const note = statusMatch[3] || '';
      if (incArg && (statusCode === 'DE' || statusCode === 'OS')) {
        feedSys(statusCode + ' SELF-ASSIGNING TO INC' + incArg + '...');
        API.selfAssign(_cadToken, incArg, statusCode).then(function(res) {
          if (res.ok) feedSys('ASSIGNED TO INC' + incArg + ' \xB7 STATUS: ' + statusCode);
          else feedErr('SELF-ASSIGN FAILED: ' + (res.error || 'UNKNOWN'));
        }).catch(function() { setOnline(false); feedErr('SELF-ASSIGN FAILED \u2014 OFFLINE'); });
      } else {
        updateFieldStatus(statusCode, note);
      }
      return;
    }

    // MSG <target> <text>  OR  MSG <target>; <text>
    const msgMatch = text.match(/^MSG\s+(\S+)(?:\s*;\s*|\s+)(.+)$/);
    if (msgMatch) {
      API.sendMessage(_cadToken, msgMatch[1], msgMatch[2], false).then(function(res) {
        if (res.ok) feedSys('MSG SENT TO ' + msgMatch[1] + ': ' + msgMatch[2]);
        else feedErr('MSG FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage(msgMatch[1], msgMatch[2], false);
        feedSys('MSG TO ' + msgMatch[1] + ' QUEUED - OFFLINE');
      });
      return;
    }

    // HTMSG <target> <text>  OR  HTMSG <target>; <text>
    const htmsgMatch = text.match(/^HTMSG\s+(\S+)(?:\s*;\s*|\s+)(.+)$/);
    if (htmsgMatch) {
      API.sendMessage(_cadToken, htmsgMatch[1], htmsgMatch[2], true).then(function(res) {
        if (res.ok) feedSys('URGENT MSG SENT TO ' + htmsgMatch[1] + ': ' + htmsgMatch[2]);
        else feedErr('HTMSG FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage(htmsgMatch[1], htmsgMatch[2], true);
        feedSys('URGENT MSG TO ' + htmsgMatch[1] + ' QUEUED - OFFLINE');
      });
      return;
    }

    // MSGDP <text>  OR  MSGDP; <text>
    const msgdpMatch = text.match(/^MSGDP(?:\s*;\s*|\s+)(.+)$/);
    if (msgdpMatch) {
      API.sendToDispatchers(_cadToken, msgdpMatch[1], false).then(function(res) {
        if (res.ok) feedSys('MSG TO DISPATCHERS: ' + msgdpMatch[1]);
        else feedErr('MSGDP FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage('DISPATCHERS', msgdpMatch[1], false);
        feedSys('MSG TO DISPATCHERS QUEUED - OFFLINE');
      });
      return;
    }

    // HTDP <text>  OR  HTDP; <text>
    const htdpMatch = text.match(/^HTDP(?:\s*;\s*|\s+)(.+)$/);
    if (htdpMatch) {
      API.sendToDispatchers(_cadToken, htdpMatch[1], true).then(function(res) {
        if (res.ok) feedSys('URGENT MSG TO DISPATCHERS: ' + htdpMatch[1]);
        else feedErr('HTDP FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage('DISPATCHERS', htdpMatch[1], true);
        feedSys('URGENT MSG TO DISPATCHERS QUEUED - OFFLINE');
      });
      return;
    }

    // MSGU <text>  OR  MSGU; <text>
    const msguMatch = text.match(/^MSGU(?:\s*;\s*|\s+)(.+)$/);
    if (msguMatch) {
      API.sendToUnits(_cadToken, msguMatch[1], false).then(function(res) {
        if (res.ok) feedSys('MSG TO ALL UNITS: ' + msguMatch[1]);
        else feedErr('MSGU FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage('UNIT', msguMatch[1], false);
        feedSys('MSG TO ALL UNITS QUEUED - OFFLINE');
      });
      return;
    }

    // HTU <text>  OR  HTU; <text> - send urgent message to all units
    const htuMatch = text.match(/^HTU(?:\s*;\s*|\s+)(.+)$/);
    if (htuMatch) {
      API.sendToUnits(_cadToken, htuMatch[1], true).then(function(res) {
        if (res.ok) feedSys('URGENT MSG TO ALL UNITS: ' + htuMatch[1]);
        else feedErr('HTU FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage('UNIT', htuMatch[1], true);
        feedSys('URGENT MSG TO ALL UNITS QUEUED - OFFLINE');
      });
      return;
    }

    // MSGALL <text>  OR  MSGALL; <text> - broadcast to ALL dispatchers AND units
    const msgallMatch = text.match(/^MSGALL(?:\s*;\s*|\s+)(.+)$/);
    if (msgallMatch) {
      API.sendBroadcast(_cadToken, msgallMatch[1], false).then(function(res) {
        if (res.ok) feedSys('MSG TO ALL: ' + msgallMatch[1]);
        else feedErr('MSGALL FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage('ALL', msgallMatch[1], false);
        feedSys('MSG TO ALL QUEUED - OFFLINE');
      });
      return;
    }

    // HTALL <text>  OR  HTALL; <text> - urgent broadcast to ALL dispatchers AND units
    const htallMatch = text.match(/^HTALL(?:\s*;\s*|\s+)(.+)$/);
    if (htallMatch) {
      API.sendBroadcast(_cadToken, htallMatch[1], true).then(function(res) {
        if (res.ok) feedSys('URGENT MSG TO ALL: ' + htallMatch[1]);
        else feedErr('HTALL FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueMessage('ALL', htallMatch[1], true);
        feedSys('URGENT MSG TO ALL QUEUED - OFFLINE');
      });
      return;
    }

    // NOTE; <text>
    const noteMatch = text.match(/^NOTE\s*;\s*(.+)$/);
    if (noteMatch) {
      if (!_currentIncident) { feedErr('NO ACTIVE INCIDENT. NOTE NOT ADDED.'); return; }
      const incId = _currentIncident;
      API.appendIncidentNote(_cadToken, incId, noteMatch[1]).then(function(res) {
        if (res.ok) feedSys('NOTE ADDED TO INC ' + incId);
        else feedErr('NOTE FAILED: ' + (res.error || 'UNKNOWN'));
      }).catch(function() {
        setOnline(false);
        queueNoteAppend(incId, noteMatch[1]);
        feedSys('NOTE FOR INC ' + incId + ' QUEUED - OFFLINE');
      });
      return;
    }

    // WHO - dispatchers online
    if (text === 'WHO') {
      feedSys('CHECKING DISPATCH...');
      API.who(_cadToken).then(function(res) {
        if (!res.ok) { feedErr('WHO FAILED: ' + (res.error || 'UNKNOWN')); return; }
        var users = res.users || [];
        if (!users.length) { feedSys('--- NO DISPATCHERS ONLINE ---'); return; }
        feedSys('--- DISPATCHERS ONLINE (' + users.length + ') ---');
        users.forEach(function(u) {
          feedSys((u.actor || '?').padEnd(14) + ' ' + u.minutesAgo + 'M AGO');
        });
      });
      return;
    }

    // UR - active unit roster
    if (text === 'UR') {
      if (!_lastState || !_lastState.units) { feedErr('NO DATA. TRY REFRESH FIRST.'); return; }
      const units = _lastState.units.filter(function(u) { return u.active; });
      feedSys('--- ACTIVE UNITS (' + units.length + ') ---');
      units.forEach(function(u) {
        const st = (u.status || '--').padEnd(4);
        const label = (STATUS_LABELS[u.status] || u.status || '--').padEnd(14);
        const inc = u.incident ? 'INC' + u.incident : '';
        const dest = u.destination ? resolveAddr(u.destination) : '';
        feedSys(u.unit_id.padEnd(9) + st + ' ' + label + ' ' + inc + '  ' + dest);
      });
      return;
    }

    // STATUS
    if (text === 'STATUS') {
      const label = STATUS_LABELS[_currentStatus] || _currentStatus;
      feedSys('--- YOUR STATUS ---');
      feedSys('UNIT: ' + _cadCallsign + ' | STATUS: ' + _currentStatus + ' (' + label + ')');
      if (_currentIncident) {
        feedSys('INCIDENT: INC ' + _currentIncident);
        feedSys('DEST: ' + resolveAddr(_currentDestination));
        if (_currentNature) feedSys('NATURE: ' + _currentNature);
      } else {
        feedSys('NO ACTIVE INCIDENT');
      }
      return;
    }

    // HOLDING - show unassigned queued/active incidents
    if (text === 'HOLDING' || text === 'HOLDS' || text === 'Q') {
      if (!_lastState || !_lastState.incidents) { feedErr('NO DATA. TRY REFRESH FIRST.'); return; }
      const holds = _lastState.incidents.filter(function(i) {
        const hasUnits = i.units && String(i.units).trim().length > 0;
        return (i.status === 'ACTIVE' || i.status === 'QUEUED') && !hasUnits;
      });
      if (!holds.length) { feedSys('--- NO UNASSIGNED CALLS ---'); return; }
      feedSys('--- UNASSIGNED CALLS (' + holds.length + ') ---');
      holds.forEach(function(i) {
        const shortId = String(i.incident_id).replace(/^\d{2}-/, '');
        const pri  = i.priority ? ' [' + i.priority + ']' : '';
        const type = i.incident_type ? ' ' + i.incident_type : '';
        const dest = i.destination ? ' \u2192 ' + resolveAddr(i.destination) : '';
        const scene = i.scene_address ? ' @ ' + i.scene_address : '';
        feedSys('INC' + shortId + pri + type + scene + dest);
        feedSys('  SELF-ASSIGN: DE INC' + shortId + ' (ENROUTE)  |  OS INC' + shortId + ' (ON SCENE)');
      });
      return;
    }

    // WHODP - alias for WHO (dispatchers)
    if (text === 'WHODP') {
      processCommand('WHO');
      return;
    }

    // ADDR / ADDR <search>
    const addrMatch = text.match(/^ADDR(?:\s+(.+))?$/);
    if (addrMatch) {
      const query = addrMatch[1] || '';
      if (!query) { feedSys('USAGE: ADDR <SEARCH TERM>'); return; }
      const results = _addrList.filter(function(a) {
        const hay = ((a.name || '') + ' ' + (a.id || '') + ' ' + (a.address || '')).toUpperCase();
        return hay.includes(query);
      });
      if (results.length === 0) {
        feedErr('NO ADDRESSES FOUND FOR: ' + query);
      } else {
        feedSys('--- ADDRESS RESULTS (' + Math.min(results.length, 10) + '/' + results.length + ') ---');
        results.slice(0, 10).forEach(function(a) {
          feedSys(a.name || a.id);
          if (a.address) feedSys('  ' + a.address + (a.city ? ', ' + a.city : '') + (a.state ? ' ' + a.state : '') + (a.zip ? ' ' + a.zip : ''));
          if (a.phone) feedSys('  PH: ' + a.phone);
          if (a.cross) feedSys('  X: ' + a.cross);
        });
      }
      return;
    }

    // DEST; <location> [note] - set own destination
    const destMatch = text.match(/^DEST\s*;\s*(.*)$/);
    if (destMatch || text === 'DEST') {
      const destVal = destMatch ? destMatch[1].trim() : '';
      // Parse bracket note: "SCMC [BED 4]" → base=SCMC, note=BED 4
      let destBase = destVal, destNote = '';
      var bIdx = destVal.indexOf('[');
      if (bIdx >= 0) {
        destBase = destVal.substring(0, bIdx).trim();
        destNote = destVal.substring(bIdx + 1).trim();
        if (destNote.endsWith(']')) destNote = destNote.substring(0, destNote.length - 1).trim();
      }
      // Resolve to address ID if known
      var lookupVal = destBase || destVal;
      let resolved = lookupVal;
      if (lookupVal && _addrList.length > 0) {
        const byId = _addrList.find(function(a) { return (a.id || '').toUpperCase() === lookupVal; });
        if (byId) {
          resolved = byId.id;
        } else {
          const results = _addrList.filter(function(a) {
            const hay = ((a.name || '') + ' ' + (a.id || '')).toUpperCase();
            return hay.includes(lookupVal);
          });
          if (results.length === 1) resolved = results[0].id;
        }
      }
      // Re-append bracket note if present
      if (destNote) resolved = resolved + ' [' + destNote + ']';
      feedSys(destVal ? 'SETTING DESTINATION: ' + resolved : 'CLEARING DESTINATION...');
      API.upsertUnit(_cadToken, _cadCallsign, { destination: resolved }, '').then(function(res) {
        if (res.ok) {
          _currentDestination = resolved;
          feedSys(destVal ? 'DEST SET: ' + resolveAddr(resolved) : 'DEST CLEARED.');
          pollOnce();
        } else {
          feedErr('DEST FAILED: ' + (res.error || 'UNKNOWN'));
        }
      });
      return;
    }

    // REFRESH
    // CLR - clear self from current incident without changing status
    if (text === 'CLR') {
      if (!_cadToken || !_cadCallsign) { feedErr('NOT LOGGED IN.'); return; }
      if (!_currentIncident) { feedSys('NO ACTIVE INCIDENT.'); return; }
      const _clrIncident = _currentIncident;
      (async function() {
        try {
          const r = await API.clearUnitAssignment(_cadToken, _clrIncident, _cadCallsign);
          if (r.ok) {
            _currentIncident = '';
            updateIncidentPanel(null);
            feedSys('CLEARED FROM INCIDENT.');
            _toneMessage();
            setOnline(true);
          } else {
            feedErr(r.error || 'CLR FAILED.');
          }
        } catch(e) {
          setOnline(false);
          feedErr('OFFLINE — CLR NOT SENT.');
        }
      })();
      return;
    }

    // ETA <minutes> - set ETA note on own unit
    const etaFieldMatch = text.match(/^ETA\s+(\d+)$/);
    if (etaFieldMatch) {
      if (!_cadToken || !_cadCallsign) { feedErr('NOT LOGGED IN.'); return; }
      const mins = etaFieldMatch[1];
      (async function() {
        try {
          const r = await API.upsertUnit(_cadToken, _cadCallsign, { note: 'ETA ' + mins + ' MIN' });
          if (r.ok) {
            feedSys('ETA SET: ' + mins + ' MIN.');
            _toneMessage();
            setOnline(true);
          } else {
            feedErr(r.error || 'ETA FAILED.');
          }
        } catch(e) {
          setOnline(false);
          feedErr('OFFLINE.');
        }
      })();
      return;
    }

    if (text === 'REFRESH') {
      feedSys('REFRESHING...');
      pollOnce().then(function() { feedSys('REFRESH COMPLETE.'); });
      return;
    }

    if (text === 'GPS') { fieldGpsView(); return; }
    if (text === 'GPSUL') { fieldGpsUpdateLocation(); return; }
    if (text === 'INCLOG' || text === 'HISTORY') { openFieldIncHist(); return; }

    // CLOSE <inc>
    const closeMatch = text.match(/^CLOSE\s+(.+)$/);
    if (closeMatch) {
      API.closeIncident(_cadToken, closeMatch[1]).then(function(res) {
        if (res.ok) feedSys('INCIDENT ' + closeMatch[1] + ' CLOSED.');
        else feedErr('CLOSE FAILED: ' + (res.error || 'UNKNOWN'));
      });
      return;
    }

    // CAN <inc> [note] — quick cancel with optional note
    const canMatch = text.match(/^CAN\s+(\S+)(?:\s+(.+))?$/);
    if (canMatch) {
      (async function() {
        var incArg = canMatch[1];
        var note = (canMatch[2] || '').trim();
        if (note) {
          try { await API.appendIncidentNote(_cadToken, incArg, note); } catch(e) {}
        }
        var r = await API.closeIncident(_cadToken, incArg, 'CANCELLED');
        if (r.ok) feedSys('[' + nowTS() + '] ' + incArg + ' CANCELLED' + (note ? ' — ' + note : ''));
        else feedErr('CAN FAILED: ' + (r.error || 'UNKNOWN'));
      })();
      return;
    }

    // DEL <inc> [dup|err] — close with structured reason
    const delMatch = text.match(/^DEL\s+(\S+)(?:\s+(\S+))?$/);
    if (delMatch) {
      (async function() {
        var incArg = delMatch[1];
        var reasonRaw = (delMatch[2] || '').toUpperCase();
        var disposition = '';
        if (reasonRaw === 'DUP' || reasonRaw === 'DUPLICATE') {
          disposition = 'DUPLICATE';
        } else if (reasonRaw === 'ERR' || reasonRaw === 'ERROR') {
          disposition = 'DATA-ERROR';
        } else {
          disposition = await promptDelReason(incArg);
          if (!disposition) return;
        }
        var r = await API.closeIncident(_cadToken, incArg, disposition);
        if (r.ok) feedSys('[' + nowTS() + '] ' + incArg + ' DELETED — ' + disposition);
        else feedErr('DEL FAILED: ' + (r.error || 'UNKNOWN'));
      })();
      return;
    }

    // R <inc>
    const reviewMatch = text.match(/^R\s+(.+)$/);
    if (reviewMatch) {
      API.getIncident(_cadToken, reviewMatch[1]).then(function(res) {
        if (res.ok && res.incident) {
          const i = res.incident;
          feedSys('--- INCIDENT ' + i.incident_id + ' ---');
          feedSys('STATUS: ' + i.status + ' | DEST: ' + resolveAddr(i.destination));
          feedSys('TYPE: ' + (i.incident_type || '--') + ' | UNITS: ' + (i.units || '--'));
          if (i.incident_note) feedSys('NOTE: ' + i.incident_note);
        } else {
          feedErr('REVIEW FAILED: ' + (res.error || 'UNKNOWN'));
        }
      });
      return;
    }

    // LO / LOGOUT
    if (text === 'LO' || text === 'LOGOUT') {
      (async function() {
        const ok = await showConfirm('LOGOUT', 'LOG OUT OF HOSCAD FIELD?\nYOUR UNIT WILL BE REMOVED FROM THE BOARD.');
        if (!ok) return;
        feedSys('LOGGING OUT...');
        try { await cadLogout(); } catch(e) {}
        showLogin();
      })();
      return;
    }

    // CLS / CLEAR
    if (text === 'CLS' || text === 'CLEAR') {
      cmdFeed.innerHTML = '<div class="cmd-feed-line"><span class="cmd-sys">SCREEN CLEARED.</span></div>';
      return;
    }

    // HELP
    if (text === 'HELP') {
      feedSys('--- HOSCAD FIELD COMMAND REFERENCE ---');
      feedSys('DE / OS / T / AV        STATUS UPDATE (INSTANT)');
      feedSys('TH                      AT HOSPITAL (TAP + CONFIRM)');
      feedSys('OOS / BRK / UV          STATUS UPDATE (OOS = CONFIRM)');
      feedSys('  DE INC####            ENROUTE + SELF-ASSIGN TO INCIDENT');
      feedSys('  OS INC####            ON SCENE + SELF-ASSIGN TO INCIDENT');
      feedSys('  STATUS; NOTE          STATUS WITH NOTE');
      feedSys('CLR                     CLEAR YOURSELF FROM CURRENT INCIDENT');
      feedSys('ETA <MINUTES>           SET YOUR ETA (E.G. ETA 8)');
      feedSys('MSG <TARGET> <TEXT>     SEND MESSAGE');
      feedSys('HTMSG <TARGET> <TEXT>   SEND URGENT MESSAGE');
      feedSys('MSGDP <TEXT>            MSG ALL DISPATCHERS');
      feedSys('HTDP <TEXT>             URGENT MSG DISPATCHERS');
      feedSys('MSGU <TEXT>             MSG ALL UNITS');
      feedSys('HTU <TEXT>              URGENT MSG ALL UNITS');
      feedSys('MSGALL <TEXT>           MSG ALL DISPATCHERS AND UNITS');
      feedSys('HTALL <TEXT>            URGENT MSG ALL');
      feedSys('WHO                     DISPATCHERS ONLINE');
      feedSys('UR                      ALL ACTIVE UNITS');
      feedSys('Q / HOLDING             UNASSIGNED CALLS (SELF-ASSIGN WITH DE/OS INC####)');
      feedSys('WHODP                   ALIAS FOR WHO (DISPATCHERS)');
      feedSys('STATUS                  YOUR STATUS DETAILS');
      feedSys('NOTE; <TEXT>            ADD NOTE TO INCIDENT');
      feedSys('DEST; <LOCATION>        SET YOUR DESTINATION');
      feedSys('DEST                    CLEAR DESTINATION');
      feedSys('ADDR <SEARCH>           FACILITY LOOKUP');
      feedSys('R <INC>                 REVIEW INCIDENT');
      feedSys('CLOSE <INC>             CLOSE INCIDENT');
      feedSys('CAN <INC> [NOTE]        QUICK CANCEL (NO PICKER)');
      feedSys('  CAN SC26-0045, CAN 0045, CAN 0045 PER HOSPITAL');
      feedSys('DEL <INC> [DUP|ERR]     DELETE WITH REASON');
      feedSys('  DEL SC26-0045 DUP  (DUPLICATE)');
      feedSys('  DEL SC26-0045 ERR  (DATA ERROR)');
      feedSys('  DEL SC26-0045      (OPENS PICKER)');
      feedSys('REFRESH                 FORCE POLL');
      feedSys('LO                      LOG OUT');
      feedSys('CLS                     CLEAR SCREEN');
      return;
    }

    // 10-4
    if (text === '10-4') { feedSys('10-4.'); return; }

    feedErr('UNKNOWN COMMAND. TYPE HELP.');
  }

  // ════════════════════════════════════════════════════════════════════════════
  // EVENT BINDINGS
  // ════════════════════════════════════════════════════════════════════════════

  // Login
  document.getElementById('btnLogin').addEventListener('click', async function() {
    const cs = document.getElementById('loginCallsign').value.trim();
    loginErr.textContent = '';
    if (!cs) { loginErr.textContent = 'ENTER A CALLSIGN.'; return; }
    if (cs.length < 2) { loginErr.textContent = 'CALLSIGN TOO SHORT.'; return; }

    // ── Crew PIN (conditional on feature flag) ────────────────────
    // crew_pin_login flag defaults true. When false, skip PIN verification and
    // log in with callsign only (same as legacy UNIT-role auth). Flag is cached
    // in localStorage so the login screen reflects the last-known setting.
    // Note: flag changes take effect on next page load or within 10s of active session.
    let unitInfo = '';
    let crewAssignments = [];

    if (_fieldFF.crew_pin_login !== false) {
      // ── Crew 1 (required when PIN login is active) ───────────────
      const c1CadId = document.getElementById('loginCrew1CadId').value.trim();
      const c1Pin   = document.getElementById('loginCrew1Pin').value.trim();
      if (!c1CadId) { loginErr.textContent = 'CREW 1: ENTER CAD ID.'; return; }
      if (!c1Pin)   { loginErr.textContent = 'CREW 1: ENTER PIN.'; return; }
      loginErr.textContent = 'VERIFYING CREW 1...';
      const c1Res = await API.crewPinLogin(c1CadId, c1Pin);
      if (!c1Res.ok) { loginErr.textContent = 'CREW 1: ' + (c1Res.error || 'VERIFICATION FAILED.'); return; }
      // Auto-fill cert from response (user can override)
      const c1CertSel = document.getElementById('loginCrew1Cert');
      if (c1Res.certLevel && !c1CertSel.value) c1CertSel.value = c1Res.certLevel;
      const c1Cert = c1CertSel.value || c1Res.certLevel || '';
      document.getElementById('crew1Tag').textContent = c1Res.fullName + ' [' + (c1Cert || '?') + ']';
      const c1Data = { cadId: c1Res.cadId, name: c1Res.fullName, cert: c1Cert };

      // ── Crew 2 (optional) ───────────────────────────────────────
      let c2Data = null;
      const c2CadId = document.getElementById('loginCrew2CadId').value.trim();
      const c2Pin   = document.getElementById('loginCrew2Pin').value.trim();
      if (c2CadId || c2Pin) {
        if (!c2CadId || !c2Pin) { loginErr.textContent = 'CREW 2: ENTER BOTH CAD ID AND PIN, OR LEAVE BLANK.'; return; }
        loginErr.textContent = 'VERIFYING CREW 2...';
        const c2Res = await API.crewPinLogin(c2CadId, c2Pin);
        if (!c2Res.ok) { loginErr.textContent = 'CREW 2: ' + (c2Res.error || 'VERIFICATION FAILED.'); return; }
        const c2CertSel = document.getElementById('loginCrew2Cert');
        if (c2Res.certLevel && !c2CertSel.value) c2CertSel.value = c2Res.certLevel;
        const c2Cert = c2CertSel.value || c2Res.certLevel || '';
        document.getElementById('crew2Tag').textContent = c2Res.fullName + ' [' + (c2Cert || '?') + ']';
        c2Data = { cadId: c2Res.cadId, name: c2Res.fullName, cert: c2Cert };
      }

      // ── Build unit_info + crewAssignments ──────────────────────
      const parts = ['CM1:' + c1Data.name + (c1Data.cert ? ' (' + c1Data.cert + ')' : '')];
      if (c2Data) parts.push('CM2:' + c2Data.name + (c2Data.cert ? ' (' + c2Data.cert + ')' : ''));
      unitInfo = parts.join('|');
      crewAssignments = [
        { cadId: c1Data.cadId, fullName: c1Data.name, certLevel: c1Data.cert || null, crewRole: 'CM1' }
      ];
      if (c2Data) crewAssignments.push({ cadId: c2Data.cadId, fullName: c2Data.name, certLevel: c2Data.cert || null, crewRole: 'CM2' });
    }

    loginErr.textContent = 'CONNECTING...';
    const cadErr = await cadLogin(cs, unitInfo, crewAssignments);
    if (cadErr) { loginErr.textContent = 'CAD: ' + cadErr; return; }
    showField(cs.toUpperCase());
    feedSys('LOGGED IN AS ' + cs.toUpperCase() + '. HOSCAD FIELD ACTIVE.');
  });

  document.getElementById('loginCallsign').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('btnLogin').click();
  });

  // Logout
  document.getElementById('btnLogout').addEventListener('click', async function() {
    const ok = await showConfirm('LOGOUT', 'LOG OUT OF HOSCAD FIELD?\nYOUR UNIT WILL BE REMOVED FROM THE BOARD.');
    if (!ok) return;
    feedSys('LOGGING OUT...');
    try { await cadLogout(); } catch(e) {}
    showLogin();
  });

  // Patient Handoff (in-panel button) — delegates to fieldHandoff() which handles note prompt
  document.getElementById('btnHandoff').addEventListener('click', function() { fieldHandoff(); });

  // Hospital quick reference close (btnInfo/btnNight/btnWake/btnChangePIN now in MORE tab via inline onclick)
  document.getElementById('btnInfoClose').addEventListener('click', closeInfoOverlay);
  // pinChangeDialog lives after this script block — delegate to document
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.activeElement &&
        document.activeElement.id === 'pinChangeConfirm') savePinChange();
  });
  document.getElementById('infoCards').addEventListener('click', function(e) {
    var btn = e.target.closest('[data-dest-code]');
    if (btn) infoSetDest(btn.dataset.destCode);
  });

  // Command bar
  document.getElementById('btnCmdSend').addEventListener('click', function() {
    const text = cmdInput.value.trim();
    if (!text) return;
    processCommand(text);
    cmdInput.value = '';
    // Clear message badge when user interacts (Change 5)
    _unreadMessages = 0;
    updateMsgBadge();
  });

  cmdInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('btnCmdSend').click();
  });

  // iOS: ensure STATUS tab is visible when command console input is focused
  cmdInput.addEventListener('focus', function() {
    setTimeout(function() {
      if (_activeTab !== 'status') switchTab('status');
    }, 350);
  });

  // Quick actions
  document.querySelectorAll('.cmd-quick-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const cmd = btn.dataset.cmd;
      if (!cmd) return;  // buttons with onclick handlers (MAP, GPS, GPSUL) — skip
      if (cmd === '10-4' || cmd === 'WHO' || cmd === 'UR' || cmd === 'STATUS' || cmd === 'REFRESH' || cmd === 'HOLDING') {
        processCommand(cmd);
      } else {
        cmdInput.value = cmd;
        cmdInput.focus();
      }
    });
  });

  // Quick phrase buttons — auto-submit when incident is active, pre-fill otherwise (Change 2)
  document.querySelectorAll('.cmd-phrase-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (_currentIncident) {
        processCommand('NOTE; ' + btn.dataset.phrase);
      } else {
        cmdInput.value = btn.dataset.phrase;
        cmdInput.focus();
      }
    });
  });

  // Status buttons — TH requires confirm, AV prompts for note, others fire on click
  document.querySelectorAll('.field-status-btn').forEach(function(btn) {
    const statusCode = btn.dataset.status;
    if (statusCode === 'AV') {
      btn.addEventListener('click', function() { goAvailable(); });
    } else if (statusCode === 'TH') {
      btn.addEventListener('click', async function() {
        const ok = await showConfirm('AT HOSPITAL', 'CONFIRM ARRIVAL AT HOSPITAL?');
        if (!ok) return;
        updateFieldStatus('TH');
      });
    } else if (statusCode === 'OS') {
      btn.addEventListener('click', function() {
        updateFieldStatus('OS');
      });
    } else if (statusCode === 'T') {
      btn.addEventListener('click', function() {
        (async function() {
          _pendingStatus = 'T'; // set before await so poll doesn't fire spurious "changed by dispatch" tone
          const dest = await promptTransportDest();
          if (dest === undefined) { _pendingStatus = null; return; } // cancelled
          const updates = { status: 'T' };
          if (dest) updates.destination = dest;
          try {
            const res = await API.upsertUnit(_cadToken, _cadCallsign, updates);
            if (res.ok) {
              _stopDispatchAlert();
              _toneStatus();
              updateStatusBadge('T');
              _updateHandoffBtn();
              setOnline(true);
              feedSys('STATUS: TRANSPORT' + (dest ? ' \u2192 ' + dest : ''));
            } else {
              _pendingStatus = null;
              feedErr(res.error || 'STATUS UPDATE FAILED.');
            }
          } catch(e) {
            _pendingStatus = null;
            setOnline(false);
            feedErr('OFFLINE \u2014 STATUS NOT SENT.');
          }
        })();
      });
    } else {
      btn.addEventListener('click', function() {
        if (statusCode) updateFieldStatus(statusCode);
      });
    }
  });

  // HANDOFF button — 800ms hold-to-confirm (secondary row button removed; dynamic panel button used instead)
  const handoffBtn = document.getElementById('fieldHandoffBtn');
  if (handoffBtn) {
    let _handoffHoldTimer = null;
    let _handoffStartX = 0, _handoffStartY = 0;
    function handoffStart(e) {
      e.preventDefault();
      _handoffStartX = e.clientX; _handoffStartY = e.clientY;
      handoffBtn.style.opacity = '0.5';
      _handoffHoldTimer = setTimeout(function() {
        _handoffHoldTimer = null;
        handoffBtn.style.opacity = '';
        handoffBtn.style.boxShadow = '0 0 0 3px #c084fc inset';
        _toneStatus();
        fieldHandoff();
        setTimeout(function() { handoffBtn.style.boxShadow = ''; }, 600);
      }, 800);
    }
    function handoffCancel() {
      if (_handoffHoldTimer) { clearTimeout(_handoffHoldTimer); _handoffHoldTimer = null; }
      handoffBtn.style.opacity = '';
    }
    function handoffMove(e) {
      if (!_handoffHoldTimer) return;
      var dx = e.clientX - _handoffStartX, dy = e.clientY - _handoffStartY;
      if (dx * dx + dy * dy > 400) handoffCancel();
    }
    handoffBtn.addEventListener('pointerdown', handoffStart);
    handoffBtn.addEventListener('pointerup', handoffCancel);
    handoffBtn.addEventListener('pointerleave', handoffCancel);
    handoffBtn.addEventListener('pointermove', handoffMove);
    handoffBtn.addEventListener('pointercancel', handoffCancel);
    handoffBtn.addEventListener('click', function(e) { e.preventDefault(); });
  }

  // Clear message badge when user taps the feed (Change 5)
  cmdFeed.addEventListener('click', function() {
    _unreadMessages = 0;
    updateMsgBadge();
  });

  // Online/offline
  window.addEventListener('online', function() { setOnline(true); });
  window.addEventListener('offline', function() { setOnline(false); });

  // Session cleanup on tab/app close — immediately end session
  window.addEventListener('beforeunload', function() {
    if (_cadToken) {
      try {
        fetch(API.baseUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'apikey': API._apiKey,
            'Authorization': 'Bearer ' + API._apiKey
          },
          body: new URLSearchParams({ action: 'logout', params: JSON.stringify([_cadToken]) }).toString(),
          keepalive: true
        });
      } catch(e) {}
    }
  });

  // ════════════════════════════════════════════════════════════════════════════
  // PWA INSTALL
  // ════════════════════════════════════════════════════════════════════════════
  let _deferredInstallPrompt = null;
  const btnInstall = document.getElementById('btnInstall');
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

  window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    _deferredInstallPrompt = e;
    btnInstall.textContent = 'INSTALL APP';
    btnInstall.style.display = 'block';
  });

  if (isIOS && !isStandalone) {
    btnInstall.textContent = 'INSTALL: TAP SHARE THEN "ADD TO HOME SCREEN"';
    btnInstall.style.display = 'block';
  }

  btnInstall.addEventListener('click', async function() {
    if (_deferredInstallPrompt) {
      _deferredInstallPrompt.prompt();
      const result = await _deferredInstallPrompt.userChoice;
      if (result.outcome === 'accepted') btnInstall.style.display = 'none';
      _deferredInstallPrompt = null;
    } else if (isIOS) {
      alert('To install:\n1. Tap Share button\n2. Tap "Add to Home Screen"\n3. Tap "Add"');
    }
  });

  window.addEventListener('appinstalled', function() {
    btnInstall.style.display = 'none';
    _deferredInstallPrompt = null;
  });

  // ════════════════════════════════════════════════════════════════════════════
  // INCIDENT DETAIL MODAL
  // ════════════════════════════════════════════════════════════════════════════
  function fmtFieldTime(iso) {
    if (!iso) return '--:--';
    try {
      const d = new Date(iso);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
    } catch(e) { return '--:--'; }
  }

  let _incDetailHistoryPushed = false;

  function openIncDetail() {
    if (!_currentIncident) return;
    const modal = document.getElementById('incDetailModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    _incDetailHistoryPushed = true;
    history.pushState({ fieldModal: 'incDetail' }, '');

    // Populate from current state immediately (fast)
    const inc = (_lastState && _lastState.incidents || []).find(function(i) {
      return i.incident_id === _currentIncident;
    });
    if (inc) _populateIncDetailModal(inc, null);

    // Fetch full details (includes audit history)
    if (!_cadToken) return;
    API.getIncident(_cadToken, _currentIncident).then(function(r) {
      if (r && r.ok) _populateIncDetailModal(r.incident, r.audit);
    });
  }

  function _populateIncDetailModal(inc, audit) {
    if (!inc) return;
    document.getElementById('idmIncNum').textContent = 'INC ' + inc.incident_id;
    document.getElementById('idmPriority').textContent = inc.priority || '';
    document.getElementById('idmPriority').style.display = inc.priority ? '' : 'none';
    document.getElementById('idmType').textContent = inc.incident_type || '—';
    document.getElementById('idmUnits').textContent = inc.units || '—';
    // M-5: use correct server timestamp fields for each timing slot
    document.getElementById('idmTimeDisp').textContent  = fmtFieldTime(inc.dispatch_time || inc.created_at);
    document.getElementById('idmTimeEnrt').textContent  = fmtFieldTime(inc.enroute_time);
    document.getElementById('idmTimeOS').textContent    = fmtFieldTime(inc.arrival_time);
    document.getElementById('idmTimeTrans').textContent = fmtFieldTime(inc.transport_time);
    // M-4: at_hospital_time — update idmTimeAtHosp if element exists
    var atHospEl = document.getElementById('idmTimeAtHosp');
    var atHospRowEl = document.getElementById('idmAtHospRow');
    if (atHospEl) atHospEl.textContent = fmtFieldTime(inc.at_hospital_time);
    if (atHospRowEl) atHospRowEl.style.display = inc.at_hospital_time ? '' : 'none';

    const scene = inc.scene_address || '';
    document.getElementById('idmSceneRow').style.display = scene ? '' : 'none';
    document.getElementById('idmScene').textContent = scene;

    const dest = inc.destination || '';
    const destLabel = dest ? (resolveAddr(dest) || dest) : '';
    document.getElementById('idmDestRow').style.display = destLabel ? '' : 'none';
    document.getElementById('idmDest').textContent = destLabel;

    const note = inc.incident_note || '';
    const noteClean = note.replace(/\[[^\]]*\]/g, '').replace(/\s{2,}/g, ' ').trim();
    document.getElementById('idmCurrentNoteRow').style.display = noteClean ? '' : 'none';
    document.getElementById('idmCurrentNote').textContent = noteClean;

    if (audit) {
      const auditEl = document.getElementById('idmAudit');
      if (!audit.length) {
        auditEl.textContent = 'NO HISTORY.';
      } else {
        auditEl.innerHTML = audit.slice().reverse().map(function(e) {
          const t = e.ts ? fmtFieldTime(e.ts) : '';
          const actor = e.actor ? ' [' + e.actor + ']' : '';
          return '<div style="padding:3px 0;border-bottom:1px solid #1a2535;">' +
            (t ? '<span style="color:#5ba3e6;">' + t + '</span> ' : '') +
            '<span>' + (e.message || '') + '</span>' +
            '<span style="color:#5ba3e6;font-size:10px;">' + actor + '</span>' +
            '</div>';
        }).join('');
      }
    }
  }

  function closeIncDetail() {
    document.getElementById('incDetailModal').style.display = 'none';
    document.body.style.overflow = '';
    document.getElementById('idmNoteInput').value = '';
    const wasNav = _incDetailHistoryPushed;
    _incDetailHistoryPushed = false;
    if (wasNav) history.back();
  }

  // ── Field Map ───────────────────────────────────────────
  var _fieldMapObj        = null;
  var _fieldMapLayers     = [];
  var _fieldMapReady      = false;
  var _fieldMapHistPushed = false;
  var _fmapNavUrl         = null;
  var _fieldGpsPos        = null;  // [lat, lon] from last GPS fix — persists across map re-renders

  // Pre-seeded SCMC coords — avoids Nominatim for known medical facilities
  var _FIELD_KNOWN_COORDS = {
    'ST CHARLES BEND': [44.0641, -121.2832],
    'SAINT CHARLES BEND': [44.0641, -121.2832],
    'ST CHARLES MEDICAL CENTER': [44.0641, -121.2832],
    'SCMC BEND': [44.0641, -121.2832],
    'SCMC': [44.0641, -121.2832],
    '2500 NE NEFF RD': [44.0641, -121.2832],
    '2500 NE NEFF RD BEND': [44.0641, -121.2832],
    '2500 NE NEFF RD, BEND': [44.0641, -121.2832],
    '2500 NE NEFF RD BEND OR': [44.0641, -121.2832],
    'ST CHARLES REDMOND': [44.2704, -121.1417],
    'SAINT CHARLES REDMOND': [44.2704, -121.1417],
    'SCMC REDMOND': [44.2704, -121.1417],
    '1253 N CANAL BLVD': [44.2704, -121.1417],
    '1253 N CANAL BLVD REDMOND': [44.2704, -121.1417],
    '1253 N CANAL BLVD, REDMOND': [44.2704, -121.1417],
    'ST CHARLES PRINEVILLE': [44.2997, -120.8367],
    'SAINT CHARLES PRINEVILLE': [44.2997, -120.8367],
    'SCMC PRINEVILLE': [44.2997, -120.8367],
    '384 SE COMBS FLAT RD': [44.2997, -120.8367],
    '384 SE COMBS FLAT RD PRINEVILLE': [44.2997, -120.8367],
    'ST CHARLES MADRAS': [44.6329, -121.1298],
    'SAINT CHARLES MADRAS': [44.6329, -121.1298],
    'SCMC MADRAS': [44.6329, -121.1298],
    '470 NE A ST': [44.6329, -121.1298],
    '470 NE A ST MADRAS': [44.6329, -121.1298],
    'WARM SPRINGS IHS': [44.7636, -121.2733],
    'WARM SPRINGS HEALTH CENTER': [44.7636, -121.2733],
    'SKY LAKES MEDICAL CENTER': [42.2530, -121.7851],
    'ROBERTS FIELD': [44.2542, -121.1486],
    'REDMOND MUNICIPAL AIRPORT': [44.2542, -121.1486],
    'BEND MUNICIPAL AIRPORT': [44.0946, -121.2002],
    'PRINEVILLE AIRPORT': [44.2878, -120.9055],
    'MADRAS MUNICIPAL AIRPORT': [44.6702, -121.1552],
    'DESCHUTES FAIRGROUNDS': [44.2665, -121.1775],
    'JEFFERSON COUNTY FAIRGROUNDS': [44.6196, -121.1380],
    'CROOK COUNTY FAIRGROUNDS': [44.2893, -120.8422],
  };

  function _loadLeaflet(cb) {
    if (window.L) { cb(); return; }
    var css = document.createElement('link');
    css.rel = 'stylesheet';
    css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(css);
    var s = document.createElement('script');
    s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    s.onload = cb;
    document.head.appendChild(s);
  }

  function openFieldMap() {
    var overlay = document.getElementById('fieldMapOverlay');
    if (!overlay) return;
    overlay.style.display = 'flex';
    if (!_fieldMapHistPushed) {
      _fieldMapHistPushed = true;
      history.pushState({ fieldModal: 'map' }, '');
    }
    _loadLeaflet(function() { _renderFieldMap(); });
  }

  function closeFieldMap() {
    var overlay = document.getElementById('fieldMapOverlay');
    if (overlay) overlay.style.display = 'none';
    var wasNav = _fieldMapHistPushed;
    _fieldMapHistPushed = false;
    if (wasNav) history.back();
  }

  function openFieldMapNav() {
    if (_fmapNavUrl) window.open(_fmapNavUrl, '_blank');
  }

  // GPS — show current position on field map (local only, no board update)
  function fieldGpsView() {
    if (!navigator.geolocation) { feedSys('GPS NOT AVAILABLE ON THIS DEVICE.'); return; }
    feedSys('GPS: LOCATING...');
    navigator.geolocation.getCurrentPosition(function(pos) {
      var lat = pos.coords.latitude, lon = pos.coords.longitude;
      var acc = Math.round(pos.coords.accuracy);
      _fieldGpsPos = [lat, lon]; // persist for re-renders
      openFieldMap();
      _loadLeaflet(function() {
        _renderFieldMap(); // re-render will include YOU ARE HERE dot via _fieldGpsPos
        setTimeout(function() {
          if (!_fieldMapObj) return;
          _fieldMapObj.setView([lat, lon], 15);
          var stat = document.getElementById('fmapStatus');
          if (stat) stat.textContent = 'YOU ARE HERE: ' + lat.toFixed(5) + ', ' + lon.toFixed(5) + ' (\xb1' + acc + 'm)';
        }, 200);
      });
      feedSys('GPS: ' + lat.toFixed(5) + ', ' + lon.toFixed(5) + ' (\xb1' + acc + 'm acc)');
    }, function(e) {
      feedSys('GPS ERROR: ' + (e.code === 1 ? 'PERMISSION DENIED.' : 'NOT AVAILABLE.'));
    }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 10000 });
  }

  // GPSUL — GPS Update Location: reverse-geocodes coords to address, sends to board as [LOC:addr]
  // silent=true suppresses feed messages (used by auto-GPS interval — avoids spamming crew every 60s)
  function fieldGpsUpdateLocation(silent) {
    if (!navigator.geolocation) { if (!silent) feedSys('GPS NOT AVAILABLE ON THIS DEVICE.'); return; }
    if (!silent) feedSys('GPS: LOCATING FOR BOARD UPDATE...');
    navigator.geolocation.getCurrentPosition(function(pos) {
      var lat = pos.coords.latitude.toFixed(5);
      var lon = pos.coords.longitude.toFixed(5);
      var acc = Math.round(pos.coords.accuracy);
      var coordStr = lat + ',' + lon;
      _fieldGpsPos = [parseFloat(lat), parseFloat(lon)]; // persist for map dot

      // Track accuracy trend for adaptive interval
      if (silent) {
        if (acc > 200) { _gpsAutoStaleCount++; } else { _gpsAutoStaleCount = 0; }
        // Skip board update if consecutive poor readings (>500m) — avoids spamming stale network-location
        if (acc > 500 && _gpsLastAutoAccuracy > 500) {
          _gpsLastAutoAccuracy = acc;
          return;
        }
        _gpsLastAutoAccuracy = acc;
      }

      function sendToBoard(locTag) {
        var myU = _mergedUnits[(_cadCallsign || '').toUpperCase()] || null;
        var note = (myU && myU.note) ? myU.note : '';
        note = note.replace(/\[LOC:[^\]]*\]/gi, '').replace(/\s{2,}/g, ' ').trim();
        note = ('[LOC:' + locTag + '] ' + note).trim();
        API.upsertUnit(_cadToken, _cadCallsign, { note: note }).then(function(r) {
          if (!silent) {
            if (r && r.ok !== false) {
              feedSys('GPS SENT TO BOARD: ' + locTag + ' (\xb1' + acc + 'm)');
              if (acc > 500) feedSys('WARNING: GPS ACCURACY POOR (' + acc + 'm) — MAY BE NETWORK LOCATION.');
            } else {
              feedSys('GPS UPDATE FAILED: ' + (r && r.error ? r.error : 'CHECK CONNECTION'));
            }
          }
        }).catch(function() { if (!silent) feedSys('GPS UPDATE ERROR — CHECK CONNECTION.'); });
      }

      // Reverse geocode coords → nearest address (5s timeout, fall back to raw coords)
      if (!silent) feedSys('GPS: RESOLVING ADDRESS...');
      var geoTimer = setTimeout(function() { sendToBoard(coordStr); }, 5000);
      fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          clearTimeout(geoTimer);
          var addr = '';
          if (data && data.address) {
            var a = data.address;
            var num  = a.house_number || '';
            var road = a.road || a.pedestrian || a.path || '';
            var city = a.city || a.town || a.village || a.hamlet || '';
            if (num && road) addr = num + ' ' + road;
            else if (road)   addr = road;
            if (city) addr = addr ? addr + ', ' + city : city;
            addr = addr.toUpperCase().trim();
          }
          sendToBoard(addr || coordStr);
        })
        .catch(function() { clearTimeout(geoTimer); sendToBoard(coordStr); });

    }, function(e) {
      if (!silent) feedSys('GPS ERROR: ' + (e.code === 1 ? 'PERMISSION DENIED.' : e.code === 2 ? 'POSITION UNAVAILABLE.' : 'TIMEOUT.'));
    }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
  }

  // GPS AUTO — sends location to board every 60s (120s when accuracy is poor)
  const GPS_AUTO_INTERVAL_MS = 60000;
  const GPS_STALE_INTERVAL_MS = 120000;
  var _gpsLastAutoAccuracy = 0;
  var _gpsAutoStaleCount = 0;

  function startGpsAuto() {
    stopGpsAuto();
    if (!navigator.geolocation || !_cadToken) return;
    var badge = document.getElementById('gpsAutoBadge');
    if (badge) badge.style.display = '';
    _gpsAutoStaleCount = 0;
    _gpsLastAutoAccuracy = 0;
    // Send immediately on login, then schedule adaptively
    fieldGpsUpdateLocation(true);
    _scheduleNextGpsAuto();
  }

  function _scheduleNextGpsAuto() {
    if (_gpsAutoInterval) clearTimeout(_gpsAutoInterval);
    if (!_cadToken) return;
    var delay = (_gpsAutoStaleCount >= 2) ? GPS_STALE_INTERVAL_MS : GPS_AUTO_INTERVAL_MS;
    _gpsAutoInterval = setTimeout(function() {
      if (!_cadToken) { stopGpsAuto(); return; }
      fieldGpsUpdateLocation(true);
      _scheduleNextGpsAuto();
    }, delay);
  }

  function stopGpsAuto() {
    if (_gpsAutoInterval) { clearTimeout(_gpsAutoInterval); _gpsAutoInterval = null; }
    var badge = document.getElementById('gpsAutoBadge');
    if (badge) badge.style.display = 'none';
  }

  function _renderFieldMap() {
    var el = document.getElementById('fieldMapEl');
    var stat = document.getElementById('fmapStatus');
    var incLabel = document.getElementById('fmapIncLabel');
    var navBtn = document.getElementById('fmapNavBtn');
    if (!el) return;

    var center = [44.058, -121.315];
    var curIncId = _currentIncident || '';
    var incs  = (_lastState && _lastState.incidents) || [];
    var units = (_lastState && _lastState.units)     || [];

    var curInc = curIncId ? incs.find(function(i) { return i.incident_id === curIncId; }) : null;
    if (incLabel) incLabel.textContent = curInc ? ('INC' + String(curIncId).replace(/^[A-Z]*\d{2}-0*/, '')) : '';

    // Init or reuse map — remove previously tracked layers
    if (!_fieldMapObj) {
      _fieldMapObj = L.map(el, { zoomControl: true, attributionControl: false });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(_fieldMapObj);
    } else {
      _fieldMapLayers.forEach(function(ly) { try { _fieldMapObj.removeLayer(ly); } catch(e) {} });
      _fieldMapLayers = [];
    }
    setTimeout(function() { _fieldMapObj.invalidateSize(); }, 120);

    // Helper: add and track a layer
    function addLayer(ly) { ly.addTo(_fieldMapObj); _fieldMapLayers.push(ly); return ly; }

    var bounds = [];

    // --- Unit markers: ALL active units with any known position ---
    var activeUnits = units.filter(function(u) { return u.active; });
    activeUnits.forEach(function(u) {
      var pos = null;
      // Priority 1: [LOC:lat,lon] coordinate tag in note
      var locMatch = (u.note || '').match(/\[LOC:(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\]/i);
      if (locMatch) { pos = [parseFloat(locMatch[1]), parseFloat(locMatch[2])]; }
      // Priority 2: agency area coords
      if (!pos) { pos = _SUGGEST_AGENCY_COORDS_FIELD[String(u.agency_id || '').toUpperCase()] || null; }
      if (!pos) return;
      var isSelf = (u.unit_id === _cadCallsign);
      addLayer(L.circleMarker(pos, {
        radius: isSelf ? 10 : 7,
        color: isSelf ? '#5ba3e6' : '#ffd66b',
        fillColor: isSelf ? '#1a3a5c' : '#3a2800',
        fillOpacity: 0.85, weight: 2
      }).bindPopup('<b>' + esc(u.unit_id) + '</b><br>' + esc(u.status || '') +
        (u.incident ? '<br>INC: ' + esc(String(u.incident).replace(/^[A-Z]*\d{2}-0*/, '')) : '')));
      bounds.push(pos);
    });

    // --- Incident markers: ALL active + queued incidents ---
    _fmapNavUrl = null;
    if (navBtn) navBtn.style.display = 'none';
    var geoQueue = [];

    var activeIncs = incs.filter(function(i) {
      return i.status === 'ACTIVE' || i.status === 'QUEUED' || i.status === 'IQ';
    });

    activeIncs.forEach(function(inc) {
      if (!inc.scene_address) return;
      var addr = inc.scene_address.trim();
      var isCur = (inc.incident_id === curIncId);
      if (isCur) {
        _fmapNavUrl = 'https://maps.google.com/?q=' + encodeURIComponent(addr);
        if (navBtn) navBtn.style.display = '';
      }
      var color = isCur ? '#ff4444' : '#ff9900';
      var fillColor = isCur ? '#8b0000' : '#7a4300';
      var label = (isCur ? '<b>SCENE</b>' : '<b>INC ' + esc(String(inc.incident_id).replace(/^[A-Z]*\d{2}-0*/, '')) + '</b>') + '<br>' + esc(addr);

      var normAddr = addr.toUpperCase().trim();
      if (_FIELD_KNOWN_COORDS[normAddr]) {
        var kc = _FIELD_KNOWN_COORDS[normAddr];
        var mk = addLayer(L.circleMarker(kc, {
          radius: 12, color: color, fillColor: fillColor, fillOpacity: 0.9, weight: 3
        }).bindPopup(label));
        if (isCur) mk.openPopup();
        bounds.push(kc);
      } else {
        geoQueue.push({ inc: inc, addr: addr, isCur: isCur, color: color, fillColor: fillColor, label: label });
      }
    });

    // --- "You Are Here" GPS dot (from fieldGpsView / fieldGpsUpdateLocation) ---
    if (_fieldGpsPos) {
      addLayer(L.circleMarker(_fieldGpsPos, {
        radius: 10, color: '#00e5ff', fillColor: '#001a2e', fillOpacity: 0.9, weight: 3,
        dashArray: '4 2'
      }).bindPopup('<b>YOU ARE HERE</b>'));
      bounds.push(_fieldGpsPos);
    }

    // Fit map to all known positions
    if (bounds.length > 1) { _fieldMapObj.fitBounds(bounds, { padding: [30, 30] }); }
    else if (bounds.length === 1) { _fieldMapObj.setView(bounds[0], curInc ? 14 : 12); }
    else { _fieldMapObj.setView(center, 12); }

    // Status bar
    var mappedUnitCount = activeUnits.filter(function(u) {
      return (u.note || '').match(/\[LOC:(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\]/i) ||
             _SUGGEST_AGENCY_COORDS_FIELD[String(u.agency_id || '').toUpperCase()];
    }).length;
    var statBase = (curInc && curInc.scene_address ? 'SCENE: ' + curInc.scene_address.trim() + ' | ' : '') +
                   (mappedUnitCount ? 'UNITS: ' + mappedUnitCount : 'NO UNITS WITH KNOWN POSITION');
    if (stat) stat.textContent = statBase;

    // Geocode queued incidents asynchronously (Nominatim rate limit: 1/1.5s)
    if (geoQueue.length) {
      var idx = 0;
      function _geoNext() {
        if (idx >= geoQueue.length || !_fieldMapObj) return;
        var item = geoQueue[idx++];
        var q = item.addr.replace(/\bNE\b/g,'NORTHEAST').replace(/\bNW\b/g,'NORTHWEST')
                         .replace(/\bSE\b/g,'SOUTHEAST').replace(/\bSW\b/g,'SOUTHWEST');
        if (!/\bOR\b|\boregon\b/i.test(q)) q += ', Oregon';
        fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data && data[0] && _fieldMapObj) {
              var lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);
              var mk = addLayer(L.circleMarker([lat, lon], {
                radius: 12, color: item.color, fillColor: item.fillColor, fillOpacity: 0.9, weight: 3
              }).bindPopup(item.label));
              if (item.isCur) mk.openPopup();
              bounds.push([lat, lon]);
              if (bounds.length > 1) _fieldMapObj.fitBounds(bounds, { padding: [30, 30] });
              else _fieldMapObj.setView([lat, lon], 14);
            }
            setTimeout(_geoNext, 1500);
          })
          .catch(function(e) { console.warn('[FMAP] geocode error', item.addr, e); setTimeout(_geoNext, 1500); });
      }
      _geoNext();
    }
  }

  // Agency coords reused from board SUGGEST_AGENCY_COORDS (field copy)
  var _SUGGEST_AGENCY_COORDS_FIELD = {
    'LAPINE_FD':            [43.6679, -121.5036],
    'SUNRIVER_FD':          [43.8758, -121.4363],
    'BEND_FIRE':            [44.0489, -121.3153],
    'REDMOND_FIRE':         [44.2783, -121.1785],
    'CROOK_COUNTY_FIRE':    [44.3050, -120.7271],
    'SISTERS_CAMP_SHERMAN': [44.2879, -121.5490],
    'AIRLINK_CCT':          [44.0613, -121.2832],
    'JEFFCO_FIRE_EMS':      [44.6289, -121.1278],
    'WARM_SPRINGS_FD':      [44.7640, -121.2660],
    'SCMC':                 [44.0613, -121.2832],
    'ADVENTURE_MEDICS':     [44.1024, -121.2799],
    'ALFALFA_FPD':          [44.0084, -121.1091],
    'CLOVERDALE_FPD':       [44.2225, -121.4090],
    'BLACK_BUTTE_RANCH':    [44.3988, -121.6282],
    'CRESCENT_FD':          [43.4644, -121.7168],
  };

  window.openFieldMap            = openFieldMap;
  window.closeFieldMap           = closeFieldMap;
  window.openFieldMapNav         = openFieldMapNav;
  window.fieldGpsView            = fieldGpsView;
  window.fieldGpsUpdateLocation  = fieldGpsUpdateLocation;
  window.openFieldIncHist        = openFieldIncHist;
  window.closeFieldIncHist       = closeFieldIncHist;

  // ── Field Incident History ───────────────────────────────
  function _incElapsed(t1, t2) {
    if (!t1 || !t2) return null;
    const mins = Math.round((new Date(t2) - new Date(t1)) / 60000);
    return mins >= 60 ? Math.floor(mins / 60) + 'H' + (mins % 60 ? ' ' + (mins % 60) + 'M' : '') : mins + 'M';
  }

  async function openFieldIncHist() {
    if (!_cadToken || !_cadCallsign) return;
    var overlay = document.getElementById('fieldIncHistOverlay');
    if (!overlay) return;
    overlay.style.display = 'flex';
    if (!_fieldIncHistPushed) {
      _fieldIncHistPushed = true;
      history.pushState({ fieldModal: 'incHist' }, '');
    }
    var content = document.getElementById('fieldIncHistContent');
    content.innerHTML = '<div style="color:#8b949e;text-align:center;padding:24px;font-size:12px;">LOADING...</div>';

    var r = await API.getUnitIncidents(_cadToken, _cadCallsign, 20);
    if (!r.ok) {
      content.innerHTML = '<div style="color:#e04040;padding:12px;font-size:12px;">ERROR: ' + esc(r.error || 'FAILED') + '</div>';
      return;
    }
    var incs = r.incidents || [];
    if (!incs.length) {
      content.innerHTML = '<div style="color:#8b949e;text-align:center;padding:24px;font-size:12px;">NO INCIDENT HISTORY FOUND.</div>';
      return;
    }

    var html = incs.map(function(inc) {
      var shortId = String(inc.incident_id).replace(/^[A-Z]*\d{2}-0*/, '');
      var status = inc.status || '';
      var statusColor = status === 'CLOSED' ? '#8b949e' : status === 'ACTIVE' ? '#4caf50' : '#e8c030';
      var incType = (inc.incident_type || '—').toUpperCase();
      var scene = inc.scene_address || '—';
      var cleanNote = (inc.incident_note || '').replace(/\[[^\]]*\]/g, '').replace(/\s{2,}/g, ' ').trim();
      var responseStr = _incElapsed(inc.dispatch_time, inc.arrival_time);
      var totalStr = _incElapsed(inc.dispatch_time, inc.handoff_time);
      var priColor = inc.priority === 'PRI-1' || inc.priority === 'CRITICAL' ? '#ff4040' : '#8b949e';
      var safeId = esc(inc.incident_id).replace(/'/g, '&#39;');
      return '<div style="border:1px solid #1f2b3d;border-radius:4px;padding:10px;margin-bottom:8px;background:rgba(255,255,255,.02);">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">' +
          '<span style="font-size:13px;font-weight:900;color:#e6edf3;">INC' + esc(shortId) + '</span>' +
          '<div style="display:flex;gap:6px;align-items:center;">' +
            '<span style="font-size:10px;font-weight:700;color:' + statusColor + ';">' + esc(status) + '</span>' +
            '<button onclick="openFieldIncNote(\'' + safeId + '\')" style="font-size:10px;font-weight:700;padding:2px 8px;min-height:28px;background:#0f1e33;border:1px solid #2f5a8a;color:#5ba3e6;font-family:inherit;cursor:pointer;border-radius:2px;letter-spacing:.04em;">+ NOTE</button>' +
          '</div>' +
        '</div>' +
        '<div style="font-size:11px;color:#c8d0da;margin-bottom:2px;">' + esc(incType) +
          (inc.priority ? ' <span style="color:' + priColor + ';font-weight:700;">' + esc(inc.priority) + '</span>' : '') +
        '</div>' +
        '<div style="font-size:11px;color:#8b949e;margin-bottom:2px;">' + esc(scene) + '</div>' +
        (cleanNote ? '<div style="font-size:10px;color:#6b7380;margin-bottom:4px;">' + esc(cleanNote) + '</div>' : '') +
        '<div style="display:flex;gap:12px;font-size:10px;color:#8b949e;margin-top:4px;">' +
          (responseStr ? '<span>RESP: ' + responseStr + '</span>' : '') +
          (totalStr ? '<span>TOTAL: ' + totalStr + '</span>' : '') +
          '<span style="color:' + (inc.is_primary ? '#4caf50' : '#6b7380') + ';">' + (inc.is_primary ? 'PRIMARY' : 'SECONDARY') + '</span>' +
        '</div>' +
        '</div>';
    }).join('');
    content.innerHTML = html;
  }

  var _fieldNoteTarget = null;

  function openFieldIncNote(incidentId) {
    _fieldNoteTarget = incidentId;
    var modal = document.getElementById('fieldIncNoteModal');
    if (!modal) return;
    var shortId = String(incidentId).replace(/^[A-Z]*\d{2}-0*/, '');
    document.getElementById('finmTitle').textContent = 'ADD NOTE — INC' + shortId;
    document.getElementById('finmText').value = '';
    document.getElementById('finmStatus').textContent = '';
    modal.style.display = 'flex';
    setTimeout(function() { document.getElementById('finmText').focus(); }, 80);
  }

  function closeFieldIncNote() {
    var modal = document.getElementById('fieldIncNoteModal');
    if (modal) modal.style.display = 'none';
    _fieldNoteTarget = null;
  }

  async function submitFieldIncNote() {
    var note = (document.getElementById('finmText').value || '').trim().toUpperCase();
    var stat = document.getElementById('finmStatus');
    if (!note) { stat.textContent = 'NOTE REQUIRED.'; return; }
    if (!_fieldNoteTarget) { stat.textContent = 'NO INCIDENT SELECTED.'; return; }
    stat.textContent = 'SAVING...';
    var r = await API.appendIncidentNote(_cadToken, _fieldNoteTarget, note);
    if (!r.ok) { stat.textContent = 'ERROR: ' + (r.error || 'FAILED.'); return; }
    closeFieldIncNote();
    feedSys('NOTE ADDED TO INC' + String(_fieldNoteTarget).replace(/^[A-Z]*\d{2}-0*/, '') + '.');
  }
  window.openFieldIncNote   = openFieldIncNote;
  window.closeFieldIncNote  = closeFieldIncNote;
  window.submitFieldIncNote = submitFieldIncNote;

  function closeFieldIncHist() {
    var overlay = document.getElementById('fieldIncHistOverlay');
    if (overlay) overlay.style.display = 'none';
    if (_fieldIncHistPushed) { _fieldIncHistPushed = false; history.back(); }
  }

  // ── Bug Report (field) ──────────────────────────────────
  let _fieldBugContext = null;

  function openFieldBugReport() {
    const modal = document.getElementById('fieldBugModal');
    if (!modal) return;
    document.getElementById('fbReporterLabel').textContent = _cadCallsign || '—';
    const now = new Date();
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('fbTimeLabel').textContent =
      (now.getMonth() + 1) + '/' + now.getDate() + ' ' + hh + ':' + mm;
    document.getElementById('fbDescription').value = '';
    document.getElementById('fbSeverity').value = 'MED';
    document.getElementById('fbStatus').textContent = '';

    // Auto-capture context snapshot
    _fieldBugContext = {
      callsign:    _cadCallsign || '',
      status:      _currentStatus || '',
      incident:    _currentIncident || null,
      destination: _currentDestination || null,
      lastActions: _fieldActionLog.slice(-6),
      online:      _isOnline,
      ua:          navigator.userAgent.substring(0, 120),
      vp:          window.innerWidth + 'x' + window.innerHeight,
      ts:          now.toISOString(),
    };

    const ctxEl = document.getElementById('fbContextPreview');
    if (ctxEl) {
      ctxEl.textContent = [
        'UNIT: '    + (_cadCallsign || 'none'),
        'STATUS: '  + (_currentStatus || '?'),
        'INC: '     + (_currentIncident || 'none'),
        'ACTIONS: ' + (_fieldActionLog.slice(-4).join(' → ') || 'none'),
        'ONLINE: '  + (_isOnline ? 'yes' : 'NO'),
      ].join('\n');
    }

    modal.style.display = 'flex';
  }

  function closeFieldBugReport() {
    const modal = document.getElementById('fieldBugModal');
    if (modal) modal.style.display = 'none';
    _fieldBugContext = null;
  }

  async function submitFieldBugReport() {
    const sev  = document.getElementById('fbSeverity').value;
    const desc = (document.getElementById('fbDescription').value || '').trim().toUpperCase();
    const stat = document.getElementById('fbStatus');
    if (!desc) { stat.textContent = 'DESCRIPTION REQUIRED.'; return; }
    if (!_cadToken) { stat.textContent = 'NOT LOGGED IN.'; return; }
    stat.textContent = 'SUBMITTING...';
    const ctx = _fieldBugContext ? JSON.stringify(_fieldBugContext) : '';
    try {
      const r = await API.submitIssue(_cadToken, 'FIELD', sev, desc, ctx);
      if (!r.ok) { stat.textContent = 'ERROR: ' + (r.error || 'UNKNOWN'); return; }
      _fieldBugContext = null;
      closeFieldBugReport();
      feedSys('ISSUE REPORT SUBMITTED. THANK YOU.');
    } catch (e) {
      stat.textContent = 'NETWORK ERROR.';
    }
  }

  window.openFieldBugReport  = openFieldBugReport;
  window.closeFieldBugReport = closeFieldBugReport;
  window.submitFieldBugReport = submitFieldBugReport;
  window.appendFieldNote = appendFieldNote;

  function appendFieldNote(text) {
    const ta = document.getElementById('idmNoteInput');
    if (!ta) return;
    const cur = ta.value.trim();
    ta.value = cur ? cur + '. ' + text : text;
    ta.focus();
    ta.setSelectionRange(ta.value.length, ta.value.length);
  }

  async function saveFieldIncNote() {
    if (!_currentIncident || !_cadToken) return;
    const note = (document.getElementById('idmNoteInput').value || '').trim();
    if (!note) { feedErr('NOTE CANNOT BE EMPTY.'); closeIncDetail(); return; }
    const btn = document.getElementById('idmSaveBtn');
    btn.disabled = true;
    btn.textContent = 'SAVING...';
    const r = await API.appendIncidentNote(_cadToken, _currentIncident, note);
    btn.disabled = false;
    btn.textContent = 'SAVE NOTE';
    if (!r || !r.ok) {
      feedErr('SAVE FAILED: ' + (r && r.error || 'UNKNOWN ERROR'));
      return;
    }
    feedSys('[NOTE ADDED] ' + note);
    closeIncDetail();
  }

  // Expose functions needed by inline onclick handlers (Change 1, 5, 6)
  window.openNavScene = openNavScene;
  window.openNavDest = openNavDest;
  window.openNavNextCall = openNavNextCall;
  window.fieldHandoff = fieldHandoff;
  window.toggleCmdArea = toggleCmdArea;
  window.toggleWakeLock = toggleWakeLock;
  window.selectTransportQuick = selectTransportQuick;
  window.openIncDetail = openIncDetail;
  window.closeIncDetail = closeIncDetail;
  window.saveFieldIncNote = saveFieldIncNote;
  window.ackNextCall = ackNextCall; // Phase 2E
  window.openCallDetail = openCallDetail;
  window.closeCallDetail = closeCallDetail;
  window.handleSelfAssign = handleSelfAssign;
  window.cadLogout = cadLogout;
  window.ackDispatch = ackDispatch;
  window.toggleNightMode = toggleNightMode;
  window.showInfoOverlay = showInfoOverlay;
  window.closeInfoOverlay = closeInfoOverlay;
  window.feedSys = feedSys;
  window.pollOnce = pollOnce;

  // PWA back-navigation: close open modals/overlays when hardware back is pressed
  // (Android back button / iOS swipe-back in standalone PWA mode)
  window.addEventListener('popstate', function() {
    // IMPORTANT: Clear the history flag BEFORE calling the close function.
    // The close functions call history.back() only when their flag is true.
    // Clearing first prevents the double-back loop:
    //   popstate → closeModal → history.back() → popstate → closeModal (loop)
    // Transport overlay takes priority (higher z-index)
    const transport = document.getElementById('transportOverlay');
    if (transport && transport.style.display !== 'none') {
      _transportHistoryPushed = false; // clear BEFORE _resolveTransport to prevent double back
      _resolveTransport(null);
      return;
    }
    // Field map overlay
    const fmap = document.getElementById('fieldMapOverlay');
    if (fmap && fmap.style.display !== 'none') {
      _fieldMapHistPushed = false; // clear BEFORE closeFieldMap to prevent double back
      closeFieldMap();
      return;
    }
    // Field incident history overlay
    const fih = document.getElementById('fieldIncHistOverlay');
    if (fih && fih.style.display !== 'none') {
      _fieldIncHistPushed = false;
      closeFieldIncHist();
      return;
    }
    // Incident detail modal
    const modal = document.getElementById('incDetailModal');
    if (modal && modal.style.display !== 'none') {
      _incDetailHistoryPushed = false; // clear BEFORE closeIncDetail to prevent double back
      closeIncDetail();
      return;
    }
  });

  // Auto night mode check hourly
  setInterval(function() {
    if (_nightOverride === null) checkNightMode();
  }, 3600000);

  // ════════════════════════════════════════════════════════════════════════════
  // AUTO-RECONNECT ON LOAD
  // ════════════════════════════════════════════════════════════════════════════
  window.addEventListener('load', async function() {
    // Service worker
    if ('serviceWorker' in navigator && !window.desktopAPI) {
      navigator.serviceWorker.register('../sw-field.js', { scope: '/field/', updateViaCache: 'none' })
        .then(function(reg) {
          setInterval(function() { reg.update(); }, 5 * 60 * 1000);
          reg.addEventListener('updatefound', function() {
            var newSW = reg.installing;
            if (newSW) {
              newSW.addEventListener('statechange', function() {
                if (newSW.state === 'activated' && navigator.serviceWorker.controller) {
                  window.location.reload();
                }
              });
            }
          });
        }).catch(function() {});
    }

    loadNightOverride();
    checkNightMode();
    restoreCmdCollapsed(); // Change 6
    loadOfflineQueue();

    loadSession();
    if (_cadToken && _cadCallsign) {
      // M-3: Prompt on shared devices — confirm resume or logout at shift handoff
      const resumeConfirmed = await showConfirm(
        'RESUME SESSION',
        'RESUME SESSION AS ' + _cadCallsign + '?\n\nSELECT RESUME TO RECONNECT OR LOGOUT TO START FRESH.',
        'RESUME',
        'LOGOUT'
      );
      if (!resumeConfirmed) {
        clearSession();
        showLogin();
        return;
      }

      showField(_cadCallsign);
      feedSys('RECONNECTING AS ' + _cadCallsign + '...');

      try {
        const state = await API.getState(_cadToken);
        if (state.ok) {
          _lastState = state;
          _mergeState(state);      // build merged caches from full reconnect state
          _pendingStatus = null;   // clear any stale pending on reconnect
          _unreadMessages = 0;
          updateMsgBadge();
          updateBanners(state);
          const myUnit = _mergedUnits[_cadCallsign.toUpperCase()] || null;
          if (myUnit) {
            updateStatusBadge(myUnit.status || 'AV');
            updateIncidentPanel(myUnit, _lastState);
            updateFieldLocation(myUnit, _lastState);
          }
          startPolling();
          loadAddresses();
          setOnline(true);
          flushOfflineQueue();
          feedSys('RECONNECTED AS ' + _cadCallsign + '. HOSCAD FIELD ACTIVE.');
        } else {
          feedSys('SESSION EXPIRED. RE-AUTHENTICATING...');
          const cadErr = await cadLogin(_cadCallsign, _cadUnitInfo);
          if (cadErr) {
            feedErr('RECONNECT FAILED: ' + cadErr);
            showLogin();
          } else {
            feedSys('RECONNECTED AS ' + _cadCallsign + '.');
          }
        }
      } catch(e) {
        setOnline(false);
        const cached = loadCachedCallInfo();
        if (cached && cached.incident) {
          // Show cached incident info
          const panel = document.getElementById('incidentPanel');
          panel.classList.remove('no-incident');
          panel.classList.add('has-incident');
          document.getElementById('noIncidentView').style.display = 'none';
          document.getElementById('hasIncidentView').style.display = '';
          document.getElementById('incNumber').textContent = 'INC ' + cached.incident;
          document.getElementById('incNature').textContent = cached.nature || '';
          document.getElementById('incAddress').textContent = cached.address || '--';
          document.getElementById('incNotes').textContent = cached.note || '';
          document.getElementById('incNotesContainer').style.display = cached.note ? '' : 'none';
          feedSys('OFFLINE — SHOWING CACHED CALL INFO');
        }
        startPolling();
        feedErr('OFFLINE. WILL RETRY AUTOMATICALLY.');
      }
    }
  });
})();
</script>

<!-- PIN Change Dialog -->
<div id="pinChangeDialog" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9000;align-items:center;justify-content:center;">
  <div style="background:var(--panel);border:1px solid var(--line);border-radius:4px;padding:20px;width:300px;max-width:90vw;">
    <div style="font-size:13px;font-weight:700;margin-bottom:12px;letter-spacing:.06em;">CHANGE PIN</div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:10px;" id="pinChangeCadLabel">ENTER YOUR CAD ID AND CURRENT PIN TO VERIFY.</div>
    <input id="pinChangeCadId" type="text" inputmode="numeric" placeholder="YOUR CAD ID" maxlength="6" autocomplete="off"
      style="width:100%;box-sizing:border-box;margin-bottom:8px;padding:8px;background:#0b1018;border:2px solid var(--line);color:var(--text);font-family:inherit;font-size:13px;" />
    <input id="pinChangeCurrent" type="password" inputmode="numeric" placeholder="CURRENT PIN" maxlength="6" autocomplete="off"
      style="width:100%;box-sizing:border-box;margin-bottom:8px;padding:8px;background:#0b1018;border:2px solid var(--line);color:var(--text);font-family:inherit;font-size:13px;" />
    <input id="pinChangeNew" type="password" inputmode="numeric" placeholder="NEW PIN (4-6 DIGITS)" maxlength="6" autocomplete="off"
      style="width:100%;box-sizing:border-box;margin-bottom:8px;padding:8px;background:#0b1018;border:2px solid var(--line);color:var(--text);font-family:inherit;font-size:13px;" />
    <input id="pinChangeConfirm" type="password" inputmode="numeric" placeholder="CONFIRM NEW PIN" maxlength="6" autocomplete="off"
      style="width:100%;box-sizing:border-box;margin-bottom:12px;padding:8px;background:#0b1018;border:2px solid var(--line);color:var(--text);font-family:inherit;font-size:13px;" />
    <div id="pinChangeErr" style="font-size:11px;color:#e05050;min-height:16px;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <button onclick="closePinChangeDialog()" style="padding:6px 14px;background:transparent;border:2px solid var(--line);color:var(--muted);font-family:inherit;font-size:12px;cursor:pointer;">CANCEL</button>
      <button id="btnPinChangeSave" onclick="savePinChange()" style="padding:6px 14px;background:#1a2535;border:2px solid #2f6cff;color:var(--text);font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;">SAVE</button>
    </div>
  </div>
</div>
</body>
</html>
